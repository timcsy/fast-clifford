"""
CGA3D Cl(4,1) Functional Operations - Auto-generated

DO NOT EDIT MANUALLY - This file is generated by codegen/generate.py

Generated: 2025-12-09 02:13:39
Algebra: cga3d
Signature: (1, 1, 1, 1, -1)
Blade count: 32

All functions are:
- Loop-free (fully expanded arithmetic)
- ONNX-compatible (only Add/Mul/Neg/Sub operations)
- Hard-coded (no Cayley table lookups)
"""

import torch
from torch import Tensor
from typing import Tuple


# =============================================================================
# Constants
# =============================================================================

BLADE_COUNT = 32
EUCLIDEAN_DIM = 3

# Blade indices by grade
GRADE_0_INDICES = (0,)
GRADE_1_INDICES = (1, 2, 3, 4, 5)
GRADE_2_INDICES = (6, 7, 8, 9, 10, 11, 12, 13, 14, 15)
GRADE_3_INDICES = (16, 17, 18, 19, 20, 21, 22, 23, 24, 25)
GRADE_4_INDICES = (26, 27, 28, 29, 30)
GRADE_5_INDICES = (31,)

# Sparsity masks
UPGC_POINT_MASK = (1, 2, 3, 4, 5)  # 5 components
EVEN_VERSOR_MASK = (0, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 26, 27, 28, 29, 30)  # 16 components

# Reverse signs for all 32 blades
REVERSE_SIGNS = (1, 1, 1, 1, 1, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 1, 1, 1, 1, 1, 1)

# EvenVersor-specific reverse signs (16 components)
EVEN_VERSOR_REVERSE_SIGNS = (1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 1, 1, 1, 1, 1)

# =============================================================================
# Geometric Product (Full 32x32)
# =============================================================================

@torch.jit.script
def geometric_product_full(a: Tensor, b: Tensor) -> Tensor:
    """
    Compute the full geometric product of two multivectors.

    Args:
        a: Left operand, shape (..., 32)
        b: Right operand, shape (..., 32)

    Returns:
        Result multivector, shape (..., 32)

    Note:
        Fully expanded, no loops, ONNX compatible.
    """
    r0 = (
        a[..., 0] * b[..., 0] +
        a[..., 1] * b[..., 1] +
        a[..., 2] * b[..., 2] +
        a[..., 3] * b[..., 3] +
        a[..., 4] * b[..., 4] +
        -a[..., 5] * b[..., 5] +
        -a[..., 6] * b[..., 6] +
        -a[..., 7] * b[..., 7] +
        -a[..., 8] * b[..., 8] +
        a[..., 9] * b[..., 9] +
        -a[..., 10] * b[..., 10] +
        -a[..., 11] * b[..., 11] +
        a[..., 12] * b[..., 12] +
        -a[..., 13] * b[..., 13] +
        a[..., 14] * b[..., 14] +
        a[..., 15] * b[..., 15] +
        -a[..., 16] * b[..., 16] +
        -a[..., 17] * b[..., 17] +
        a[..., 18] * b[..., 18] +
        -a[..., 19] * b[..., 19] +
        a[..., 20] * b[..., 20] +
        a[..., 21] * b[..., 21] +
        -a[..., 22] * b[..., 22] +
        a[..., 23] * b[..., 23] +
        a[..., 24] * b[..., 24] +
        a[..., 25] * b[..., 25] +
        a[..., 26] * b[..., 26] +
        -a[..., 27] * b[..., 27] +
        -a[..., 28] * b[..., 28] +
        -a[..., 29] * b[..., 29] +
        -a[..., 30] * b[..., 30] +
        -a[..., 31] * b[..., 31]
    )
    r1 = (
        a[..., 0] * b[..., 1] +
        a[..., 1] * b[..., 0] +
        -a[..., 2] * b[..., 6] +
        -a[..., 3] * b[..., 7] +
        -a[..., 4] * b[..., 8] +
        a[..., 5] * b[..., 9] +
        a[..., 6] * b[..., 2] +
        a[..., 7] * b[..., 3] +
        a[..., 8] * b[..., 4] +
        -a[..., 9] * b[..., 5] +
        -a[..., 10] * b[..., 16] +
        -a[..., 11] * b[..., 17] +
        a[..., 12] * b[..., 18] +
        -a[..., 13] * b[..., 19] +
        a[..., 14] * b[..., 20] +
        a[..., 15] * b[..., 21] +
        -a[..., 16] * b[..., 10] +
        -a[..., 17] * b[..., 11] +
        a[..., 18] * b[..., 12] +
        -a[..., 19] * b[..., 13] +
        a[..., 20] * b[..., 14] +
        a[..., 21] * b[..., 15] +
        a[..., 22] * b[..., 26] +
        -a[..., 23] * b[..., 27] +
        -a[..., 24] * b[..., 28] +
        -a[..., 25] * b[..., 29] +
        -a[..., 26] * b[..., 22] +
        a[..., 27] * b[..., 23] +
        a[..., 28] * b[..., 24] +
        a[..., 29] * b[..., 25] +
        -a[..., 30] * b[..., 31] +
        -a[..., 31] * b[..., 30]
    )
    r2 = (
        a[..., 0] * b[..., 2] +
        a[..., 1] * b[..., 6] +
        a[..., 2] * b[..., 0] +
        -a[..., 3] * b[..., 10] +
        -a[..., 4] * b[..., 11] +
        a[..., 5] * b[..., 12] +
        -a[..., 6] * b[..., 1] +
        a[..., 7] * b[..., 16] +
        a[..., 8] * b[..., 17] +
        -a[..., 9] * b[..., 18] +
        a[..., 10] * b[..., 3] +
        a[..., 11] * b[..., 4] +
        -a[..., 12] * b[..., 5] +
        -a[..., 13] * b[..., 22] +
        a[..., 14] * b[..., 23] +
        a[..., 15] * b[..., 24] +
        a[..., 16] * b[..., 7] +
        a[..., 17] * b[..., 8] +
        -a[..., 18] * b[..., 9] +
        -a[..., 19] * b[..., 26] +
        a[..., 20] * b[..., 27] +
        a[..., 21] * b[..., 28] +
        -a[..., 22] * b[..., 13] +
        a[..., 23] * b[..., 14] +
        a[..., 24] * b[..., 15] +
        -a[..., 25] * b[..., 30] +
        a[..., 26] * b[..., 19] +
        -a[..., 27] * b[..., 20] +
        -a[..., 28] * b[..., 21] +
        a[..., 29] * b[..., 31] +
        a[..., 30] * b[..., 25] +
        a[..., 31] * b[..., 29]
    )
    r3 = (
        a[..., 0] * b[..., 3] +
        a[..., 1] * b[..., 7] +
        a[..., 2] * b[..., 10] +
        a[..., 3] * b[..., 0] +
        -a[..., 4] * b[..., 13] +
        a[..., 5] * b[..., 14] +
        -a[..., 6] * b[..., 16] +
        -a[..., 7] * b[..., 1] +
        a[..., 8] * b[..., 19] +
        -a[..., 9] * b[..., 20] +
        -a[..., 10] * b[..., 2] +
        a[..., 11] * b[..., 22] +
        -a[..., 12] * b[..., 23] +
        a[..., 13] * b[..., 4] +
        -a[..., 14] * b[..., 5] +
        a[..., 15] * b[..., 25] +
        -a[..., 16] * b[..., 6] +
        a[..., 17] * b[..., 26] +
        -a[..., 18] * b[..., 27] +
        a[..., 19] * b[..., 8] +
        -a[..., 20] * b[..., 9] +
        a[..., 21] * b[..., 29] +
        a[..., 22] * b[..., 11] +
        -a[..., 23] * b[..., 12] +
        a[..., 24] * b[..., 30] +
        a[..., 25] * b[..., 15] +
        -a[..., 26] * b[..., 17] +
        a[..., 27] * b[..., 18] +
        -a[..., 28] * b[..., 31] +
        -a[..., 29] * b[..., 21] +
        -a[..., 30] * b[..., 24] +
        -a[..., 31] * b[..., 28]
    )
    r4 = (
        a[..., 0] * b[..., 4] +
        a[..., 1] * b[..., 8] +
        a[..., 2] * b[..., 11] +
        a[..., 3] * b[..., 13] +
        a[..., 4] * b[..., 0] +
        a[..., 5] * b[..., 15] +
        -a[..., 6] * b[..., 17] +
        -a[..., 7] * b[..., 19] +
        -a[..., 8] * b[..., 1] +
        -a[..., 9] * b[..., 21] +
        -a[..., 10] * b[..., 22] +
        -a[..., 11] * b[..., 2] +
        -a[..., 12] * b[..., 24] +
        -a[..., 13] * b[..., 3] +
        -a[..., 14] * b[..., 25] +
        -a[..., 15] * b[..., 5] +
        -a[..., 16] * b[..., 26] +
        -a[..., 17] * b[..., 6] +
        -a[..., 18] * b[..., 28] +
        -a[..., 19] * b[..., 7] +
        -a[..., 20] * b[..., 29] +
        -a[..., 21] * b[..., 9] +
        -a[..., 22] * b[..., 10] +
        -a[..., 23] * b[..., 30] +
        -a[..., 24] * b[..., 12] +
        -a[..., 25] * b[..., 14] +
        a[..., 26] * b[..., 16] +
        a[..., 27] * b[..., 31] +
        a[..., 28] * b[..., 18] +
        a[..., 29] * b[..., 20] +
        a[..., 30] * b[..., 23] +
        a[..., 31] * b[..., 27]
    )
    r5 = (
        a[..., 0] * b[..., 5] +
        a[..., 1] * b[..., 9] +
        a[..., 2] * b[..., 12] +
        a[..., 3] * b[..., 14] +
        a[..., 4] * b[..., 15] +
        a[..., 5] * b[..., 0] +
        -a[..., 6] * b[..., 18] +
        -a[..., 7] * b[..., 20] +
        -a[..., 8] * b[..., 21] +
        -a[..., 9] * b[..., 1] +
        -a[..., 10] * b[..., 23] +
        -a[..., 11] * b[..., 24] +
        -a[..., 12] * b[..., 2] +
        -a[..., 13] * b[..., 25] +
        -a[..., 14] * b[..., 3] +
        -a[..., 15] * b[..., 4] +
        -a[..., 16] * b[..., 27] +
        -a[..., 17] * b[..., 28] +
        -a[..., 18] * b[..., 6] +
        -a[..., 19] * b[..., 29] +
        -a[..., 20] * b[..., 7] +
        -a[..., 21] * b[..., 8] +
        -a[..., 22] * b[..., 30] +
        -a[..., 23] * b[..., 10] +
        -a[..., 24] * b[..., 11] +
        -a[..., 25] * b[..., 13] +
        a[..., 26] * b[..., 31] +
        a[..., 27] * b[..., 16] +
        a[..., 28] * b[..., 17] +
        a[..., 29] * b[..., 19] +
        a[..., 30] * b[..., 22] +
        a[..., 31] * b[..., 26]
    )
    r6 = (
        a[..., 0] * b[..., 6] +
        a[..., 1] * b[..., 2] +
        -a[..., 2] * b[..., 1] +
        a[..., 3] * b[..., 16] +
        a[..., 4] * b[..., 17] +
        -a[..., 5] * b[..., 18] +
        a[..., 6] * b[..., 0] +
        -a[..., 7] * b[..., 10] +
        -a[..., 8] * b[..., 11] +
        a[..., 9] * b[..., 12] +
        a[..., 10] * b[..., 7] +
        a[..., 11] * b[..., 8] +
        -a[..., 12] * b[..., 9] +
        -a[..., 13] * b[..., 26] +
        a[..., 14] * b[..., 27] +
        a[..., 15] * b[..., 28] +
        a[..., 16] * b[..., 3] +
        a[..., 17] * b[..., 4] +
        -a[..., 18] * b[..., 5] +
        -a[..., 19] * b[..., 22] +
        a[..., 20] * b[..., 23] +
        a[..., 21] * b[..., 24] +
        a[..., 22] * b[..., 19] +
        -a[..., 23] * b[..., 20] +
        -a[..., 24] * b[..., 21] +
        a[..., 25] * b[..., 31] +
        -a[..., 26] * b[..., 13] +
        a[..., 27] * b[..., 14] +
        a[..., 28] * b[..., 15] +
        -a[..., 29] * b[..., 30] +
        a[..., 30] * b[..., 29] +
        a[..., 31] * b[..., 25]
    )
    r7 = (
        a[..., 0] * b[..., 7] +
        a[..., 1] * b[..., 3] +
        -a[..., 2] * b[..., 16] +
        -a[..., 3] * b[..., 1] +
        a[..., 4] * b[..., 19] +
        -a[..., 5] * b[..., 20] +
        a[..., 6] * b[..., 10] +
        a[..., 7] * b[..., 0] +
        -a[..., 8] * b[..., 13] +
        a[..., 9] * b[..., 14] +
        -a[..., 10] * b[..., 6] +
        a[..., 11] * b[..., 26] +
        -a[..., 12] * b[..., 27] +
        a[..., 13] * b[..., 8] +
        -a[..., 14] * b[..., 9] +
        a[..., 15] * b[..., 29] +
        -a[..., 16] * b[..., 2] +
        a[..., 17] * b[..., 22] +
        -a[..., 18] * b[..., 23] +
        a[..., 19] * b[..., 4] +
        -a[..., 20] * b[..., 5] +
        a[..., 21] * b[..., 25] +
        -a[..., 22] * b[..., 17] +
        a[..., 23] * b[..., 18] +
        -a[..., 24] * b[..., 31] +
        -a[..., 25] * b[..., 21] +
        a[..., 26] * b[..., 11] +
        -a[..., 27] * b[..., 12] +
        a[..., 28] * b[..., 30] +
        a[..., 29] * b[..., 15] +
        -a[..., 30] * b[..., 28] +
        -a[..., 31] * b[..., 24]
    )
    r8 = (
        a[..., 0] * b[..., 8] +
        a[..., 1] * b[..., 4] +
        -a[..., 2] * b[..., 17] +
        -a[..., 3] * b[..., 19] +
        -a[..., 4] * b[..., 1] +
        -a[..., 5] * b[..., 21] +
        a[..., 6] * b[..., 11] +
        a[..., 7] * b[..., 13] +
        a[..., 8] * b[..., 0] +
        a[..., 9] * b[..., 15] +
        -a[..., 10] * b[..., 26] +
        -a[..., 11] * b[..., 6] +
        -a[..., 12] * b[..., 28] +
        -a[..., 13] * b[..., 7] +
        -a[..., 14] * b[..., 29] +
        -a[..., 15] * b[..., 9] +
        -a[..., 16] * b[..., 22] +
        -a[..., 17] * b[..., 2] +
        -a[..., 18] * b[..., 24] +
        -a[..., 19] * b[..., 3] +
        -a[..., 20] * b[..., 25] +
        -a[..., 21] * b[..., 5] +
        a[..., 22] * b[..., 16] +
        a[..., 23] * b[..., 31] +
        a[..., 24] * b[..., 18] +
        a[..., 25] * b[..., 20] +
        -a[..., 26] * b[..., 10] +
        -a[..., 27] * b[..., 30] +
        -a[..., 28] * b[..., 12] +
        -a[..., 29] * b[..., 14] +
        a[..., 30] * b[..., 27] +
        a[..., 31] * b[..., 23]
    )
    r9 = (
        a[..., 0] * b[..., 9] +
        a[..., 1] * b[..., 5] +
        -a[..., 2] * b[..., 18] +
        -a[..., 3] * b[..., 20] +
        -a[..., 4] * b[..., 21] +
        -a[..., 5] * b[..., 1] +
        a[..., 6] * b[..., 12] +
        a[..., 7] * b[..., 14] +
        a[..., 8] * b[..., 15] +
        a[..., 9] * b[..., 0] +
        -a[..., 10] * b[..., 27] +
        -a[..., 11] * b[..., 28] +
        -a[..., 12] * b[..., 6] +
        -a[..., 13] * b[..., 29] +
        -a[..., 14] * b[..., 7] +
        -a[..., 15] * b[..., 8] +
        -a[..., 16] * b[..., 23] +
        -a[..., 17] * b[..., 24] +
        -a[..., 18] * b[..., 2] +
        -a[..., 19] * b[..., 25] +
        -a[..., 20] * b[..., 3] +
        -a[..., 21] * b[..., 4] +
        a[..., 22] * b[..., 31] +
        a[..., 23] * b[..., 16] +
        a[..., 24] * b[..., 17] +
        a[..., 25] * b[..., 19] +
        -a[..., 26] * b[..., 30] +
        -a[..., 27] * b[..., 10] +
        -a[..., 28] * b[..., 11] +
        -a[..., 29] * b[..., 13] +
        a[..., 30] * b[..., 26] +
        a[..., 31] * b[..., 22]
    )
    r10 = (
        a[..., 0] * b[..., 10] +
        a[..., 1] * b[..., 16] +
        a[..., 2] * b[..., 3] +
        -a[..., 3] * b[..., 2] +
        a[..., 4] * b[..., 22] +
        -a[..., 5] * b[..., 23] +
        -a[..., 6] * b[..., 7] +
        a[..., 7] * b[..., 6] +
        -a[..., 8] * b[..., 26] +
        a[..., 9] * b[..., 27] +
        a[..., 10] * b[..., 0] +
        -a[..., 11] * b[..., 13] +
        a[..., 12] * b[..., 14] +
        a[..., 13] * b[..., 11] +
        -a[..., 14] * b[..., 12] +
        a[..., 15] * b[..., 30] +
        a[..., 16] * b[..., 1] +
        -a[..., 17] * b[..., 19] +
        a[..., 18] * b[..., 20] +
        a[..., 19] * b[..., 17] +
        -a[..., 20] * b[..., 18] +
        a[..., 21] * b[..., 31] +
        a[..., 22] * b[..., 4] +
        -a[..., 23] * b[..., 5] +
        a[..., 24] * b[..., 25] +
        -a[..., 25] * b[..., 24] +
        -a[..., 26] * b[..., 8] +
        a[..., 27] * b[..., 9] +
        -a[..., 28] * b[..., 29] +
        a[..., 29] * b[..., 28] +
        a[..., 30] * b[..., 15] +
        a[..., 31] * b[..., 21]
    )
    r11 = (
        a[..., 0] * b[..., 11] +
        a[..., 1] * b[..., 17] +
        a[..., 2] * b[..., 4] +
        -a[..., 3] * b[..., 22] +
        -a[..., 4] * b[..., 2] +
        -a[..., 5] * b[..., 24] +
        -a[..., 6] * b[..., 8] +
        a[..., 7] * b[..., 26] +
        a[..., 8] * b[..., 6] +
        a[..., 9] * b[..., 28] +
        a[..., 10] * b[..., 13] +
        a[..., 11] * b[..., 0] +
        a[..., 12] * b[..., 15] +
        -a[..., 13] * b[..., 10] +
        -a[..., 14] * b[..., 30] +
        -a[..., 15] * b[..., 12] +
        a[..., 16] * b[..., 19] +
        a[..., 17] * b[..., 1] +
        a[..., 18] * b[..., 21] +
        -a[..., 19] * b[..., 16] +
        -a[..., 20] * b[..., 31] +
        -a[..., 21] * b[..., 18] +
        -a[..., 22] * b[..., 3] +
        -a[..., 23] * b[..., 25] +
        -a[..., 24] * b[..., 5] +
        a[..., 25] * b[..., 23] +
        a[..., 26] * b[..., 7] +
        a[..., 27] * b[..., 29] +
        a[..., 28] * b[..., 9] +
        -a[..., 29] * b[..., 27] +
        -a[..., 30] * b[..., 14] +
        -a[..., 31] * b[..., 20]
    )
    r12 = (
        a[..., 0] * b[..., 12] +
        a[..., 1] * b[..., 18] +
        a[..., 2] * b[..., 5] +
        -a[..., 3] * b[..., 23] +
        -a[..., 4] * b[..., 24] +
        -a[..., 5] * b[..., 2] +
        -a[..., 6] * b[..., 9] +
        a[..., 7] * b[..., 27] +
        a[..., 8] * b[..., 28] +
        a[..., 9] * b[..., 6] +
        a[..., 10] * b[..., 14] +
        a[..., 11] * b[..., 15] +
        a[..., 12] * b[..., 0] +
        -a[..., 13] * b[..., 30] +
        -a[..., 14] * b[..., 10] +
        -a[..., 15] * b[..., 11] +
        a[..., 16] * b[..., 20] +
        a[..., 17] * b[..., 21] +
        a[..., 18] * b[..., 1] +
        -a[..., 19] * b[..., 31] +
        -a[..., 20] * b[..., 16] +
        -a[..., 21] * b[..., 17] +
        -a[..., 22] * b[..., 25] +
        -a[..., 23] * b[..., 3] +
        -a[..., 24] * b[..., 4] +
        a[..., 25] * b[..., 22] +
        a[..., 26] * b[..., 29] +
        a[..., 27] * b[..., 7] +
        a[..., 28] * b[..., 8] +
        -a[..., 29] * b[..., 26] +
        -a[..., 30] * b[..., 13] +
        -a[..., 31] * b[..., 19]
    )
    r13 = (
        a[..., 0] * b[..., 13] +
        a[..., 1] * b[..., 19] +
        a[..., 2] * b[..., 22] +
        a[..., 3] * b[..., 4] +
        -a[..., 4] * b[..., 3] +
        -a[..., 5] * b[..., 25] +
        -a[..., 6] * b[..., 26] +
        -a[..., 7] * b[..., 8] +
        a[..., 8] * b[..., 7] +
        a[..., 9] * b[..., 29] +
        -a[..., 10] * b[..., 11] +
        a[..., 11] * b[..., 10] +
        a[..., 12] * b[..., 30] +
        a[..., 13] * b[..., 0] +
        a[..., 14] * b[..., 15] +
        -a[..., 15] * b[..., 14] +
        -a[..., 16] * b[..., 17] +
        a[..., 17] * b[..., 16] +
        a[..., 18] * b[..., 31] +
        a[..., 19] * b[..., 1] +
        a[..., 20] * b[..., 21] +
        -a[..., 21] * b[..., 20] +
        a[..., 22] * b[..., 2] +
        a[..., 23] * b[..., 24] +
        -a[..., 24] * b[..., 23] +
        -a[..., 25] * b[..., 5] +
        -a[..., 26] * b[..., 6] +
        -a[..., 27] * b[..., 28] +
        a[..., 28] * b[..., 27] +
        a[..., 29] * b[..., 9] +
        a[..., 30] * b[..., 12] +
        a[..., 31] * b[..., 18]
    )
    r14 = (
        a[..., 0] * b[..., 14] +
        a[..., 1] * b[..., 20] +
        a[..., 2] * b[..., 23] +
        a[..., 3] * b[..., 5] +
        -a[..., 4] * b[..., 25] +
        -a[..., 5] * b[..., 3] +
        -a[..., 6] * b[..., 27] +
        -a[..., 7] * b[..., 9] +
        a[..., 8] * b[..., 29] +
        a[..., 9] * b[..., 7] +
        -a[..., 10] * b[..., 12] +
        a[..., 11] * b[..., 30] +
        a[..., 12] * b[..., 10] +
        a[..., 13] * b[..., 15] +
        a[..., 14] * b[..., 0] +
        -a[..., 15] * b[..., 13] +
        -a[..., 16] * b[..., 18] +
        a[..., 17] * b[..., 31] +
        a[..., 18] * b[..., 16] +
        a[..., 19] * b[..., 21] +
        a[..., 20] * b[..., 1] +
        -a[..., 21] * b[..., 19] +
        a[..., 22] * b[..., 24] +
        a[..., 23] * b[..., 2] +
        -a[..., 24] * b[..., 22] +
        -a[..., 25] * b[..., 4] +
        -a[..., 26] * b[..., 28] +
        -a[..., 27] * b[..., 6] +
        a[..., 28] * b[..., 26] +
        a[..., 29] * b[..., 8] +
        a[..., 30] * b[..., 11] +
        a[..., 31] * b[..., 17]
    )
    r15 = (
        a[..., 0] * b[..., 15] +
        a[..., 1] * b[..., 21] +
        a[..., 2] * b[..., 24] +
        a[..., 3] * b[..., 25] +
        a[..., 4] * b[..., 5] +
        -a[..., 5] * b[..., 4] +
        -a[..., 6] * b[..., 28] +
        -a[..., 7] * b[..., 29] +
        -a[..., 8] * b[..., 9] +
        a[..., 9] * b[..., 8] +
        -a[..., 10] * b[..., 30] +
        -a[..., 11] * b[..., 12] +
        a[..., 12] * b[..., 11] +
        -a[..., 13] * b[..., 14] +
        a[..., 14] * b[..., 13] +
        a[..., 15] * b[..., 0] +
        -a[..., 16] * b[..., 31] +
        -a[..., 17] * b[..., 18] +
        a[..., 18] * b[..., 17] +
        -a[..., 19] * b[..., 20] +
        a[..., 20] * b[..., 19] +
        a[..., 21] * b[..., 1] +
        -a[..., 22] * b[..., 23] +
        a[..., 23] * b[..., 22] +
        a[..., 24] * b[..., 2] +
        a[..., 25] * b[..., 3] +
        a[..., 26] * b[..., 27] +
        -a[..., 27] * b[..., 26] +
        -a[..., 28] * b[..., 6] +
        -a[..., 29] * b[..., 7] +
        -a[..., 30] * b[..., 10] +
        -a[..., 31] * b[..., 16]
    )
    r16 = (
        a[..., 0] * b[..., 16] +
        a[..., 1] * b[..., 10] +
        -a[..., 2] * b[..., 7] +
        a[..., 3] * b[..., 6] +
        -a[..., 4] * b[..., 26] +
        a[..., 5] * b[..., 27] +
        a[..., 6] * b[..., 3] +
        -a[..., 7] * b[..., 2] +
        a[..., 8] * b[..., 22] +
        -a[..., 9] * b[..., 23] +
        a[..., 10] * b[..., 1] +
        -a[..., 11] * b[..., 19] +
        a[..., 12] * b[..., 20] +
        a[..., 13] * b[..., 17] +
        -a[..., 14] * b[..., 18] +
        a[..., 15] * b[..., 31] +
        a[..., 16] * b[..., 0] +
        -a[..., 17] * b[..., 13] +
        a[..., 18] * b[..., 14] +
        a[..., 19] * b[..., 11] +
        -a[..., 20] * b[..., 12] +
        a[..., 21] * b[..., 30] +
        -a[..., 22] * b[..., 8] +
        a[..., 23] * b[..., 9] +
        -a[..., 24] * b[..., 29] +
        a[..., 25] * b[..., 28] +
        a[..., 26] * b[..., 4] +
        -a[..., 27] * b[..., 5] +
        a[..., 28] * b[..., 25] +
        -a[..., 29] * b[..., 24] +
        a[..., 30] * b[..., 21] +
        a[..., 31] * b[..., 15]
    )
    r17 = (
        a[..., 0] * b[..., 17] +
        a[..., 1] * b[..., 11] +
        -a[..., 2] * b[..., 8] +
        a[..., 3] * b[..., 26] +
        a[..., 4] * b[..., 6] +
        a[..., 5] * b[..., 28] +
        a[..., 6] * b[..., 4] +
        -a[..., 7] * b[..., 22] +
        -a[..., 8] * b[..., 2] +
        -a[..., 9] * b[..., 24] +
        a[..., 10] * b[..., 19] +
        a[..., 11] * b[..., 1] +
        a[..., 12] * b[..., 21] +
        -a[..., 13] * b[..., 16] +
        -a[..., 14] * b[..., 31] +
        -a[..., 15] * b[..., 18] +
        a[..., 16] * b[..., 13] +
        a[..., 17] * b[..., 0] +
        a[..., 18] * b[..., 15] +
        -a[..., 19] * b[..., 10] +
        -a[..., 20] * b[..., 30] +
        -a[..., 21] * b[..., 12] +
        a[..., 22] * b[..., 7] +
        a[..., 23] * b[..., 29] +
        a[..., 24] * b[..., 9] +
        -a[..., 25] * b[..., 27] +
        -a[..., 26] * b[..., 3] +
        -a[..., 27] * b[..., 25] +
        -a[..., 28] * b[..., 5] +
        a[..., 29] * b[..., 23] +
        -a[..., 30] * b[..., 20] +
        -a[..., 31] * b[..., 14]
    )
    r18 = (
        a[..., 0] * b[..., 18] +
        a[..., 1] * b[..., 12] +
        -a[..., 2] * b[..., 9] +
        a[..., 3] * b[..., 27] +
        a[..., 4] * b[..., 28] +
        a[..., 5] * b[..., 6] +
        a[..., 6] * b[..., 5] +
        -a[..., 7] * b[..., 23] +
        -a[..., 8] * b[..., 24] +
        -a[..., 9] * b[..., 2] +
        a[..., 10] * b[..., 20] +
        a[..., 11] * b[..., 21] +
        a[..., 12] * b[..., 1] +
        -a[..., 13] * b[..., 31] +
        -a[..., 14] * b[..., 16] +
        -a[..., 15] * b[..., 17] +
        a[..., 16] * b[..., 14] +
        a[..., 17] * b[..., 15] +
        a[..., 18] * b[..., 0] +
        -a[..., 19] * b[..., 30] +
        -a[..., 20] * b[..., 10] +
        -a[..., 21] * b[..., 11] +
        a[..., 22] * b[..., 29] +
        a[..., 23] * b[..., 7] +
        a[..., 24] * b[..., 8] +
        -a[..., 25] * b[..., 26] +
        -a[..., 26] * b[..., 25] +
        -a[..., 27] * b[..., 3] +
        -a[..., 28] * b[..., 4] +
        a[..., 29] * b[..., 22] +
        -a[..., 30] * b[..., 19] +
        -a[..., 31] * b[..., 13]
    )
    r19 = (
        a[..., 0] * b[..., 19] +
        a[..., 1] * b[..., 13] +
        -a[..., 2] * b[..., 26] +
        -a[..., 3] * b[..., 8] +
        a[..., 4] * b[..., 7] +
        a[..., 5] * b[..., 29] +
        a[..., 6] * b[..., 22] +
        a[..., 7] * b[..., 4] +
        -a[..., 8] * b[..., 3] +
        -a[..., 9] * b[..., 25] +
        -a[..., 10] * b[..., 17] +
        a[..., 11] * b[..., 16] +
        a[..., 12] * b[..., 31] +
        a[..., 13] * b[..., 1] +
        a[..., 14] * b[..., 21] +
        -a[..., 15] * b[..., 20] +
        -a[..., 16] * b[..., 11] +
        a[..., 17] * b[..., 10] +
        a[..., 18] * b[..., 30] +
        a[..., 19] * b[..., 0] +
        a[..., 20] * b[..., 15] +
        -a[..., 21] * b[..., 14] +
        -a[..., 22] * b[..., 6] +
        -a[..., 23] * b[..., 28] +
        a[..., 24] * b[..., 27] +
        a[..., 25] * b[..., 9] +
        a[..., 26] * b[..., 2] +
        a[..., 27] * b[..., 24] +
        -a[..., 28] * b[..., 23] +
        -a[..., 29] * b[..., 5] +
        a[..., 30] * b[..., 18] +
        a[..., 31] * b[..., 12]
    )
    r20 = (
        a[..., 0] * b[..., 20] +
        a[..., 1] * b[..., 14] +
        -a[..., 2] * b[..., 27] +
        -a[..., 3] * b[..., 9] +
        a[..., 4] * b[..., 29] +
        a[..., 5] * b[..., 7] +
        a[..., 6] * b[..., 23] +
        a[..., 7] * b[..., 5] +
        -a[..., 8] * b[..., 25] +
        -a[..., 9] * b[..., 3] +
        -a[..., 10] * b[..., 18] +
        a[..., 11] * b[..., 31] +
        a[..., 12] * b[..., 16] +
        a[..., 13] * b[..., 21] +
        a[..., 14] * b[..., 1] +
        -a[..., 15] * b[..., 19] +
        -a[..., 16] * b[..., 12] +
        a[..., 17] * b[..., 30] +
        a[..., 18] * b[..., 10] +
        a[..., 19] * b[..., 15] +
        a[..., 20] * b[..., 0] +
        -a[..., 21] * b[..., 13] +
        -a[..., 22] * b[..., 28] +
        -a[..., 23] * b[..., 6] +
        a[..., 24] * b[..., 26] +
        a[..., 25] * b[..., 8] +
        a[..., 26] * b[..., 24] +
        a[..., 27] * b[..., 2] +
        -a[..., 28] * b[..., 22] +
        -a[..., 29] * b[..., 4] +
        a[..., 30] * b[..., 17] +
        a[..., 31] * b[..., 11]
    )
    r21 = (
        a[..., 0] * b[..., 21] +
        a[..., 1] * b[..., 15] +
        -a[..., 2] * b[..., 28] +
        -a[..., 3] * b[..., 29] +
        -a[..., 4] * b[..., 9] +
        a[..., 5] * b[..., 8] +
        a[..., 6] * b[..., 24] +
        a[..., 7] * b[..., 25] +
        a[..., 8] * b[..., 5] +
        -a[..., 9] * b[..., 4] +
        -a[..., 10] * b[..., 31] +
        -a[..., 11] * b[..., 18] +
        a[..., 12] * b[..., 17] +
        -a[..., 13] * b[..., 20] +
        a[..., 14] * b[..., 19] +
        a[..., 15] * b[..., 1] +
        -a[..., 16] * b[..., 30] +
        -a[..., 17] * b[..., 12] +
        a[..., 18] * b[..., 11] +
        -a[..., 19] * b[..., 14] +
        a[..., 20] * b[..., 13] +
        a[..., 21] * b[..., 0] +
        a[..., 22] * b[..., 27] +
        -a[..., 23] * b[..., 26] +
        -a[..., 24] * b[..., 6] +
        -a[..., 25] * b[..., 7] +
        -a[..., 26] * b[..., 23] +
        a[..., 27] * b[..., 22] +
        a[..., 28] * b[..., 2] +
        a[..., 29] * b[..., 3] +
        -a[..., 30] * b[..., 16] +
        -a[..., 31] * b[..., 10]
    )
    r22 = (
        a[..., 0] * b[..., 22] +
        a[..., 1] * b[..., 26] +
        a[..., 2] * b[..., 13] +
        -a[..., 3] * b[..., 11] +
        a[..., 4] * b[..., 10] +
        a[..., 5] * b[..., 30] +
        -a[..., 6] * b[..., 19] +
        a[..., 7] * b[..., 17] +
        -a[..., 8] * b[..., 16] +
        -a[..., 9] * b[..., 31] +
        a[..., 10] * b[..., 4] +
        -a[..., 11] * b[..., 3] +
        -a[..., 12] * b[..., 25] +
        a[..., 13] * b[..., 2] +
        a[..., 14] * b[..., 24] +
        -a[..., 15] * b[..., 23] +
        a[..., 16] * b[..., 8] +
        -a[..., 17] * b[..., 7] +
        -a[..., 18] * b[..., 29] +
        a[..., 19] * b[..., 6] +
        a[..., 20] * b[..., 28] +
        -a[..., 21] * b[..., 27] +
        a[..., 22] * b[..., 0] +
        a[..., 23] * b[..., 15] +
        -a[..., 24] * b[..., 14] +
        a[..., 25] * b[..., 12] +
        -a[..., 26] * b[..., 1] +
        -a[..., 27] * b[..., 21] +
        a[..., 28] * b[..., 20] +
        -a[..., 29] * b[..., 18] +
        -a[..., 30] * b[..., 5] +
        -a[..., 31] * b[..., 9]
    )
    r23 = (
        a[..., 0] * b[..., 23] +
        a[..., 1] * b[..., 27] +
        a[..., 2] * b[..., 14] +
        -a[..., 3] * b[..., 12] +
        a[..., 4] * b[..., 30] +
        a[..., 5] * b[..., 10] +
        -a[..., 6] * b[..., 20] +
        a[..., 7] * b[..., 18] +
        -a[..., 8] * b[..., 31] +
        -a[..., 9] * b[..., 16] +
        a[..., 10] * b[..., 5] +
        -a[..., 11] * b[..., 25] +
        -a[..., 12] * b[..., 3] +
        a[..., 13] * b[..., 24] +
        a[..., 14] * b[..., 2] +
        -a[..., 15] * b[..., 22] +
        a[..., 16] * b[..., 9] +
        -a[..., 17] * b[..., 29] +
        -a[..., 18] * b[..., 7] +
        a[..., 19] * b[..., 28] +
        a[..., 20] * b[..., 6] +
        -a[..., 21] * b[..., 26] +
        a[..., 22] * b[..., 15] +
        a[..., 23] * b[..., 0] +
        -a[..., 24] * b[..., 13] +
        a[..., 25] * b[..., 11] +
        -a[..., 26] * b[..., 21] +
        -a[..., 27] * b[..., 1] +
        a[..., 28] * b[..., 19] +
        -a[..., 29] * b[..., 17] +
        -a[..., 30] * b[..., 4] +
        -a[..., 31] * b[..., 8]
    )
    r24 = (
        a[..., 0] * b[..., 24] +
        a[..., 1] * b[..., 28] +
        a[..., 2] * b[..., 15] +
        -a[..., 3] * b[..., 30] +
        -a[..., 4] * b[..., 12] +
        a[..., 5] * b[..., 11] +
        -a[..., 6] * b[..., 21] +
        a[..., 7] * b[..., 31] +
        a[..., 8] * b[..., 18] +
        -a[..., 9] * b[..., 17] +
        a[..., 10] * b[..., 25] +
        a[..., 11] * b[..., 5] +
        -a[..., 12] * b[..., 4] +
        -a[..., 13] * b[..., 23] +
        a[..., 14] * b[..., 22] +
        a[..., 15] * b[..., 2] +
        a[..., 16] * b[..., 29] +
        a[..., 17] * b[..., 9] +
        -a[..., 18] * b[..., 8] +
        -a[..., 19] * b[..., 27] +
        a[..., 20] * b[..., 26] +
        a[..., 21] * b[..., 6] +
        -a[..., 22] * b[..., 14] +
        a[..., 23] * b[..., 13] +
        a[..., 24] * b[..., 0] +
        -a[..., 25] * b[..., 10] +
        a[..., 26] * b[..., 20] +
        -a[..., 27] * b[..., 19] +
        -a[..., 28] * b[..., 1] +
        a[..., 29] * b[..., 16] +
        a[..., 30] * b[..., 3] +
        a[..., 31] * b[..., 7]
    )
    r25 = (
        a[..., 0] * b[..., 25] +
        a[..., 1] * b[..., 29] +
        a[..., 2] * b[..., 30] +
        a[..., 3] * b[..., 15] +
        -a[..., 4] * b[..., 14] +
        a[..., 5] * b[..., 13] +
        -a[..., 6] * b[..., 31] +
        -a[..., 7] * b[..., 21] +
        a[..., 8] * b[..., 20] +
        -a[..., 9] * b[..., 19] +
        -a[..., 10] * b[..., 24] +
        a[..., 11] * b[..., 23] +
        -a[..., 12] * b[..., 22] +
        a[..., 13] * b[..., 5] +
        -a[..., 14] * b[..., 4] +
        a[..., 15] * b[..., 3] +
        -a[..., 16] * b[..., 28] +
        a[..., 17] * b[..., 27] +
        -a[..., 18] * b[..., 26] +
        a[..., 19] * b[..., 9] +
        -a[..., 20] * b[..., 8] +
        a[..., 21] * b[..., 7] +
        a[..., 22] * b[..., 12] +
        -a[..., 23] * b[..., 11] +
        a[..., 24] * b[..., 10] +
        a[..., 25] * b[..., 0] +
        -a[..., 26] * b[..., 18] +
        a[..., 27] * b[..., 17] +
        -a[..., 28] * b[..., 16] +
        -a[..., 29] * b[..., 1] +
        -a[..., 30] * b[..., 2] +
        -a[..., 31] * b[..., 6]
    )
    r26 = (
        a[..., 0] * b[..., 26] +
        a[..., 1] * b[..., 22] +
        -a[..., 2] * b[..., 19] +
        a[..., 3] * b[..., 17] +
        -a[..., 4] * b[..., 16] +
        -a[..., 5] * b[..., 31] +
        a[..., 6] * b[..., 13] +
        -a[..., 7] * b[..., 11] +
        a[..., 8] * b[..., 10] +
        a[..., 9] * b[..., 30] +
        a[..., 10] * b[..., 8] +
        -a[..., 11] * b[..., 7] +
        -a[..., 12] * b[..., 29] +
        a[..., 13] * b[..., 6] +
        a[..., 14] * b[..., 28] +
        -a[..., 15] * b[..., 27] +
        a[..., 16] * b[..., 4] +
        -a[..., 17] * b[..., 3] +
        -a[..., 18] * b[..., 25] +
        a[..., 19] * b[..., 2] +
        a[..., 20] * b[..., 24] +
        -a[..., 21] * b[..., 23] +
        -a[..., 22] * b[..., 1] +
        -a[..., 23] * b[..., 21] +
        a[..., 24] * b[..., 20] +
        -a[..., 25] * b[..., 18] +
        a[..., 26] * b[..., 0] +
        a[..., 27] * b[..., 15] +
        -a[..., 28] * b[..., 14] +
        a[..., 29] * b[..., 12] +
        -a[..., 30] * b[..., 9] +
        -a[..., 31] * b[..., 5]
    )
    r27 = (
        a[..., 0] * b[..., 27] +
        a[..., 1] * b[..., 23] +
        -a[..., 2] * b[..., 20] +
        a[..., 3] * b[..., 18] +
        -a[..., 4] * b[..., 31] +
        -a[..., 5] * b[..., 16] +
        a[..., 6] * b[..., 14] +
        -a[..., 7] * b[..., 12] +
        a[..., 8] * b[..., 30] +
        a[..., 9] * b[..., 10] +
        a[..., 10] * b[..., 9] +
        -a[..., 11] * b[..., 29] +
        -a[..., 12] * b[..., 7] +
        a[..., 13] * b[..., 28] +
        a[..., 14] * b[..., 6] +
        -a[..., 15] * b[..., 26] +
        a[..., 16] * b[..., 5] +
        -a[..., 17] * b[..., 25] +
        -a[..., 18] * b[..., 3] +
        a[..., 19] * b[..., 24] +
        a[..., 20] * b[..., 2] +
        -a[..., 21] * b[..., 22] +
        -a[..., 22] * b[..., 21] +
        -a[..., 23] * b[..., 1] +
        a[..., 24] * b[..., 19] +
        -a[..., 25] * b[..., 17] +
        a[..., 26] * b[..., 15] +
        a[..., 27] * b[..., 0] +
        -a[..., 28] * b[..., 13] +
        a[..., 29] * b[..., 11] +
        -a[..., 30] * b[..., 8] +
        -a[..., 31] * b[..., 4]
    )
    r28 = (
        a[..., 0] * b[..., 28] +
        a[..., 1] * b[..., 24] +
        -a[..., 2] * b[..., 21] +
        a[..., 3] * b[..., 31] +
        a[..., 4] * b[..., 18] +
        -a[..., 5] * b[..., 17] +
        a[..., 6] * b[..., 15] +
        -a[..., 7] * b[..., 30] +
        -a[..., 8] * b[..., 12] +
        a[..., 9] * b[..., 11] +
        a[..., 10] * b[..., 29] +
        a[..., 11] * b[..., 9] +
        -a[..., 12] * b[..., 8] +
        -a[..., 13] * b[..., 27] +
        a[..., 14] * b[..., 26] +
        a[..., 15] * b[..., 6] +
        a[..., 16] * b[..., 25] +
        a[..., 17] * b[..., 5] +
        -a[..., 18] * b[..., 4] +
        -a[..., 19] * b[..., 23] +
        a[..., 20] * b[..., 22] +
        a[..., 21] * b[..., 2] +
        a[..., 22] * b[..., 20] +
        -a[..., 23] * b[..., 19] +
        -a[..., 24] * b[..., 1] +
        a[..., 25] * b[..., 16] +
        -a[..., 26] * b[..., 14] +
        a[..., 27] * b[..., 13] +
        a[..., 28] * b[..., 0] +
        -a[..., 29] * b[..., 10] +
        a[..., 30] * b[..., 7] +
        a[..., 31] * b[..., 3]
    )
    r29 = (
        a[..., 0] * b[..., 29] +
        a[..., 1] * b[..., 25] +
        -a[..., 2] * b[..., 31] +
        -a[..., 3] * b[..., 21] +
        a[..., 4] * b[..., 20] +
        -a[..., 5] * b[..., 19] +
        a[..., 6] * b[..., 30] +
        a[..., 7] * b[..., 15] +
        -a[..., 8] * b[..., 14] +
        a[..., 9] * b[..., 13] +
        -a[..., 10] * b[..., 28] +
        a[..., 11] * b[..., 27] +
        -a[..., 12] * b[..., 26] +
        a[..., 13] * b[..., 9] +
        -a[..., 14] * b[..., 8] +
        a[..., 15] * b[..., 7] +
        -a[..., 16] * b[..., 24] +
        a[..., 17] * b[..., 23] +
        -a[..., 18] * b[..., 22] +
        a[..., 19] * b[..., 5] +
        -a[..., 20] * b[..., 4] +
        a[..., 21] * b[..., 3] +
        -a[..., 22] * b[..., 18] +
        a[..., 23] * b[..., 17] +
        -a[..., 24] * b[..., 16] +
        -a[..., 25] * b[..., 1] +
        a[..., 26] * b[..., 12] +
        -a[..., 27] * b[..., 11] +
        a[..., 28] * b[..., 10] +
        a[..., 29] * b[..., 0] +
        -a[..., 30] * b[..., 6] +
        -a[..., 31] * b[..., 2]
    )
    r30 = (
        a[..., 0] * b[..., 30] +
        a[..., 1] * b[..., 31] +
        a[..., 2] * b[..., 25] +
        -a[..., 3] * b[..., 24] +
        a[..., 4] * b[..., 23] +
        -a[..., 5] * b[..., 22] +
        -a[..., 6] * b[..., 29] +
        a[..., 7] * b[..., 28] +
        -a[..., 8] * b[..., 27] +
        a[..., 9] * b[..., 26] +
        a[..., 10] * b[..., 15] +
        -a[..., 11] * b[..., 14] +
        a[..., 12] * b[..., 13] +
        a[..., 13] * b[..., 12] +
        -a[..., 14] * b[..., 11] +
        a[..., 15] * b[..., 10] +
        a[..., 16] * b[..., 21] +
        -a[..., 17] * b[..., 20] +
        a[..., 18] * b[..., 19] +
        a[..., 19] * b[..., 18] +
        -a[..., 20] * b[..., 17] +
        a[..., 21] * b[..., 16] +
        a[..., 22] * b[..., 5] +
        -a[..., 23] * b[..., 4] +
        a[..., 24] * b[..., 3] +
        -a[..., 25] * b[..., 2] +
        -a[..., 26] * b[..., 9] +
        a[..., 27] * b[..., 8] +
        -a[..., 28] * b[..., 7] +
        a[..., 29] * b[..., 6] +
        a[..., 30] * b[..., 0] +
        a[..., 31] * b[..., 1]
    )
    r31 = (
        a[..., 0] * b[..., 31] +
        a[..., 1] * b[..., 30] +
        -a[..., 2] * b[..., 29] +
        a[..., 3] * b[..., 28] +
        -a[..., 4] * b[..., 27] +
        a[..., 5] * b[..., 26] +
        a[..., 6] * b[..., 25] +
        -a[..., 7] * b[..., 24] +
        a[..., 8] * b[..., 23] +
        -a[..., 9] * b[..., 22] +
        a[..., 10] * b[..., 21] +
        -a[..., 11] * b[..., 20] +
        a[..., 12] * b[..., 19] +
        a[..., 13] * b[..., 18] +
        -a[..., 14] * b[..., 17] +
        a[..., 15] * b[..., 16] +
        a[..., 16] * b[..., 15] +
        -a[..., 17] * b[..., 14] +
        a[..., 18] * b[..., 13] +
        a[..., 19] * b[..., 12] +
        -a[..., 20] * b[..., 11] +
        a[..., 21] * b[..., 10] +
        -a[..., 22] * b[..., 9] +
        a[..., 23] * b[..., 8] +
        -a[..., 24] * b[..., 7] +
        a[..., 25] * b[..., 6] +
        a[..., 26] * b[..., 5] +
        -a[..., 27] * b[..., 4] +
        a[..., 28] * b[..., 3] +
        -a[..., 29] * b[..., 2] +
        a[..., 30] * b[..., 1] +
        a[..., 31] * b[..., 0]
    )

    return torch.stack([
        r0, r1, r2, r3, r4, r5, r6, r7,
        r8, r9, r10, r11, r12, r13, r14, r15,
        r16, r17, r18, r19, r20, r21, r22, r23,
        r24, r25, r26, r27, r28, r29, r30, r31,
    ], dim=-1)

# =============================================================================
# Reverse Operation
# =============================================================================

@torch.jit.script
def reverse_full(mv: Tensor) -> Tensor:
    """
    Compute the reverse of a multivector.

    For grade k: coefficient *= (-1)^(k*(k-1)/2)

    Args:
        mv: Input multivector, shape (..., 32)

    Returns:
        Reversed multivector, shape (..., 32)
    """
    r0 = mv[..., 0]
    r1 = mv[..., 1]
    r2 = mv[..., 2]
    r3 = mv[..., 3]
    r4 = mv[..., 4]
    r5 = mv[..., 5]
    r6 = -mv[..., 6]
    r7 = -mv[..., 7]
    r8 = -mv[..., 8]
    r9 = -mv[..., 9]
    r10 = -mv[..., 10]
    r11 = -mv[..., 11]
    r12 = -mv[..., 12]
    r13 = -mv[..., 13]
    r14 = -mv[..., 14]
    r15 = -mv[..., 15]
    r16 = -mv[..., 16]
    r17 = -mv[..., 17]
    r18 = -mv[..., 18]
    r19 = -mv[..., 19]
    r20 = -mv[..., 20]
    r21 = -mv[..., 21]
    r22 = -mv[..., 22]
    r23 = -mv[..., 23]
    r24 = -mv[..., 24]
    r25 = -mv[..., 25]
    r26 = mv[..., 26]
    r27 = mv[..., 27]
    r28 = mv[..., 28]
    r29 = mv[..., 29]
    r30 = mv[..., 30]
    r31 = mv[..., 31]

    return torch.stack([
        r0, r1, r2, r3, r4, r5, r6, r7,
        r8, r9, r10, r11, r12, r13, r14, r15,
        r16, r17, r18, r19, r20, r21, r22, r23,
        r24, r25, r26, r27, r28, r29, r30, r31,
    ], dim=-1)

# =============================================================================
# Sparse Operations (EvenVersor[16] x Point[5])
# =============================================================================

# EvenVersor sparse indices: (0, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 26, 27, 28, 29, 30)
# Point sparse indices: (1, 2, 3, 4, 5)

@torch.jit.script
def upgc_encode(x: Tensor) -> Tensor:
    """
    Encode 3D vector to UPGC point representation.

    X = n_o + x + 0.5|x|^2 * n_inf

    Where:
        n_o = 0.5 * (e- - e+)   -> coefficients: e+ = -0.5, e- = 0.5
        n_inf = e- + e+         -> coefficients: e+ = 1, e- = 1

    Args:
        x: 3D vector, shape (..., 3)

    Returns:
        UPGC point, shape (..., 5)
    """
    x1 = x[..., 0]
    x2 = x[..., 1]
    x3 = x[..., 2]

    half_norm_sq = 0.5 * (x1 * x1 + x2 * x2 + x3 * x3)

    r0 = x1  # e1
    r1 = x2  # e2
    r2 = x3  # e3
    r3 = -0.5 + half_norm_sq  # e+
    r4 = 0.5 + half_norm_sq  # e-

    return torch.stack([r0, r1, r2, r3, r4], dim=-1)


@torch.jit.script
def upgc_decode(point: Tensor) -> Tensor:
    """
    Decode UPGC point to 3D vector.

    Extracts the first 3 components (euclidean part).

    Args:
        point: UPGC point, shape (..., 5)

    Returns:
        3D vector, shape (..., 3)
    """
    return point[..., :3]


@torch.jit.script
def reverse_even_versor(ev: Tensor) -> Tensor:
    """
    Compute reverse of an EvenVersor (sparse 16-component version).

    Args:
        ev: EvenVersor, shape (..., 16)

    Returns:
        Reversed EvenVersor, shape (..., 16)
    """
    r0 = ev[..., 0]  # 1: keep
    r1 = -ev[..., 1]  # e1e2: negate
    r2 = -ev[..., 2]  # e1e3: negate
    r3 = -ev[..., 3]  # e1e+: negate
    r4 = -ev[..., 4]  # e1e-: negate
    r5 = -ev[..., 5]  # e2e3: negate
    r6 = -ev[..., 6]  # e2e+: negate
    r7 = -ev[..., 7]  # e2e-: negate
    r8 = -ev[..., 8]  # e3e+: negate
    r9 = -ev[..., 9]  # e3e-: negate
    r10 = -ev[..., 10]  # e+e-: negate
    r11 = ev[..., 11]  # e1e2e3e+: keep
    r12 = ev[..., 12]  # e1e2e3e-: keep
    r13 = ev[..., 13]  # e1e2e+e-: keep
    r14 = ev[..., 14]  # e1e3e+e-: keep
    r15 = ev[..., 15]  # e2e3e+e-: keep

    return torch.stack([r0, r1, r2, r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, r13, r14, r15], dim=-1)


@torch.jit.script
def sandwich_product_sparse(ev: Tensor, point: Tensor) -> Tensor:
    """
    Compute sparse sandwich product: M × X × M̃

    Optimized for:
        - EvenVersor M: 16 components
        - Point X: 5 components
        - Output: 5 components

    Args:
        ev: EvenVersor, shape (..., 16)
        point: UPGC point, shape (..., 5)

    Returns:
        Transformed point, shape (..., 5)

    Note:
        Total multiplications: 800 (vs 2560 for naive)
    """
    # EvenVersor components (sparse)
    m0 = ev[..., 0]  # 1
    m1 = ev[..., 1]  # e1e2
    m2 = ev[..., 2]  # e1e3
    m3 = ev[..., 3]  # e1e+
    m4 = ev[..., 4]  # e1e-
    m5 = ev[..., 5]  # e2e3
    m6 = ev[..., 6]  # e2e+
    m7 = ev[..., 7]  # e2e-
    m8 = ev[..., 8]  # e3e+
    m9 = ev[..., 9]  # e3e-
    m10 = ev[..., 10]  # e+e-
    m11 = ev[..., 11]  # e1e2e3e+
    m12 = ev[..., 12]  # e1e2e3e-
    m13 = ev[..., 13]  # e1e2e+e-
    m14 = ev[..., 14]  # e1e3e+e-
    m15 = ev[..., 15]  # e2e3e+e-

    # Point components (sparse)
    p0 = point[..., 0]  # e1
    p1 = point[..., 1]  # e2
    p2 = point[..., 2]  # e3
    p3 = point[..., 3]  # e+
    p4 = point[..., 4]  # e-

    # EvenVersor reverse
    mr0 = m0
    mr1 = -m1
    mr2 = -m2
    mr3 = -m3
    mr4 = -m4
    mr5 = -m5
    mr6 = -m6
    mr7 = -m7
    mr8 = -m8
    mr9 = -m9
    mr10 = -m10
    mr11 = m11
    mr12 = m12
    mr13 = m13
    mr14 = m14
    mr15 = m15

    # Output r0 (e1): 80 terms
    r0 = (
        m0 * p0 * mr0 +
        -m0 * p1 * mr1 +
        -m0 * p2 * mr2 +
        -m0 * p3 * mr3 +
        m0 * p4 * mr4 +
        m1 * p0 * mr1 +
        m1 * p1 * mr0 +
        -m1 * p2 * mr5 +
        -m1 * p3 * mr6 +
        m1 * p4 * mr7 +
        m2 * p0 * mr2 +
        m2 * p1 * mr5 +
        m2 * p2 * mr0 +
        -m2 * p3 * mr8 +
        m2 * p4 * mr9 +
        m3 * p0 * mr3 +
        m3 * p1 * mr6 +
        m3 * p2 * mr8 +
        m3 * p3 * mr0 +
        m3 * p4 * mr10 +
        -m4 * p0 * mr4 +
        -m4 * p1 * mr7 +
        -m4 * p2 * mr9 +
        -m4 * p3 * mr10 +
        -m4 * p4 * mr0 +
        -m5 * p0 * mr5 +
        m5 * p1 * mr2 +
        -m5 * p2 * mr1 +
        m5 * p3 * mr11 +
        -m5 * p4 * mr12 +
        -m6 * p0 * mr6 +
        m6 * p1 * mr3 +
        -m6 * p2 * mr11 +
        -m6 * p3 * mr1 +
        -m6 * p4 * mr13 +
        m7 * p0 * mr7 +
        -m7 * p1 * mr4 +
        m7 * p2 * mr12 +
        m7 * p3 * mr13 +
        m7 * p4 * mr1 +
        -m8 * p0 * mr8 +
        m8 * p1 * mr11 +
        m8 * p2 * mr3 +
        -m8 * p3 * mr2 +
        -m8 * p4 * mr14 +
        m9 * p0 * mr9 +
        -m9 * p1 * mr12 +
        -m9 * p2 * mr4 +
        m9 * p3 * mr14 +
        m9 * p4 * mr2 +
        m10 * p0 * mr10 +
        -m10 * p1 * mr13 +
        -m10 * p2 * mr14 +
        -m10 * p3 * mr4 +
        m10 * p4 * mr3 +
        -m11 * p0 * mr11 +
        -m11 * p1 * mr8 +
        m11 * p2 * mr6 +
        -m11 * p3 * mr5 +
        -m11 * p4 * mr15 +
        m12 * p0 * mr12 +
        m12 * p1 * mr9 +
        -m12 * p2 * mr7 +
        m12 * p3 * mr15 +
        m12 * p4 * mr5 +
        m13 * p0 * mr13 +
        m13 * p1 * mr10 +
        -m13 * p2 * mr15 +
        -m13 * p3 * mr7 +
        m13 * p4 * mr6 +
        m14 * p0 * mr14 +
        m14 * p1 * mr15 +
        m14 * p2 * mr10 +
        -m14 * p3 * mr9 +
        m14 * p4 * mr8 +
        -m15 * p0 * mr15 +
        m15 * p1 * mr14 +
        -m15 * p2 * mr13 +
        m15 * p3 * mr12 +
        -m15 * p4 * mr11
    )

    # Output r1 (e2): 80 terms
    r1 = (
        m0 * p0 * mr1 +
        m0 * p1 * mr0 +
        -m0 * p2 * mr5 +
        -m0 * p3 * mr6 +
        m0 * p4 * mr7 +
        -m1 * p0 * mr0 +
        m1 * p1 * mr1 +
        m1 * p2 * mr2 +
        m1 * p3 * mr3 +
        -m1 * p4 * mr4 +
        m2 * p0 * mr5 +
        -m2 * p1 * mr2 +
        m2 * p2 * mr1 +
        -m2 * p3 * mr11 +
        m2 * p4 * mr12 +
        m3 * p0 * mr6 +
        -m3 * p1 * mr3 +
        m3 * p2 * mr11 +
        m3 * p3 * mr1 +
        m3 * p4 * mr13 +
        -m4 * p0 * mr7 +
        m4 * p1 * mr4 +
        -m4 * p2 * mr12 +
        -m4 * p3 * mr13 +
        -m4 * p4 * mr1 +
        m5 * p0 * mr2 +
        m5 * p1 * mr5 +
        m5 * p2 * mr0 +
        -m5 * p3 * mr8 +
        m5 * p4 * mr9 +
        m6 * p0 * mr3 +
        m6 * p1 * mr6 +
        m6 * p2 * mr8 +
        m6 * p3 * mr0 +
        m6 * p4 * mr10 +
        -m7 * p0 * mr4 +
        -m7 * p1 * mr7 +
        -m7 * p2 * mr9 +
        -m7 * p3 * mr10 +
        -m7 * p4 * mr0 +
        -m8 * p0 * mr11 +
        -m8 * p1 * mr8 +
        m8 * p2 * mr6 +
        -m8 * p3 * mr5 +
        -m8 * p4 * mr15 +
        m9 * p0 * mr12 +
        m9 * p1 * mr9 +
        -m9 * p2 * mr7 +
        m9 * p3 * mr15 +
        m9 * p4 * mr5 +
        m10 * p0 * mr13 +
        m10 * p1 * mr10 +
        -m10 * p2 * mr15 +
        -m10 * p3 * mr7 +
        m10 * p4 * mr6 +
        m11 * p0 * mr8 +
        -m11 * p1 * mr11 +
        -m11 * p2 * mr3 +
        m11 * p3 * mr2 +
        m11 * p4 * mr14 +
        -m12 * p0 * mr9 +
        m12 * p1 * mr12 +
        m12 * p2 * mr4 +
        -m12 * p3 * mr14 +
        -m12 * p4 * mr2 +
        -m13 * p0 * mr10 +
        m13 * p1 * mr13 +
        m13 * p2 * mr14 +
        m13 * p3 * mr4 +
        -m13 * p4 * mr3 +
        m14 * p0 * mr15 +
        -m14 * p1 * mr14 +
        m14 * p2 * mr13 +
        -m14 * p3 * mr12 +
        m14 * p4 * mr11 +
        m15 * p0 * mr14 +
        m15 * p1 * mr15 +
        m15 * p2 * mr10 +
        -m15 * p3 * mr9 +
        m15 * p4 * mr8
    )

    # Output r2 (e3): 80 terms
    r2 = (
        m0 * p0 * mr2 +
        m0 * p1 * mr5 +
        m0 * p2 * mr0 +
        -m0 * p3 * mr8 +
        m0 * p4 * mr9 +
        -m1 * p0 * mr5 +
        m1 * p1 * mr2 +
        -m1 * p2 * mr1 +
        m1 * p3 * mr11 +
        -m1 * p4 * mr12 +
        -m2 * p0 * mr0 +
        m2 * p1 * mr1 +
        m2 * p2 * mr2 +
        m2 * p3 * mr3 +
        -m2 * p4 * mr4 +
        m3 * p0 * mr8 +
        -m3 * p1 * mr11 +
        -m3 * p2 * mr3 +
        m3 * p3 * mr2 +
        m3 * p4 * mr14 +
        -m4 * p0 * mr9 +
        m4 * p1 * mr12 +
        m4 * p2 * mr4 +
        -m4 * p3 * mr14 +
        -m4 * p4 * mr2 +
        -m5 * p0 * mr1 +
        -m5 * p1 * mr0 +
        m5 * p2 * mr5 +
        m5 * p3 * mr6 +
        -m5 * p4 * mr7 +
        m6 * p0 * mr11 +
        m6 * p1 * mr8 +
        -m6 * p2 * mr6 +
        m6 * p3 * mr5 +
        m6 * p4 * mr15 +
        -m7 * p0 * mr12 +
        -m7 * p1 * mr9 +
        m7 * p2 * mr7 +
        -m7 * p3 * mr15 +
        -m7 * p4 * mr5 +
        m8 * p0 * mr3 +
        m8 * p1 * mr6 +
        m8 * p2 * mr8 +
        m8 * p3 * mr0 +
        m8 * p4 * mr10 +
        -m9 * p0 * mr4 +
        -m9 * p1 * mr7 +
        -m9 * p2 * mr9 +
        -m9 * p3 * mr10 +
        -m9 * p4 * mr0 +
        m10 * p0 * mr14 +
        m10 * p1 * mr15 +
        m10 * p2 * mr10 +
        -m10 * p3 * mr9 +
        m10 * p4 * mr8 +
        -m11 * p0 * mr6 +
        m11 * p1 * mr3 +
        -m11 * p2 * mr11 +
        -m11 * p3 * mr1 +
        -m11 * p4 * mr13 +
        m12 * p0 * mr7 +
        -m12 * p1 * mr4 +
        m12 * p2 * mr12 +
        m12 * p3 * mr13 +
        m12 * p4 * mr1 +
        -m13 * p0 * mr15 +
        m13 * p1 * mr14 +
        -m13 * p2 * mr13 +
        m13 * p3 * mr12 +
        -m13 * p4 * mr11 +
        -m14 * p0 * mr10 +
        m14 * p1 * mr13 +
        m14 * p2 * mr14 +
        m14 * p3 * mr4 +
        -m14 * p4 * mr3 +
        -m15 * p0 * mr13 +
        -m15 * p1 * mr10 +
        m15 * p2 * mr15 +
        m15 * p3 * mr7 +
        -m15 * p4 * mr6
    )

    # Output r3 (e+): 80 terms
    r3 = (
        m0 * p0 * mr3 +
        m0 * p1 * mr6 +
        m0 * p2 * mr8 +
        m0 * p3 * mr0 +
        m0 * p4 * mr10 +
        -m1 * p0 * mr6 +
        m1 * p1 * mr3 +
        -m1 * p2 * mr11 +
        -m1 * p3 * mr1 +
        -m1 * p4 * mr13 +
        -m2 * p0 * mr8 +
        m2 * p1 * mr11 +
        m2 * p2 * mr3 +
        -m2 * p3 * mr2 +
        -m2 * p4 * mr14 +
        -m3 * p0 * mr0 +
        m3 * p1 * mr1 +
        m3 * p2 * mr2 +
        m3 * p3 * mr3 +
        -m3 * p4 * mr4 +
        -m4 * p0 * mr10 +
        m4 * p1 * mr13 +
        m4 * p2 * mr14 +
        m4 * p3 * mr4 +
        -m4 * p4 * mr3 +
        -m5 * p0 * mr11 +
        -m5 * p1 * mr8 +
        m5 * p2 * mr6 +
        -m5 * p3 * mr5 +
        -m5 * p4 * mr15 +
        -m6 * p0 * mr1 +
        -m6 * p1 * mr0 +
        m6 * p2 * mr5 +
        m6 * p3 * mr6 +
        -m6 * p4 * mr7 +
        -m7 * p0 * mr13 +
        -m7 * p1 * mr10 +
        m7 * p2 * mr15 +
        m7 * p3 * mr7 +
        -m7 * p4 * mr6 +
        -m8 * p0 * mr2 +
        -m8 * p1 * mr5 +
        -m8 * p2 * mr0 +
        m8 * p3 * mr8 +
        -m8 * p4 * mr9 +
        -m9 * p0 * mr14 +
        -m9 * p1 * mr15 +
        -m9 * p2 * mr10 +
        m9 * p3 * mr9 +
        -m9 * p4 * mr8 +
        -m10 * p0 * mr4 +
        -m10 * p1 * mr7 +
        -m10 * p2 * mr9 +
        -m10 * p3 * mr10 +
        -m10 * p4 * mr0 +
        m11 * p0 * mr5 +
        -m11 * p1 * mr2 +
        m11 * p2 * mr1 +
        -m11 * p3 * mr11 +
        m11 * p4 * mr12 +
        m12 * p0 * mr15 +
        -m12 * p1 * mr14 +
        m12 * p2 * mr13 +
        -m12 * p3 * mr12 +
        m12 * p4 * mr11 +
        m13 * p0 * mr7 +
        -m13 * p1 * mr4 +
        m13 * p2 * mr12 +
        m13 * p3 * mr13 +
        m13 * p4 * mr1 +
        m14 * p0 * mr9 +
        -m14 * p1 * mr12 +
        -m14 * p2 * mr4 +
        m14 * p3 * mr14 +
        m14 * p4 * mr2 +
        m15 * p0 * mr12 +
        m15 * p1 * mr9 +
        -m15 * p2 * mr7 +
        m15 * p3 * mr15 +
        m15 * p4 * mr5
    )

    # Output r4 (e-): 80 terms
    r4 = (
        m0 * p0 * mr4 +
        m0 * p1 * mr7 +
        m0 * p2 * mr9 +
        m0 * p3 * mr10 +
        m0 * p4 * mr0 +
        -m1 * p0 * mr7 +
        m1 * p1 * mr4 +
        -m1 * p2 * mr12 +
        -m1 * p3 * mr13 +
        -m1 * p4 * mr1 +
        -m2 * p0 * mr9 +
        m2 * p1 * mr12 +
        m2 * p2 * mr4 +
        -m2 * p3 * mr14 +
        -m2 * p4 * mr2 +
        -m3 * p0 * mr10 +
        m3 * p1 * mr13 +
        m3 * p2 * mr14 +
        m3 * p3 * mr4 +
        -m3 * p4 * mr3 +
        -m4 * p0 * mr0 +
        m4 * p1 * mr1 +
        m4 * p2 * mr2 +
        m4 * p3 * mr3 +
        -m4 * p4 * mr4 +
        -m5 * p0 * mr12 +
        -m5 * p1 * mr9 +
        m5 * p2 * mr7 +
        -m5 * p3 * mr15 +
        -m5 * p4 * mr5 +
        -m6 * p0 * mr13 +
        -m6 * p1 * mr10 +
        m6 * p2 * mr15 +
        m6 * p3 * mr7 +
        -m6 * p4 * mr6 +
        -m7 * p0 * mr1 +
        -m7 * p1 * mr0 +
        m7 * p2 * mr5 +
        m7 * p3 * mr6 +
        -m7 * p4 * mr7 +
        -m8 * p0 * mr14 +
        -m8 * p1 * mr15 +
        -m8 * p2 * mr10 +
        m8 * p3 * mr9 +
        -m8 * p4 * mr8 +
        -m9 * p0 * mr2 +
        -m9 * p1 * mr5 +
        -m9 * p2 * mr0 +
        m9 * p3 * mr8 +
        -m9 * p4 * mr9 +
        -m10 * p0 * mr3 +
        -m10 * p1 * mr6 +
        -m10 * p2 * mr8 +
        -m10 * p3 * mr0 +
        -m10 * p4 * mr10 +
        m11 * p0 * mr15 +
        -m11 * p1 * mr14 +
        m11 * p2 * mr13 +
        -m11 * p3 * mr12 +
        m11 * p4 * mr11 +
        m12 * p0 * mr5 +
        -m12 * p1 * mr2 +
        m12 * p2 * mr1 +
        -m12 * p3 * mr11 +
        m12 * p4 * mr12 +
        m13 * p0 * mr6 +
        -m13 * p1 * mr3 +
        m13 * p2 * mr11 +
        m13 * p3 * mr1 +
        m13 * p4 * mr13 +
        m14 * p0 * mr8 +
        -m14 * p1 * mr11 +
        -m14 * p2 * mr3 +
        m14 * p3 * mr2 +
        m14 * p4 * mr14 +
        m15 * p0 * mr11 +
        m15 * p1 * mr8 +
        -m15 * p2 * mr6 +
        m15 * p3 * mr5 +
        m15 * p4 * mr15
    )

    return torch.stack([r0, r1, r2, r3, r4], dim=-1)


# =============================================================================
# EvenVersor Composition
# =============================================================================

@torch.jit.script
def compose_even_versor(v1: Tensor, v2: Tensor) -> Tensor:
    """
    Compose two EvenVersors via geometric product.

    Args:
        v1: First EvenVersor, shape (..., 16)
        v2: Second EvenVersor, shape (..., 16)

    Returns:
        Composed EvenVersor, shape (..., 16)
    """
    # v1 components
    v1_0 = v1[..., 0]  # 1
    v1_1 = v1[..., 1]  # e1e2
    v1_2 = v1[..., 2]  # e1e3
    v1_3 = v1[..., 3]  # e1e+
    v1_4 = v1[..., 4]  # e1e-
    v1_5 = v1[..., 5]  # e2e3
    v1_6 = v1[..., 6]  # e2e+
    v1_7 = v1[..., 7]  # e2e-
    v1_8 = v1[..., 8]  # e3e+
    v1_9 = v1[..., 9]  # e3e-
    v1_10 = v1[..., 10]  # e+e-
    v1_11 = v1[..., 11]  # e1e2e3e+
    v1_12 = v1[..., 12]  # e1e2e3e-
    v1_13 = v1[..., 13]  # e1e2e+e-
    v1_14 = v1[..., 14]  # e1e3e+e-
    v1_15 = v1[..., 15]  # e2e3e+e-

    # v2 components
    v2_0 = v2[..., 0]  # 1
    v2_1 = v2[..., 1]  # e1e2
    v2_2 = v2[..., 2]  # e1e3
    v2_3 = v2[..., 3]  # e1e+
    v2_4 = v2[..., 4]  # e1e-
    v2_5 = v2[..., 5]  # e2e3
    v2_6 = v2[..., 6]  # e2e+
    v2_7 = v2[..., 7]  # e2e-
    v2_8 = v2[..., 8]  # e3e+
    v2_9 = v2[..., 9]  # e3e-
    v2_10 = v2[..., 10]  # e+e-
    v2_11 = v2[..., 11]  # e1e2e3e+
    v2_12 = v2[..., 12]  # e1e2e3e-
    v2_13 = v2[..., 13]  # e1e2e+e-
    v2_14 = v2[..., 14]  # e1e3e+e-
    v2_15 = v2[..., 15]  # e2e3e+e-

    # r0 (1): 16 terms
    r0 = (
        v1_0 * v2_0 +
        -v1_1 * v2_1 +
        -v1_2 * v2_2 +
        -v1_3 * v2_3 +
        v1_4 * v2_4 +
        -v1_5 * v2_5 +
        -v1_6 * v2_6 +
        v1_7 * v2_7 +
        -v1_8 * v2_8 +
        v1_9 * v2_9 +
        v1_10 * v2_10 +
        v1_11 * v2_11 +
        -v1_12 * v2_12 +
        -v1_13 * v2_13 +
        -v1_14 * v2_14 +
        -v1_15 * v2_15
    )
    # r1 (e1e2): 16 terms
    r1 = (
        v1_0 * v2_1 +
        v1_1 * v2_0 +
        -v1_2 * v2_5 +
        -v1_3 * v2_6 +
        v1_4 * v2_7 +
        v1_5 * v2_2 +
        v1_6 * v2_3 +
        -v1_7 * v2_4 +
        -v1_8 * v2_11 +
        v1_9 * v2_12 +
        v1_10 * v2_13 +
        -v1_11 * v2_8 +
        v1_12 * v2_9 +
        v1_13 * v2_10 +
        -v1_14 * v2_15 +
        v1_15 * v2_14
    )
    # r2 (e1e3): 16 terms
    r2 = (
        v1_0 * v2_2 +
        v1_1 * v2_5 +
        v1_2 * v2_0 +
        -v1_3 * v2_8 +
        v1_4 * v2_9 +
        -v1_5 * v2_1 +
        v1_6 * v2_11 +
        -v1_7 * v2_12 +
        v1_8 * v2_3 +
        -v1_9 * v2_4 +
        v1_10 * v2_14 +
        v1_11 * v2_6 +
        -v1_12 * v2_7 +
        v1_13 * v2_15 +
        v1_14 * v2_10 +
        -v1_15 * v2_13
    )
    # r3 (e1e+): 16 terms
    r3 = (
        v1_0 * v2_3 +
        v1_1 * v2_6 +
        v1_2 * v2_8 +
        v1_3 * v2_0 +
        v1_4 * v2_10 +
        -v1_5 * v2_11 +
        -v1_6 * v2_1 +
        -v1_7 * v2_13 +
        -v1_8 * v2_2 +
        -v1_9 * v2_14 +
        -v1_10 * v2_4 +
        -v1_11 * v2_5 +
        -v1_12 * v2_15 +
        -v1_13 * v2_7 +
        -v1_14 * v2_9 +
        v1_15 * v2_12
    )
    # r4 (e1e-): 16 terms
    r4 = (
        v1_0 * v2_4 +
        v1_1 * v2_7 +
        v1_2 * v2_9 +
        v1_3 * v2_10 +
        v1_4 * v2_0 +
        -v1_5 * v2_12 +
        -v1_6 * v2_13 +
        -v1_7 * v2_1 +
        -v1_8 * v2_14 +
        -v1_9 * v2_2 +
        -v1_10 * v2_3 +
        -v1_11 * v2_15 +
        -v1_12 * v2_5 +
        -v1_13 * v2_6 +
        -v1_14 * v2_8 +
        v1_15 * v2_11
    )
    # r5 (e2e3): 16 terms
    r5 = (
        v1_0 * v2_5 +
        -v1_1 * v2_2 +
        v1_2 * v2_1 +
        -v1_3 * v2_11 +
        v1_4 * v2_12 +
        v1_5 * v2_0 +
        -v1_6 * v2_8 +
        v1_7 * v2_9 +
        v1_8 * v2_6 +
        -v1_9 * v2_7 +
        v1_10 * v2_15 +
        -v1_11 * v2_3 +
        v1_12 * v2_4 +
        -v1_13 * v2_14 +
        v1_14 * v2_13 +
        v1_15 * v2_10
    )
    # r6 (e2e+): 16 terms
    r6 = (
        v1_0 * v2_6 +
        -v1_1 * v2_3 +
        v1_2 * v2_11 +
        v1_3 * v2_1 +
        v1_4 * v2_13 +
        v1_5 * v2_8 +
        v1_6 * v2_0 +
        v1_7 * v2_10 +
        -v1_8 * v2_5 +
        -v1_9 * v2_15 +
        -v1_10 * v2_7 +
        v1_11 * v2_2 +
        v1_12 * v2_14 +
        v1_13 * v2_4 +
        -v1_14 * v2_12 +
        -v1_15 * v2_9
    )
    # r7 (e2e-): 16 terms
    r7 = (
        v1_0 * v2_7 +
        -v1_1 * v2_4 +
        v1_2 * v2_12 +
        v1_3 * v2_13 +
        v1_4 * v2_1 +
        v1_5 * v2_9 +
        v1_6 * v2_10 +
        v1_7 * v2_0 +
        -v1_8 * v2_15 +
        -v1_9 * v2_5 +
        -v1_10 * v2_6 +
        v1_11 * v2_14 +
        v1_12 * v2_2 +
        v1_13 * v2_3 +
        -v1_14 * v2_11 +
        -v1_15 * v2_8
    )
    # r8 (e3e+): 16 terms
    r8 = (
        v1_0 * v2_8 +
        -v1_1 * v2_11 +
        -v1_2 * v2_3 +
        v1_3 * v2_2 +
        v1_4 * v2_14 +
        -v1_5 * v2_6 +
        v1_6 * v2_5 +
        v1_7 * v2_15 +
        v1_8 * v2_0 +
        v1_9 * v2_10 +
        -v1_10 * v2_9 +
        -v1_11 * v2_1 +
        -v1_12 * v2_13 +
        v1_13 * v2_12 +
        v1_14 * v2_4 +
        v1_15 * v2_7
    )
    # r9 (e3e-): 16 terms
    r9 = (
        v1_0 * v2_9 +
        -v1_1 * v2_12 +
        -v1_2 * v2_4 +
        v1_3 * v2_14 +
        v1_4 * v2_2 +
        -v1_5 * v2_7 +
        v1_6 * v2_15 +
        v1_7 * v2_5 +
        v1_8 * v2_10 +
        v1_9 * v2_0 +
        -v1_10 * v2_8 +
        -v1_11 * v2_13 +
        -v1_12 * v2_1 +
        v1_13 * v2_11 +
        v1_14 * v2_3 +
        v1_15 * v2_6
    )
    # r10 (e+e-): 16 terms
    r10 = (
        v1_0 * v2_10 +
        -v1_1 * v2_13 +
        -v1_2 * v2_14 +
        -v1_3 * v2_4 +
        v1_4 * v2_3 +
        -v1_5 * v2_15 +
        -v1_6 * v2_7 +
        v1_7 * v2_6 +
        -v1_8 * v2_9 +
        v1_9 * v2_8 +
        v1_10 * v2_0 +
        v1_11 * v2_12 +
        -v1_12 * v2_11 +
        -v1_13 * v2_1 +
        -v1_14 * v2_2 +
        -v1_15 * v2_5
    )
    # r11 (e1e2e3e+): 16 terms
    r11 = (
        v1_0 * v2_11 +
        v1_1 * v2_8 +
        -v1_2 * v2_6 +
        v1_3 * v2_5 +
        v1_4 * v2_15 +
        v1_5 * v2_3 +
        -v1_6 * v2_2 +
        -v1_7 * v2_14 +
        v1_8 * v2_1 +
        v1_9 * v2_13 +
        -v1_10 * v2_12 +
        v1_11 * v2_0 +
        v1_12 * v2_10 +
        -v1_13 * v2_9 +
        v1_14 * v2_7 +
        -v1_15 * v2_4
    )
    # r12 (e1e2e3e-): 16 terms
    r12 = (
        v1_0 * v2_12 +
        v1_1 * v2_9 +
        -v1_2 * v2_7 +
        v1_3 * v2_15 +
        v1_4 * v2_5 +
        v1_5 * v2_4 +
        -v1_6 * v2_14 +
        -v1_7 * v2_2 +
        v1_8 * v2_13 +
        v1_9 * v2_1 +
        -v1_10 * v2_11 +
        v1_11 * v2_10 +
        v1_12 * v2_0 +
        -v1_13 * v2_8 +
        v1_14 * v2_6 +
        -v1_15 * v2_3
    )
    # r13 (e1e2e+e-): 16 terms
    r13 = (
        v1_0 * v2_13 +
        v1_1 * v2_10 +
        -v1_2 * v2_15 +
        -v1_3 * v2_7 +
        v1_4 * v2_6 +
        v1_5 * v2_14 +
        v1_6 * v2_4 +
        -v1_7 * v2_3 +
        -v1_8 * v2_12 +
        v1_9 * v2_11 +
        v1_10 * v2_1 +
        -v1_11 * v2_9 +
        v1_12 * v2_8 +
        v1_13 * v2_0 +
        -v1_14 * v2_5 +
        v1_15 * v2_2
    )
    # r14 (e1e3e+e-): 16 terms
    r14 = (
        v1_0 * v2_14 +
        v1_1 * v2_15 +
        v1_2 * v2_10 +
        -v1_3 * v2_9 +
        v1_4 * v2_8 +
        -v1_5 * v2_13 +
        v1_6 * v2_12 +
        -v1_7 * v2_11 +
        v1_8 * v2_4 +
        -v1_9 * v2_3 +
        v1_10 * v2_2 +
        v1_11 * v2_7 +
        -v1_12 * v2_6 +
        v1_13 * v2_5 +
        v1_14 * v2_0 +
        -v1_15 * v2_1
    )
    # r15 (e2e3e+e-): 16 terms
    r15 = (
        v1_0 * v2_15 +
        -v1_1 * v2_14 +
        v1_2 * v2_13 +
        -v1_3 * v2_12 +
        v1_4 * v2_11 +
        v1_5 * v2_10 +
        -v1_6 * v2_9 +
        v1_7 * v2_8 +
        v1_8 * v2_7 +
        -v1_9 * v2_6 +
        v1_10 * v2_5 +
        -v1_11 * v2_4 +
        v1_12 * v2_3 +
        -v1_13 * v2_2 +
        v1_14 * v2_1 +
        v1_15 * v2_0
    )

    return torch.stack([r0, r1, r2, r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, r13, r14, r15], dim=-1)

# =============================================================================
# Similitude Composition (CGA-specific accelerated)
# =============================================================================

@torch.jit.script
def compose_similitude(s1: Tensor, s2: Tensor) -> Tensor:
    """
    Compose two Similitudes via optimized geometric product.

    Similitude constraint: ei+ = ei- (translation components equal)
    This allows 30-50% speedup over general EvenVersor composition.

    Args:
        s1: First Similitude, shape (..., 16)
        s2: Second Similitude, shape (..., 16)

    Returns:
        Composed Similitude, shape (..., 16)
    """
    # Note: Currently same as compose_even_versor
    # Future optimization: exploit ei+ = ei- constraint
    # s1 components
    s1_0 = s1[..., 0]  # 1
    s1_1 = s1[..., 1]  # e1e2
    s1_2 = s1[..., 2]  # e1e3
    s1_3 = s1[..., 3]  # e1e+
    s1_4 = s1[..., 4]  # e1e-
    s1_5 = s1[..., 5]  # e2e3
    s1_6 = s1[..., 6]  # e2e+
    s1_7 = s1[..., 7]  # e2e-
    s1_8 = s1[..., 8]  # e3e+
    s1_9 = s1[..., 9]  # e3e-
    s1_10 = s1[..., 10]  # e+e-
    s1_11 = s1[..., 11]  # e1e2e3e+
    s1_12 = s1[..., 12]  # e1e2e3e-
    s1_13 = s1[..., 13]  # e1e2e+e-
    s1_14 = s1[..., 14]  # e1e3e+e-
    s1_15 = s1[..., 15]  # e2e3e+e-

    # s2 components
    s2_0 = s2[..., 0]  # 1
    s2_1 = s2[..., 1]  # e1e2
    s2_2 = s2[..., 2]  # e1e3
    s2_3 = s2[..., 3]  # e1e+
    s2_4 = s2[..., 4]  # e1e-
    s2_5 = s2[..., 5]  # e2e3
    s2_6 = s2[..., 6]  # e2e+
    s2_7 = s2[..., 7]  # e2e-
    s2_8 = s2[..., 8]  # e3e+
    s2_9 = s2[..., 9]  # e3e-
    s2_10 = s2[..., 10]  # e+e-
    s2_11 = s2[..., 11]  # e1e2e3e+
    s2_12 = s2[..., 12]  # e1e2e3e-
    s2_13 = s2[..., 13]  # e1e2e+e-
    s2_14 = s2[..., 14]  # e1e3e+e-
    s2_15 = s2[..., 15]  # e2e3e+e-

    # r0 (1): 16 terms
    r0 = (
        s1_0 * s2_0 +
        -s1_1 * s2_1 +
        -s1_2 * s2_2 +
        -s1_3 * s2_3 +
        s1_4 * s2_4 +
        -s1_5 * s2_5 +
        -s1_6 * s2_6 +
        s1_7 * s2_7 +
        -s1_8 * s2_8 +
        s1_9 * s2_9 +
        s1_10 * s2_10 +
        s1_11 * s2_11 +
        -s1_12 * s2_12 +
        -s1_13 * s2_13 +
        -s1_14 * s2_14 +
        -s1_15 * s2_15
    )
    # r1 (e1e2): 16 terms
    r1 = (
        s1_0 * s2_1 +
        s1_1 * s2_0 +
        -s1_2 * s2_5 +
        -s1_3 * s2_6 +
        s1_4 * s2_7 +
        s1_5 * s2_2 +
        s1_6 * s2_3 +
        -s1_7 * s2_4 +
        -s1_8 * s2_11 +
        s1_9 * s2_12 +
        s1_10 * s2_13 +
        -s1_11 * s2_8 +
        s1_12 * s2_9 +
        s1_13 * s2_10 +
        -s1_14 * s2_15 +
        s1_15 * s2_14
    )
    # r2 (e1e3): 16 terms
    r2 = (
        s1_0 * s2_2 +
        s1_1 * s2_5 +
        s1_2 * s2_0 +
        -s1_3 * s2_8 +
        s1_4 * s2_9 +
        -s1_5 * s2_1 +
        s1_6 * s2_11 +
        -s1_7 * s2_12 +
        s1_8 * s2_3 +
        -s1_9 * s2_4 +
        s1_10 * s2_14 +
        s1_11 * s2_6 +
        -s1_12 * s2_7 +
        s1_13 * s2_15 +
        s1_14 * s2_10 +
        -s1_15 * s2_13
    )
    # r3 (e1e+): 16 terms
    r3 = (
        s1_0 * s2_3 +
        s1_1 * s2_6 +
        s1_2 * s2_8 +
        s1_3 * s2_0 +
        s1_4 * s2_10 +
        -s1_5 * s2_11 +
        -s1_6 * s2_1 +
        -s1_7 * s2_13 +
        -s1_8 * s2_2 +
        -s1_9 * s2_14 +
        -s1_10 * s2_4 +
        -s1_11 * s2_5 +
        -s1_12 * s2_15 +
        -s1_13 * s2_7 +
        -s1_14 * s2_9 +
        s1_15 * s2_12
    )
    # r4 (e1e-): 16 terms
    r4 = (
        s1_0 * s2_4 +
        s1_1 * s2_7 +
        s1_2 * s2_9 +
        s1_3 * s2_10 +
        s1_4 * s2_0 +
        -s1_5 * s2_12 +
        -s1_6 * s2_13 +
        -s1_7 * s2_1 +
        -s1_8 * s2_14 +
        -s1_9 * s2_2 +
        -s1_10 * s2_3 +
        -s1_11 * s2_15 +
        -s1_12 * s2_5 +
        -s1_13 * s2_6 +
        -s1_14 * s2_8 +
        s1_15 * s2_11
    )
    # r5 (e2e3): 16 terms
    r5 = (
        s1_0 * s2_5 +
        -s1_1 * s2_2 +
        s1_2 * s2_1 +
        -s1_3 * s2_11 +
        s1_4 * s2_12 +
        s1_5 * s2_0 +
        -s1_6 * s2_8 +
        s1_7 * s2_9 +
        s1_8 * s2_6 +
        -s1_9 * s2_7 +
        s1_10 * s2_15 +
        -s1_11 * s2_3 +
        s1_12 * s2_4 +
        -s1_13 * s2_14 +
        s1_14 * s2_13 +
        s1_15 * s2_10
    )
    # r6 (e2e+): 16 terms
    r6 = (
        s1_0 * s2_6 +
        -s1_1 * s2_3 +
        s1_2 * s2_11 +
        s1_3 * s2_1 +
        s1_4 * s2_13 +
        s1_5 * s2_8 +
        s1_6 * s2_0 +
        s1_7 * s2_10 +
        -s1_8 * s2_5 +
        -s1_9 * s2_15 +
        -s1_10 * s2_7 +
        s1_11 * s2_2 +
        s1_12 * s2_14 +
        s1_13 * s2_4 +
        -s1_14 * s2_12 +
        -s1_15 * s2_9
    )
    # r7 (e2e-): 16 terms
    r7 = (
        s1_0 * s2_7 +
        -s1_1 * s2_4 +
        s1_2 * s2_12 +
        s1_3 * s2_13 +
        s1_4 * s2_1 +
        s1_5 * s2_9 +
        s1_6 * s2_10 +
        s1_7 * s2_0 +
        -s1_8 * s2_15 +
        -s1_9 * s2_5 +
        -s1_10 * s2_6 +
        s1_11 * s2_14 +
        s1_12 * s2_2 +
        s1_13 * s2_3 +
        -s1_14 * s2_11 +
        -s1_15 * s2_8
    )
    # r8 (e3e+): 16 terms
    r8 = (
        s1_0 * s2_8 +
        -s1_1 * s2_11 +
        -s1_2 * s2_3 +
        s1_3 * s2_2 +
        s1_4 * s2_14 +
        -s1_5 * s2_6 +
        s1_6 * s2_5 +
        s1_7 * s2_15 +
        s1_8 * s2_0 +
        s1_9 * s2_10 +
        -s1_10 * s2_9 +
        -s1_11 * s2_1 +
        -s1_12 * s2_13 +
        s1_13 * s2_12 +
        s1_14 * s2_4 +
        s1_15 * s2_7
    )
    # r9 (e3e-): 16 terms
    r9 = (
        s1_0 * s2_9 +
        -s1_1 * s2_12 +
        -s1_2 * s2_4 +
        s1_3 * s2_14 +
        s1_4 * s2_2 +
        -s1_5 * s2_7 +
        s1_6 * s2_15 +
        s1_7 * s2_5 +
        s1_8 * s2_10 +
        s1_9 * s2_0 +
        -s1_10 * s2_8 +
        -s1_11 * s2_13 +
        -s1_12 * s2_1 +
        s1_13 * s2_11 +
        s1_14 * s2_3 +
        s1_15 * s2_6
    )
    # r10 (e+e-): 16 terms
    r10 = (
        s1_0 * s2_10 +
        -s1_1 * s2_13 +
        -s1_2 * s2_14 +
        -s1_3 * s2_4 +
        s1_4 * s2_3 +
        -s1_5 * s2_15 +
        -s1_6 * s2_7 +
        s1_7 * s2_6 +
        -s1_8 * s2_9 +
        s1_9 * s2_8 +
        s1_10 * s2_0 +
        s1_11 * s2_12 +
        -s1_12 * s2_11 +
        -s1_13 * s2_1 +
        -s1_14 * s2_2 +
        -s1_15 * s2_5
    )
    # r11 (e1e2e3e+): 16 terms
    r11 = (
        s1_0 * s2_11 +
        s1_1 * s2_8 +
        -s1_2 * s2_6 +
        s1_3 * s2_5 +
        s1_4 * s2_15 +
        s1_5 * s2_3 +
        -s1_6 * s2_2 +
        -s1_7 * s2_14 +
        s1_8 * s2_1 +
        s1_9 * s2_13 +
        -s1_10 * s2_12 +
        s1_11 * s2_0 +
        s1_12 * s2_10 +
        -s1_13 * s2_9 +
        s1_14 * s2_7 +
        -s1_15 * s2_4
    )
    # r12 (e1e2e3e-): 16 terms
    r12 = (
        s1_0 * s2_12 +
        s1_1 * s2_9 +
        -s1_2 * s2_7 +
        s1_3 * s2_15 +
        s1_4 * s2_5 +
        s1_5 * s2_4 +
        -s1_6 * s2_14 +
        -s1_7 * s2_2 +
        s1_8 * s2_13 +
        s1_9 * s2_1 +
        -s1_10 * s2_11 +
        s1_11 * s2_10 +
        s1_12 * s2_0 +
        -s1_13 * s2_8 +
        s1_14 * s2_6 +
        -s1_15 * s2_3
    )
    # r13 (e1e2e+e-): 16 terms
    r13 = (
        s1_0 * s2_13 +
        s1_1 * s2_10 +
        -s1_2 * s2_15 +
        -s1_3 * s2_7 +
        s1_4 * s2_6 +
        s1_5 * s2_14 +
        s1_6 * s2_4 +
        -s1_7 * s2_3 +
        -s1_8 * s2_12 +
        s1_9 * s2_11 +
        s1_10 * s2_1 +
        -s1_11 * s2_9 +
        s1_12 * s2_8 +
        s1_13 * s2_0 +
        -s1_14 * s2_5 +
        s1_15 * s2_2
    )
    # r14 (e1e3e+e-): 16 terms
    r14 = (
        s1_0 * s2_14 +
        s1_1 * s2_15 +
        s1_2 * s2_10 +
        -s1_3 * s2_9 +
        s1_4 * s2_8 +
        -s1_5 * s2_13 +
        s1_6 * s2_12 +
        -s1_7 * s2_11 +
        s1_8 * s2_4 +
        -s1_9 * s2_3 +
        s1_10 * s2_2 +
        s1_11 * s2_7 +
        -s1_12 * s2_6 +
        s1_13 * s2_5 +
        s1_14 * s2_0 +
        -s1_15 * s2_1
    )
    # r15 (e2e3e+e-): 16 terms
    r15 = (
        s1_0 * s2_15 +
        -s1_1 * s2_14 +
        s1_2 * s2_13 +
        -s1_3 * s2_12 +
        s1_4 * s2_11 +
        s1_5 * s2_10 +
        -s1_6 * s2_9 +
        s1_7 * s2_8 +
        s1_8 * s2_7 +
        -s1_9 * s2_6 +
        s1_10 * s2_5 +
        -s1_11 * s2_4 +
        s1_12 * s2_3 +
        -s1_13 * s2_2 +
        s1_14 * s2_1 +
        s1_15 * s2_0
    )

    return torch.stack([r0, r1, r2, r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, r13, r14, r15], dim=-1)

# =============================================================================
# Similitude Sandwich Product (CGA-specific accelerated)
# =============================================================================

@torch.jit.script
def sandwich_product_similitude(similitude: Tensor, point: Tensor) -> Tensor:
    """
    Compute sandwich product S × X × ~S for Similitude.

    Faster than sandwich_product_sparse by exploiting Similitude constraints.

    Args:
        similitude: Similitude, shape (..., 16)
        point: UPGC point, shape (..., 5)

    Returns:
        Transformed point, shape (..., 5)
    """
    # Currently delegates to sandwich_product_sparse
    # Future optimization: exploit ei+ = ei- constraint
    return sandwich_product_sparse(similitude, point)

# =============================================================================
# Geometric Inner Product (Metric Inner Product)
# =============================================================================

@torch.jit.script
def inner_product_full(a: Tensor, b: Tensor) -> Tensor:
    """
    Compute geometric inner product with CGA metric.

    Args:
        a: First multivector, shape (..., 32)
        b: Second multivector, shape (..., 32)

    Returns:
        Scalar inner product, shape (..., 1)

    Note:
        Uses fused sign flipping: res = sum(a[i] * b[i] * METRIC_SIGNS[i])
    """
    r = (
        a[..., 0] * b[..., 0] +  # 1² = 1
        a[..., 1] * b[..., 1] +  # e1² = 1
        a[..., 2] * b[..., 2] +  # e2² = 1
        a[..., 3] * b[..., 3] +  # e3² = 1
        a[..., 4] * b[..., 4] +  # e+² = 1
        -a[..., 5] * b[..., 5] +  # e-² = -1
        -a[..., 6] * b[..., 6] +  # e1e2² = -1
        -a[..., 7] * b[..., 7] +  # e1e3² = -1
        -a[..., 8] * b[..., 8] +  # e1e+² = -1
        a[..., 9] * b[..., 9] +  # e1e-² = 1
        -a[..., 10] * b[..., 10] +  # e2e3² = -1
        -a[..., 11] * b[..., 11] +  # e2e+² = -1
        a[..., 12] * b[..., 12] +  # e2e-² = 1
        -a[..., 13] * b[..., 13] +  # e3e+² = -1
        a[..., 14] * b[..., 14] +  # e3e-² = 1
        a[..., 15] * b[..., 15] +  # e+e-² = 1
        -a[..., 16] * b[..., 16] +  # e1e2e3² = -1
        -a[..., 17] * b[..., 17] +  # e1e2e+² = -1
        a[..., 18] * b[..., 18] +  # e1e2e-² = 1
        -a[..., 19] * b[..., 19] +  # e1e3e+² = -1
        a[..., 20] * b[..., 20] +  # e1e3e-² = 1
        a[..., 21] * b[..., 21] +  # e1e+e-² = 1
        -a[..., 22] * b[..., 22] +  # e2e3e+² = -1
        a[..., 23] * b[..., 23] +  # e2e3e-² = 1
        a[..., 24] * b[..., 24] +  # e2e+e-² = 1
        a[..., 25] * b[..., 25] +  # e3e+e-² = 1
        a[..., 26] * b[..., 26] +  # e1e2e3e+² = 1
        -a[..., 27] * b[..., 27] +  # e1e2e3e-² = -1
        -a[..., 28] * b[..., 28] +  # e1e2e+e-² = -1
        -a[..., 29] * b[..., 29] +  # e1e3e+e-² = -1
        -a[..., 30] * b[..., 30] +  # e2e3e+e-² = -1
        -a[..., 31] * b[..., 31]  # e1e2e3e+e-² = -1
    )
    return r.unsqueeze(-1)

# =============================================================================
# Bivector Squared Scalar (Helper for exp_bivector)
# =============================================================================

@torch.jit.script
def bivector_squared_scalar(B: Tensor) -> Tensor:
    """
    Compute the scalar part of B².

    Args:
        B: Bivector, shape (..., 10)

    Returns:
        Scalar B² value, shape (...,)
    """
    r = (
        -B[..., 0] * B[..., 0] +
        -B[..., 1] * B[..., 1] +
        -B[..., 2] * B[..., 2] +
        B[..., 3] * B[..., 3] +
        -B[..., 4] * B[..., 4] +
        -B[..., 5] * B[..., 5] +
        B[..., 6] * B[..., 6] +
        -B[..., 7] * B[..., 7] +
        B[..., 8] * B[..., 8] +
        B[..., 9] * B[..., 9]
    )
    return r

# =============================================================================
# Bivector Exponential Map
# =============================================================================

@torch.jit.script
def exp_bivector(B: Tensor) -> Tensor:
    """
    Compute exponential map from Bivector to EvenVersor.

    exp(B) = cos(θ) + sinc(θ) * B
    where θ² = -B² (for rotation bivectors)

    Args:
        B: Bivector, shape (..., 10)

    Returns:
        EvenVersor, shape (..., 16)

    Note:
        Uses torch.sinc for numerical stability at θ→0
    """
    # Compute B² scalar
    B_sq = bivector_squared_scalar(B)

    # θ² = -B² (for rotation bivectors, B² is negative)
    theta_sq = torch.clamp(-B_sq, min=1e-12)
    theta = torch.sqrt(theta_sq)

    # cos(θ) and sinc(θ) = sin(θ)/θ
    cos_theta = torch.cos(theta)
    # torch.sinc(x) = sin(πx)/(πx), so sinc(θ/π) = sin(θ)/θ
    sinc_theta = torch.sinc(theta / 3.141592653589793)

    # Build even_versor: scalar part = cos(θ), bivector parts = sinc(θ) * B
    r0 = cos_theta  # 1
    r1 = sinc_theta * B[..., 0]  # e1e2
    r2 = sinc_theta * B[..., 1]  # e1e3
    r3 = sinc_theta * B[..., 2]  # e1e+
    r4 = sinc_theta * B[..., 3]  # e1e-
    r5 = sinc_theta * B[..., 4]  # e2e3
    r6 = sinc_theta * B[..., 5]  # e2e+
    r7 = sinc_theta * B[..., 6]  # e2e-
    r8 = sinc_theta * B[..., 7]  # e3e+
    r9 = sinc_theta * B[..., 8]  # e3e-
    r10 = sinc_theta * B[..., 9]  # e+e-
    r11 = torch.zeros_like(cos_theta)  # e1e2e3e+
    r12 = torch.zeros_like(cos_theta)  # e1e2e3e-
    r13 = torch.zeros_like(cos_theta)  # e1e2e+e-
    r14 = torch.zeros_like(cos_theta)  # e1e3e+e-
    r15 = torch.zeros_like(cos_theta)  # e2e3e+e-

    return torch.stack([r0, r1, r2, r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, r13, r14, r15], dim=-1)

# =============================================================================
# Outer Product (Wedge Product)
# =============================================================================

@torch.jit.script
def outer_product_full(a: Tensor, b: Tensor) -> Tensor:
    """
    Compute outer product (wedge product).

    a ∧ b = <a * b>_{grade(a) + grade(b)}

    Args:
        a: First multivector, shape (..., 32)
        b: Second multivector, shape (..., 32)

    Returns:
        Wedge product, shape (..., 32)
    """
    r0 = a[..., 0] * b[..., 0]  # 1
    r1 = a[..., 0] * b[..., 1] + a[..., 1] * b[..., 0]  # e1
    r2 = a[..., 0] * b[..., 2] + a[..., 2] * b[..., 0]  # e2
    r3 = a[..., 0] * b[..., 3] + a[..., 3] * b[..., 0]  # e3
    r4 = a[..., 0] * b[..., 4] + a[..., 4] * b[..., 0]  # e+
    r5 = a[..., 0] * b[..., 5] + a[..., 5] * b[..., 0]  # e-
    r6 = (  # e1e2
        a[..., 0] * b[..., 6] +
        a[..., 1] * b[..., 2] +
        -a[..., 2] * b[..., 1] +
        a[..., 6] * b[..., 0]
    )
    r7 = (  # e1e3
        a[..., 0] * b[..., 7] +
        a[..., 1] * b[..., 3] +
        -a[..., 3] * b[..., 1] +
        a[..., 7] * b[..., 0]
    )
    r8 = (  # e1e+
        a[..., 0] * b[..., 8] +
        a[..., 1] * b[..., 4] +
        -a[..., 4] * b[..., 1] +
        a[..., 8] * b[..., 0]
    )
    r9 = (  # e1e-
        a[..., 0] * b[..., 9] +
        a[..., 1] * b[..., 5] +
        -a[..., 5] * b[..., 1] +
        a[..., 9] * b[..., 0]
    )
    r10 = (  # e2e3
        a[..., 0] * b[..., 10] +
        a[..., 2] * b[..., 3] +
        -a[..., 3] * b[..., 2] +
        a[..., 10] * b[..., 0]
    )
    r11 = (  # e2e+
        a[..., 0] * b[..., 11] +
        a[..., 2] * b[..., 4] +
        -a[..., 4] * b[..., 2] +
        a[..., 11] * b[..., 0]
    )
    r12 = (  # e2e-
        a[..., 0] * b[..., 12] +
        a[..., 2] * b[..., 5] +
        -a[..., 5] * b[..., 2] +
        a[..., 12] * b[..., 0]
    )
    r13 = (  # e3e+
        a[..., 0] * b[..., 13] +
        a[..., 3] * b[..., 4] +
        -a[..., 4] * b[..., 3] +
        a[..., 13] * b[..., 0]
    )
    r14 = (  # e3e-
        a[..., 0] * b[..., 14] +
        a[..., 3] * b[..., 5] +
        -a[..., 5] * b[..., 3] +
        a[..., 14] * b[..., 0]
    )
    r15 = (  # e+e-
        a[..., 0] * b[..., 15] +
        a[..., 4] * b[..., 5] +
        -a[..., 5] * b[..., 4] +
        a[..., 15] * b[..., 0]
    )
    r16 = (  # e1e2e3
        a[..., 0] * b[..., 16] +
        a[..., 1] * b[..., 10] +
        -a[..., 2] * b[..., 7] +
        a[..., 3] * b[..., 6] +
        a[..., 6] * b[..., 3] +
        -a[..., 7] * b[..., 2] +
        a[..., 10] * b[..., 1] +
        a[..., 16] * b[..., 0]
    )
    r17 = (  # e1e2e+
        a[..., 0] * b[..., 17] +
        a[..., 1] * b[..., 11] +
        -a[..., 2] * b[..., 8] +
        a[..., 4] * b[..., 6] +
        a[..., 6] * b[..., 4] +
        -a[..., 8] * b[..., 2] +
        a[..., 11] * b[..., 1] +
        a[..., 17] * b[..., 0]
    )
    r18 = (  # e1e2e-
        a[..., 0] * b[..., 18] +
        a[..., 1] * b[..., 12] +
        -a[..., 2] * b[..., 9] +
        a[..., 5] * b[..., 6] +
        a[..., 6] * b[..., 5] +
        -a[..., 9] * b[..., 2] +
        a[..., 12] * b[..., 1] +
        a[..., 18] * b[..., 0]
    )
    r19 = (  # e1e3e+
        a[..., 0] * b[..., 19] +
        a[..., 1] * b[..., 13] +
        -a[..., 3] * b[..., 8] +
        a[..., 4] * b[..., 7] +
        a[..., 7] * b[..., 4] +
        -a[..., 8] * b[..., 3] +
        a[..., 13] * b[..., 1] +
        a[..., 19] * b[..., 0]
    )
    r20 = (  # e1e3e-
        a[..., 0] * b[..., 20] +
        a[..., 1] * b[..., 14] +
        -a[..., 3] * b[..., 9] +
        a[..., 5] * b[..., 7] +
        a[..., 7] * b[..., 5] +
        -a[..., 9] * b[..., 3] +
        a[..., 14] * b[..., 1] +
        a[..., 20] * b[..., 0]
    )
    r21 = (  # e1e+e-
        a[..., 0] * b[..., 21] +
        a[..., 1] * b[..., 15] +
        -a[..., 4] * b[..., 9] +
        a[..., 5] * b[..., 8] +
        a[..., 8] * b[..., 5] +
        -a[..., 9] * b[..., 4] +
        a[..., 15] * b[..., 1] +
        a[..., 21] * b[..., 0]
    )
    r22 = (  # e2e3e+
        a[..., 0] * b[..., 22] +
        a[..., 2] * b[..., 13] +
        -a[..., 3] * b[..., 11] +
        a[..., 4] * b[..., 10] +
        a[..., 10] * b[..., 4] +
        -a[..., 11] * b[..., 3] +
        a[..., 13] * b[..., 2] +
        a[..., 22] * b[..., 0]
    )
    r23 = (  # e2e3e-
        a[..., 0] * b[..., 23] +
        a[..., 2] * b[..., 14] +
        -a[..., 3] * b[..., 12] +
        a[..., 5] * b[..., 10] +
        a[..., 10] * b[..., 5] +
        -a[..., 12] * b[..., 3] +
        a[..., 14] * b[..., 2] +
        a[..., 23] * b[..., 0]
    )
    r24 = (  # e2e+e-
        a[..., 0] * b[..., 24] +
        a[..., 2] * b[..., 15] +
        -a[..., 4] * b[..., 12] +
        a[..., 5] * b[..., 11] +
        a[..., 11] * b[..., 5] +
        -a[..., 12] * b[..., 4] +
        a[..., 15] * b[..., 2] +
        a[..., 24] * b[..., 0]
    )
    r25 = (  # e3e+e-
        a[..., 0] * b[..., 25] +
        a[..., 3] * b[..., 15] +
        -a[..., 4] * b[..., 14] +
        a[..., 5] * b[..., 13] +
        a[..., 13] * b[..., 5] +
        -a[..., 14] * b[..., 4] +
        a[..., 15] * b[..., 3] +
        a[..., 25] * b[..., 0]
    )
    r26 = (  # e1e2e3e+
        a[..., 0] * b[..., 26] +
        a[..., 1] * b[..., 22] +
        -a[..., 2] * b[..., 19] +
        a[..., 3] * b[..., 17] +
        -a[..., 4] * b[..., 16] +
        a[..., 6] * b[..., 13] +
        -a[..., 7] * b[..., 11] +
        a[..., 8] * b[..., 10] +
        a[..., 10] * b[..., 8] +
        -a[..., 11] * b[..., 7] +
        a[..., 13] * b[..., 6] +
        a[..., 16] * b[..., 4] +
        -a[..., 17] * b[..., 3] +
        a[..., 19] * b[..., 2] +
        -a[..., 22] * b[..., 1] +
        a[..., 26] * b[..., 0]
    )
    r27 = (  # e1e2e3e-
        a[..., 0] * b[..., 27] +
        a[..., 1] * b[..., 23] +
        -a[..., 2] * b[..., 20] +
        a[..., 3] * b[..., 18] +
        -a[..., 5] * b[..., 16] +
        a[..., 6] * b[..., 14] +
        -a[..., 7] * b[..., 12] +
        a[..., 9] * b[..., 10] +
        a[..., 10] * b[..., 9] +
        -a[..., 12] * b[..., 7] +
        a[..., 14] * b[..., 6] +
        a[..., 16] * b[..., 5] +
        -a[..., 18] * b[..., 3] +
        a[..., 20] * b[..., 2] +
        -a[..., 23] * b[..., 1] +
        a[..., 27] * b[..., 0]
    )
    r28 = (  # e1e2e+e-
        a[..., 0] * b[..., 28] +
        a[..., 1] * b[..., 24] +
        -a[..., 2] * b[..., 21] +
        a[..., 4] * b[..., 18] +
        -a[..., 5] * b[..., 17] +
        a[..., 6] * b[..., 15] +
        -a[..., 8] * b[..., 12] +
        a[..., 9] * b[..., 11] +
        a[..., 11] * b[..., 9] +
        -a[..., 12] * b[..., 8] +
        a[..., 15] * b[..., 6] +
        a[..., 17] * b[..., 5] +
        -a[..., 18] * b[..., 4] +
        a[..., 21] * b[..., 2] +
        -a[..., 24] * b[..., 1] +
        a[..., 28] * b[..., 0]
    )
    r29 = (  # e1e3e+e-
        a[..., 0] * b[..., 29] +
        a[..., 1] * b[..., 25] +
        -a[..., 3] * b[..., 21] +
        a[..., 4] * b[..., 20] +
        -a[..., 5] * b[..., 19] +
        a[..., 7] * b[..., 15] +
        -a[..., 8] * b[..., 14] +
        a[..., 9] * b[..., 13] +
        a[..., 13] * b[..., 9] +
        -a[..., 14] * b[..., 8] +
        a[..., 15] * b[..., 7] +
        a[..., 19] * b[..., 5] +
        -a[..., 20] * b[..., 4] +
        a[..., 21] * b[..., 3] +
        -a[..., 25] * b[..., 1] +
        a[..., 29] * b[..., 0]
    )
    r30 = (  # e2e3e+e-
        a[..., 0] * b[..., 30] +
        a[..., 2] * b[..., 25] +
        -a[..., 3] * b[..., 24] +
        a[..., 4] * b[..., 23] +
        -a[..., 5] * b[..., 22] +
        a[..., 10] * b[..., 15] +
        -a[..., 11] * b[..., 14] +
        a[..., 12] * b[..., 13] +
        a[..., 13] * b[..., 12] +
        -a[..., 14] * b[..., 11] +
        a[..., 15] * b[..., 10] +
        a[..., 22] * b[..., 5] +
        -a[..., 23] * b[..., 4] +
        a[..., 24] * b[..., 3] +
        -a[..., 25] * b[..., 2] +
        a[..., 30] * b[..., 0]
    )
    r31 = (  # e1e2e3e+e-
        a[..., 0] * b[..., 31] +
        a[..., 1] * b[..., 30] +
        -a[..., 2] * b[..., 29] +
        a[..., 3] * b[..., 28] +
        -a[..., 4] * b[..., 27] +
        a[..., 5] * b[..., 26] +
        a[..., 6] * b[..., 25] +
        -a[..., 7] * b[..., 24] +
        a[..., 8] * b[..., 23] +
        -a[..., 9] * b[..., 22] +
        a[..., 10] * b[..., 21] +
        -a[..., 11] * b[..., 20] +
        a[..., 12] * b[..., 19] +
        a[..., 13] * b[..., 18] +
        -a[..., 14] * b[..., 17] +
        a[..., 15] * b[..., 16] +
        a[..., 16] * b[..., 15] +
        -a[..., 17] * b[..., 14] +
        a[..., 18] * b[..., 13] +
        a[..., 19] * b[..., 12] +
        -a[..., 20] * b[..., 11] +
        a[..., 21] * b[..., 10] +
        -a[..., 22] * b[..., 9] +
        a[..., 23] * b[..., 8] +
        -a[..., 24] * b[..., 7] +
        a[..., 25] * b[..., 6] +
        a[..., 26] * b[..., 5] +
        -a[..., 27] * b[..., 4] +
        a[..., 28] * b[..., 3] +
        -a[..., 29] * b[..., 2] +
        a[..., 30] * b[..., 1] +
        a[..., 31] * b[..., 0]
    )

    return torch.stack([
        r0, r1, r2, r3, r4, r5, r6, r7,
        r8, r9, r10, r11, r12, r13, r14, r15,
        r16, r17, r18, r19, r20, r21, r22, r23,
        r24, r25, r26, r27, r28, r29, r30, r31,
    ], dim=-1)

# =============================================================================
# Left Contraction
# =============================================================================

@torch.jit.script
def left_contraction_full(a: Tensor, b: Tensor) -> Tensor:
    """
    Compute left contraction.

    a ⌋ b = <a * b>_{grade(b) - grade(a)} if grade(a) <= grade(b), else 0

    Args:
        a: First multivector, shape (..., 32)
        b: Second multivector, shape (..., 32)

    Returns:
        Left contraction result, shape (..., 32)
    """
    r0 = (  # 1
        a[..., 0] * b[..., 0] +
        a[..., 1] * b[..., 1] +
        a[..., 2] * b[..., 2] +
        a[..., 3] * b[..., 3] +
        a[..., 4] * b[..., 4] +
        -a[..., 5] * b[..., 5] +
        -a[..., 6] * b[..., 6] +
        -a[..., 7] * b[..., 7] +
        -a[..., 8] * b[..., 8] +
        a[..., 9] * b[..., 9] +
        -a[..., 10] * b[..., 10] +
        -a[..., 11] * b[..., 11] +
        a[..., 12] * b[..., 12] +
        -a[..., 13] * b[..., 13] +
        a[..., 14] * b[..., 14] +
        a[..., 15] * b[..., 15] +
        -a[..., 16] * b[..., 16] +
        -a[..., 17] * b[..., 17] +
        a[..., 18] * b[..., 18] +
        -a[..., 19] * b[..., 19] +
        a[..., 20] * b[..., 20] +
        a[..., 21] * b[..., 21] +
        -a[..., 22] * b[..., 22] +
        a[..., 23] * b[..., 23] +
        a[..., 24] * b[..., 24] +
        a[..., 25] * b[..., 25] +
        a[..., 26] * b[..., 26] +
        -a[..., 27] * b[..., 27] +
        -a[..., 28] * b[..., 28] +
        -a[..., 29] * b[..., 29] +
        -a[..., 30] * b[..., 30] +
        -a[..., 31] * b[..., 31]
    )
    r1 = (  # e1
        a[..., 0] * b[..., 1] +
        -a[..., 2] * b[..., 6] +
        -a[..., 3] * b[..., 7] +
        -a[..., 4] * b[..., 8] +
        a[..., 5] * b[..., 9] +
        -a[..., 10] * b[..., 16] +
        -a[..., 11] * b[..., 17] +
        a[..., 12] * b[..., 18] +
        -a[..., 13] * b[..., 19] +
        a[..., 14] * b[..., 20] +
        a[..., 15] * b[..., 21] +
        a[..., 22] * b[..., 26] +
        -a[..., 23] * b[..., 27] +
        -a[..., 24] * b[..., 28] +
        -a[..., 25] * b[..., 29] +
        -a[..., 30] * b[..., 31]
    )
    r2 = (  # e2
        a[..., 0] * b[..., 2] +
        a[..., 1] * b[..., 6] +
        -a[..., 3] * b[..., 10] +
        -a[..., 4] * b[..., 11] +
        a[..., 5] * b[..., 12] +
        a[..., 7] * b[..., 16] +
        a[..., 8] * b[..., 17] +
        -a[..., 9] * b[..., 18] +
        -a[..., 13] * b[..., 22] +
        a[..., 14] * b[..., 23] +
        a[..., 15] * b[..., 24] +
        -a[..., 19] * b[..., 26] +
        a[..., 20] * b[..., 27] +
        a[..., 21] * b[..., 28] +
        -a[..., 25] * b[..., 30] +
        a[..., 29] * b[..., 31]
    )
    r3 = (  # e3
        a[..., 0] * b[..., 3] +
        a[..., 1] * b[..., 7] +
        a[..., 2] * b[..., 10] +
        -a[..., 4] * b[..., 13] +
        a[..., 5] * b[..., 14] +
        -a[..., 6] * b[..., 16] +
        a[..., 8] * b[..., 19] +
        -a[..., 9] * b[..., 20] +
        a[..., 11] * b[..., 22] +
        -a[..., 12] * b[..., 23] +
        a[..., 15] * b[..., 25] +
        a[..., 17] * b[..., 26] +
        -a[..., 18] * b[..., 27] +
        a[..., 21] * b[..., 29] +
        a[..., 24] * b[..., 30] +
        -a[..., 28] * b[..., 31]
    )
    r4 = (  # e+
        a[..., 0] * b[..., 4] +
        a[..., 1] * b[..., 8] +
        a[..., 2] * b[..., 11] +
        a[..., 3] * b[..., 13] +
        a[..., 5] * b[..., 15] +
        -a[..., 6] * b[..., 17] +
        -a[..., 7] * b[..., 19] +
        -a[..., 9] * b[..., 21] +
        -a[..., 10] * b[..., 22] +
        -a[..., 12] * b[..., 24] +
        -a[..., 14] * b[..., 25] +
        -a[..., 16] * b[..., 26] +
        -a[..., 18] * b[..., 28] +
        -a[..., 20] * b[..., 29] +
        -a[..., 23] * b[..., 30] +
        a[..., 27] * b[..., 31]
    )
    r5 = (  # e-
        a[..., 0] * b[..., 5] +
        a[..., 1] * b[..., 9] +
        a[..., 2] * b[..., 12] +
        a[..., 3] * b[..., 14] +
        a[..., 4] * b[..., 15] +
        -a[..., 6] * b[..., 18] +
        -a[..., 7] * b[..., 20] +
        -a[..., 8] * b[..., 21] +
        -a[..., 10] * b[..., 23] +
        -a[..., 11] * b[..., 24] +
        -a[..., 13] * b[..., 25] +
        -a[..., 16] * b[..., 27] +
        -a[..., 17] * b[..., 28] +
        -a[..., 19] * b[..., 29] +
        -a[..., 22] * b[..., 30] +
        a[..., 26] * b[..., 31]
    )
    r6 = (  # e1e2
        a[..., 0] * b[..., 6] +
        a[..., 3] * b[..., 16] +
        a[..., 4] * b[..., 17] +
        -a[..., 5] * b[..., 18] +
        -a[..., 13] * b[..., 26] +
        a[..., 14] * b[..., 27] +
        a[..., 15] * b[..., 28] +
        a[..., 25] * b[..., 31]
    )
    r7 = (  # e1e3
        a[..., 0] * b[..., 7] +
        -a[..., 2] * b[..., 16] +
        a[..., 4] * b[..., 19] +
        -a[..., 5] * b[..., 20] +
        a[..., 11] * b[..., 26] +
        -a[..., 12] * b[..., 27] +
        a[..., 15] * b[..., 29] +
        -a[..., 24] * b[..., 31]
    )
    r8 = (  # e1e+
        a[..., 0] * b[..., 8] +
        -a[..., 2] * b[..., 17] +
        -a[..., 3] * b[..., 19] +
        -a[..., 5] * b[..., 21] +
        -a[..., 10] * b[..., 26] +
        -a[..., 12] * b[..., 28] +
        -a[..., 14] * b[..., 29] +
        a[..., 23] * b[..., 31]
    )
    r9 = (  # e1e-
        a[..., 0] * b[..., 9] +
        -a[..., 2] * b[..., 18] +
        -a[..., 3] * b[..., 20] +
        -a[..., 4] * b[..., 21] +
        -a[..., 10] * b[..., 27] +
        -a[..., 11] * b[..., 28] +
        -a[..., 13] * b[..., 29] +
        a[..., 22] * b[..., 31]
    )
    r10 = (  # e2e3
        a[..., 0] * b[..., 10] +
        a[..., 1] * b[..., 16] +
        a[..., 4] * b[..., 22] +
        -a[..., 5] * b[..., 23] +
        -a[..., 8] * b[..., 26] +
        a[..., 9] * b[..., 27] +
        a[..., 15] * b[..., 30] +
        a[..., 21] * b[..., 31]
    )
    r11 = (  # e2e+
        a[..., 0] * b[..., 11] +
        a[..., 1] * b[..., 17] +
        -a[..., 3] * b[..., 22] +
        -a[..., 5] * b[..., 24] +
        a[..., 7] * b[..., 26] +
        a[..., 9] * b[..., 28] +
        -a[..., 14] * b[..., 30] +
        -a[..., 20] * b[..., 31]
    )
    r12 = (  # e2e-
        a[..., 0] * b[..., 12] +
        a[..., 1] * b[..., 18] +
        -a[..., 3] * b[..., 23] +
        -a[..., 4] * b[..., 24] +
        a[..., 7] * b[..., 27] +
        a[..., 8] * b[..., 28] +
        -a[..., 13] * b[..., 30] +
        -a[..., 19] * b[..., 31]
    )
    r13 = (  # e3e+
        a[..., 0] * b[..., 13] +
        a[..., 1] * b[..., 19] +
        a[..., 2] * b[..., 22] +
        -a[..., 5] * b[..., 25] +
        -a[..., 6] * b[..., 26] +
        a[..., 9] * b[..., 29] +
        a[..., 12] * b[..., 30] +
        a[..., 18] * b[..., 31]
    )
    r14 = (  # e3e-
        a[..., 0] * b[..., 14] +
        a[..., 1] * b[..., 20] +
        a[..., 2] * b[..., 23] +
        -a[..., 4] * b[..., 25] +
        -a[..., 6] * b[..., 27] +
        a[..., 8] * b[..., 29] +
        a[..., 11] * b[..., 30] +
        a[..., 17] * b[..., 31]
    )
    r15 = (  # e+e-
        a[..., 0] * b[..., 15] +
        a[..., 1] * b[..., 21] +
        a[..., 2] * b[..., 24] +
        a[..., 3] * b[..., 25] +
        -a[..., 6] * b[..., 28] +
        -a[..., 7] * b[..., 29] +
        -a[..., 10] * b[..., 30] +
        -a[..., 16] * b[..., 31]
    )
    r16 = (  # e1e2e3
        a[..., 0] * b[..., 16] +
        -a[..., 4] * b[..., 26] +
        a[..., 5] * b[..., 27] +
        a[..., 15] * b[..., 31]
    )
    r17 = (  # e1e2e+
        a[..., 0] * b[..., 17] +
        a[..., 3] * b[..., 26] +
        a[..., 5] * b[..., 28] +
        -a[..., 14] * b[..., 31]
    )
    r18 = (  # e1e2e-
        a[..., 0] * b[..., 18] +
        a[..., 3] * b[..., 27] +
        a[..., 4] * b[..., 28] +
        -a[..., 13] * b[..., 31]
    )
    r19 = (  # e1e3e+
        a[..., 0] * b[..., 19] +
        -a[..., 2] * b[..., 26] +
        a[..., 5] * b[..., 29] +
        a[..., 12] * b[..., 31]
    )
    r20 = (  # e1e3e-
        a[..., 0] * b[..., 20] +
        -a[..., 2] * b[..., 27] +
        a[..., 4] * b[..., 29] +
        a[..., 11] * b[..., 31]
    )
    r21 = (  # e1e+e-
        a[..., 0] * b[..., 21] +
        -a[..., 2] * b[..., 28] +
        -a[..., 3] * b[..., 29] +
        -a[..., 10] * b[..., 31]
    )
    r22 = (  # e2e3e+
        a[..., 0] * b[..., 22] +
        a[..., 1] * b[..., 26] +
        a[..., 5] * b[..., 30] +
        -a[..., 9] * b[..., 31]
    )
    r23 = (  # e2e3e-
        a[..., 0] * b[..., 23] +
        a[..., 1] * b[..., 27] +
        a[..., 4] * b[..., 30] +
        -a[..., 8] * b[..., 31]
    )
    r24 = (  # e2e+e-
        a[..., 0] * b[..., 24] +
        a[..., 1] * b[..., 28] +
        -a[..., 3] * b[..., 30] +
        a[..., 7] * b[..., 31]
    )
    r25 = (  # e3e+e-
        a[..., 0] * b[..., 25] +
        a[..., 1] * b[..., 29] +
        a[..., 2] * b[..., 30] +
        -a[..., 6] * b[..., 31]
    )
    r26 = a[..., 0] * b[..., 26] + -a[..., 5] * b[..., 31]  # e1e2e3e+
    r27 = a[..., 0] * b[..., 27] + -a[..., 4] * b[..., 31]  # e1e2e3e-
    r28 = a[..., 0] * b[..., 28] + a[..., 3] * b[..., 31]  # e1e2e+e-
    r29 = a[..., 0] * b[..., 29] + -a[..., 2] * b[..., 31]  # e1e3e+e-
    r30 = a[..., 0] * b[..., 30] + a[..., 1] * b[..., 31]  # e2e3e+e-
    r31 = a[..., 0] * b[..., 31]  # e1e2e3e+e-

    return torch.stack([
        r0, r1, r2, r3, r4, r5, r6, r7,
        r8, r9, r10, r11, r12, r13, r14, r15,
        r16, r17, r18, r19, r20, r21, r22, r23,
        r24, r25, r26, r27, r28, r29, r30, r31,
    ], dim=-1)

# =============================================================================
# Right Contraction
# =============================================================================

@torch.jit.script
def right_contraction_full(a: Tensor, b: Tensor) -> Tensor:
    """
    Compute right contraction.

    a ⌊ b = <a * b>_{grade(a) - grade(b)} if grade(a) >= grade(b), else 0

    Args:
        a: First multivector, shape (..., 32)
        b: Second multivector, shape (..., 32)

    Returns:
        Right contraction result, shape (..., 32)
    """
    r0 = (  # 1
        a[..., 0] * b[..., 0] +
        a[..., 1] * b[..., 1] +
        a[..., 2] * b[..., 2] +
        a[..., 3] * b[..., 3] +
        a[..., 4] * b[..., 4] +
        -a[..., 5] * b[..., 5] +
        -a[..., 6] * b[..., 6] +
        -a[..., 7] * b[..., 7] +
        -a[..., 8] * b[..., 8] +
        a[..., 9] * b[..., 9] +
        -a[..., 10] * b[..., 10] +
        -a[..., 11] * b[..., 11] +
        a[..., 12] * b[..., 12] +
        -a[..., 13] * b[..., 13] +
        a[..., 14] * b[..., 14] +
        a[..., 15] * b[..., 15] +
        -a[..., 16] * b[..., 16] +
        -a[..., 17] * b[..., 17] +
        a[..., 18] * b[..., 18] +
        -a[..., 19] * b[..., 19] +
        a[..., 20] * b[..., 20] +
        a[..., 21] * b[..., 21] +
        -a[..., 22] * b[..., 22] +
        a[..., 23] * b[..., 23] +
        a[..., 24] * b[..., 24] +
        a[..., 25] * b[..., 25] +
        a[..., 26] * b[..., 26] +
        -a[..., 27] * b[..., 27] +
        -a[..., 28] * b[..., 28] +
        -a[..., 29] * b[..., 29] +
        -a[..., 30] * b[..., 30] +
        -a[..., 31] * b[..., 31]
    )
    r1 = (  # e1
        a[..., 1] * b[..., 0] +
        a[..., 6] * b[..., 2] +
        a[..., 7] * b[..., 3] +
        a[..., 8] * b[..., 4] +
        -a[..., 9] * b[..., 5] +
        -a[..., 16] * b[..., 10] +
        -a[..., 17] * b[..., 11] +
        a[..., 18] * b[..., 12] +
        -a[..., 19] * b[..., 13] +
        a[..., 20] * b[..., 14] +
        a[..., 21] * b[..., 15] +
        -a[..., 26] * b[..., 22] +
        a[..., 27] * b[..., 23] +
        a[..., 28] * b[..., 24] +
        a[..., 29] * b[..., 25] +
        -a[..., 31] * b[..., 30]
    )
    r2 = (  # e2
        a[..., 2] * b[..., 0] +
        -a[..., 6] * b[..., 1] +
        a[..., 10] * b[..., 3] +
        a[..., 11] * b[..., 4] +
        -a[..., 12] * b[..., 5] +
        a[..., 16] * b[..., 7] +
        a[..., 17] * b[..., 8] +
        -a[..., 18] * b[..., 9] +
        -a[..., 22] * b[..., 13] +
        a[..., 23] * b[..., 14] +
        a[..., 24] * b[..., 15] +
        a[..., 26] * b[..., 19] +
        -a[..., 27] * b[..., 20] +
        -a[..., 28] * b[..., 21] +
        a[..., 30] * b[..., 25] +
        a[..., 31] * b[..., 29]
    )
    r3 = (  # e3
        a[..., 3] * b[..., 0] +
        -a[..., 7] * b[..., 1] +
        -a[..., 10] * b[..., 2] +
        a[..., 13] * b[..., 4] +
        -a[..., 14] * b[..., 5] +
        -a[..., 16] * b[..., 6] +
        a[..., 19] * b[..., 8] +
        -a[..., 20] * b[..., 9] +
        a[..., 22] * b[..., 11] +
        -a[..., 23] * b[..., 12] +
        a[..., 25] * b[..., 15] +
        -a[..., 26] * b[..., 17] +
        a[..., 27] * b[..., 18] +
        -a[..., 29] * b[..., 21] +
        -a[..., 30] * b[..., 24] +
        -a[..., 31] * b[..., 28]
    )
    r4 = (  # e+
        a[..., 4] * b[..., 0] +
        -a[..., 8] * b[..., 1] +
        -a[..., 11] * b[..., 2] +
        -a[..., 13] * b[..., 3] +
        -a[..., 15] * b[..., 5] +
        -a[..., 17] * b[..., 6] +
        -a[..., 19] * b[..., 7] +
        -a[..., 21] * b[..., 9] +
        -a[..., 22] * b[..., 10] +
        -a[..., 24] * b[..., 12] +
        -a[..., 25] * b[..., 14] +
        a[..., 26] * b[..., 16] +
        a[..., 28] * b[..., 18] +
        a[..., 29] * b[..., 20] +
        a[..., 30] * b[..., 23] +
        a[..., 31] * b[..., 27]
    )
    r5 = (  # e-
        a[..., 5] * b[..., 0] +
        -a[..., 9] * b[..., 1] +
        -a[..., 12] * b[..., 2] +
        -a[..., 14] * b[..., 3] +
        -a[..., 15] * b[..., 4] +
        -a[..., 18] * b[..., 6] +
        -a[..., 20] * b[..., 7] +
        -a[..., 21] * b[..., 8] +
        -a[..., 23] * b[..., 10] +
        -a[..., 24] * b[..., 11] +
        -a[..., 25] * b[..., 13] +
        a[..., 27] * b[..., 16] +
        a[..., 28] * b[..., 17] +
        a[..., 29] * b[..., 19] +
        a[..., 30] * b[..., 22] +
        a[..., 31] * b[..., 26]
    )
    r6 = (  # e1e2
        a[..., 6] * b[..., 0] +
        a[..., 16] * b[..., 3] +
        a[..., 17] * b[..., 4] +
        -a[..., 18] * b[..., 5] +
        -a[..., 26] * b[..., 13] +
        a[..., 27] * b[..., 14] +
        a[..., 28] * b[..., 15] +
        a[..., 31] * b[..., 25]
    )
    r7 = (  # e1e3
        a[..., 7] * b[..., 0] +
        -a[..., 16] * b[..., 2] +
        a[..., 19] * b[..., 4] +
        -a[..., 20] * b[..., 5] +
        a[..., 26] * b[..., 11] +
        -a[..., 27] * b[..., 12] +
        a[..., 29] * b[..., 15] +
        -a[..., 31] * b[..., 24]
    )
    r8 = (  # e1e+
        a[..., 8] * b[..., 0] +
        -a[..., 17] * b[..., 2] +
        -a[..., 19] * b[..., 3] +
        -a[..., 21] * b[..., 5] +
        -a[..., 26] * b[..., 10] +
        -a[..., 28] * b[..., 12] +
        -a[..., 29] * b[..., 14] +
        a[..., 31] * b[..., 23]
    )
    r9 = (  # e1e-
        a[..., 9] * b[..., 0] +
        -a[..., 18] * b[..., 2] +
        -a[..., 20] * b[..., 3] +
        -a[..., 21] * b[..., 4] +
        -a[..., 27] * b[..., 10] +
        -a[..., 28] * b[..., 11] +
        -a[..., 29] * b[..., 13] +
        a[..., 31] * b[..., 22]
    )
    r10 = (  # e2e3
        a[..., 10] * b[..., 0] +
        a[..., 16] * b[..., 1] +
        a[..., 22] * b[..., 4] +
        -a[..., 23] * b[..., 5] +
        -a[..., 26] * b[..., 8] +
        a[..., 27] * b[..., 9] +
        a[..., 30] * b[..., 15] +
        a[..., 31] * b[..., 21]
    )
    r11 = (  # e2e+
        a[..., 11] * b[..., 0] +
        a[..., 17] * b[..., 1] +
        -a[..., 22] * b[..., 3] +
        -a[..., 24] * b[..., 5] +
        a[..., 26] * b[..., 7] +
        a[..., 28] * b[..., 9] +
        -a[..., 30] * b[..., 14] +
        -a[..., 31] * b[..., 20]
    )
    r12 = (  # e2e-
        a[..., 12] * b[..., 0] +
        a[..., 18] * b[..., 1] +
        -a[..., 23] * b[..., 3] +
        -a[..., 24] * b[..., 4] +
        a[..., 27] * b[..., 7] +
        a[..., 28] * b[..., 8] +
        -a[..., 30] * b[..., 13] +
        -a[..., 31] * b[..., 19]
    )
    r13 = (  # e3e+
        a[..., 13] * b[..., 0] +
        a[..., 19] * b[..., 1] +
        a[..., 22] * b[..., 2] +
        -a[..., 25] * b[..., 5] +
        -a[..., 26] * b[..., 6] +
        a[..., 29] * b[..., 9] +
        a[..., 30] * b[..., 12] +
        a[..., 31] * b[..., 18]
    )
    r14 = (  # e3e-
        a[..., 14] * b[..., 0] +
        a[..., 20] * b[..., 1] +
        a[..., 23] * b[..., 2] +
        -a[..., 25] * b[..., 4] +
        -a[..., 27] * b[..., 6] +
        a[..., 29] * b[..., 8] +
        a[..., 30] * b[..., 11] +
        a[..., 31] * b[..., 17]
    )
    r15 = (  # e+e-
        a[..., 15] * b[..., 0] +
        a[..., 21] * b[..., 1] +
        a[..., 24] * b[..., 2] +
        a[..., 25] * b[..., 3] +
        -a[..., 28] * b[..., 6] +
        -a[..., 29] * b[..., 7] +
        -a[..., 30] * b[..., 10] +
        -a[..., 31] * b[..., 16]
    )
    r16 = (  # e1e2e3
        a[..., 16] * b[..., 0] +
        a[..., 26] * b[..., 4] +
        -a[..., 27] * b[..., 5] +
        a[..., 31] * b[..., 15]
    )
    r17 = (  # e1e2e+
        a[..., 17] * b[..., 0] +
        -a[..., 26] * b[..., 3] +
        -a[..., 28] * b[..., 5] +
        -a[..., 31] * b[..., 14]
    )
    r18 = (  # e1e2e-
        a[..., 18] * b[..., 0] +
        -a[..., 27] * b[..., 3] +
        -a[..., 28] * b[..., 4] +
        -a[..., 31] * b[..., 13]
    )
    r19 = (  # e1e3e+
        a[..., 19] * b[..., 0] +
        a[..., 26] * b[..., 2] +
        -a[..., 29] * b[..., 5] +
        a[..., 31] * b[..., 12]
    )
    r20 = (  # e1e3e-
        a[..., 20] * b[..., 0] +
        a[..., 27] * b[..., 2] +
        -a[..., 29] * b[..., 4] +
        a[..., 31] * b[..., 11]
    )
    r21 = (  # e1e+e-
        a[..., 21] * b[..., 0] +
        a[..., 28] * b[..., 2] +
        a[..., 29] * b[..., 3] +
        -a[..., 31] * b[..., 10]
    )
    r22 = (  # e2e3e+
        a[..., 22] * b[..., 0] +
        -a[..., 26] * b[..., 1] +
        -a[..., 30] * b[..., 5] +
        -a[..., 31] * b[..., 9]
    )
    r23 = (  # e2e3e-
        a[..., 23] * b[..., 0] +
        -a[..., 27] * b[..., 1] +
        -a[..., 30] * b[..., 4] +
        -a[..., 31] * b[..., 8]
    )
    r24 = (  # e2e+e-
        a[..., 24] * b[..., 0] +
        -a[..., 28] * b[..., 1] +
        a[..., 30] * b[..., 3] +
        a[..., 31] * b[..., 7]
    )
    r25 = (  # e3e+e-
        a[..., 25] * b[..., 0] +
        -a[..., 29] * b[..., 1] +
        -a[..., 30] * b[..., 2] +
        -a[..., 31] * b[..., 6]
    )
    r26 = a[..., 26] * b[..., 0] + -a[..., 31] * b[..., 5]  # e1e2e3e+
    r27 = a[..., 27] * b[..., 0] + -a[..., 31] * b[..., 4]  # e1e2e3e-
    r28 = a[..., 28] * b[..., 0] + a[..., 31] * b[..., 3]  # e1e2e+e-
    r29 = a[..., 29] * b[..., 0] + -a[..., 31] * b[..., 2]  # e1e3e+e-
    r30 = a[..., 30] * b[..., 0] + a[..., 31] * b[..., 1]  # e2e3e+e-
    r31 = a[..., 31] * b[..., 0]  # e1e2e3e+e-

    return torch.stack([
        r0, r1, r2, r3, r4, r5, r6, r7,
        r8, r9, r10, r11, r12, r13, r14, r15,
        r16, r17, r18, r19, r20, r21, r22, r23,
        r24, r25, r26, r27, r28, r29, r30, r31,
    ], dim=-1)

# =============================================================================
# Grade Selection
# =============================================================================

# Grade masks for grade selection
GRADE_0_MASK = (0,)
GRADE_1_MASK = (1, 2, 3, 4, 5)
GRADE_2_MASK = (6, 7, 8, 9, 10, 11, 12, 13, 14, 15)
GRADE_3_MASK = (16, 17, 18, 19, 20, 21, 22, 23, 24, 25)
GRADE_4_MASK = (26, 27, 28, 29, 30)
GRADE_5_MASK = (31,)

@torch.jit.script
def grade_select(mv: Tensor, grade: int) -> Tensor:
    """
    Extract components of a specific grade.

    Args:
        mv: Multivector, shape (..., 32)
        grade: Grade to extract (0 to 5)

    Returns:
        Grade components (zeros for non-selected grades)
    """
    if grade == 0:
        r0 = mv[..., 0]
        r1 = torch.zeros_like(mv[..., 0])
        r2 = torch.zeros_like(mv[..., 0])
        r3 = torch.zeros_like(mv[..., 0])
        r4 = torch.zeros_like(mv[..., 0])
        r5 = torch.zeros_like(mv[..., 0])
        r6 = torch.zeros_like(mv[..., 0])
        r7 = torch.zeros_like(mv[..., 0])
        r8 = torch.zeros_like(mv[..., 0])
        r9 = torch.zeros_like(mv[..., 0])
        r10 = torch.zeros_like(mv[..., 0])
        r11 = torch.zeros_like(mv[..., 0])
        r12 = torch.zeros_like(mv[..., 0])
        r13 = torch.zeros_like(mv[..., 0])
        r14 = torch.zeros_like(mv[..., 0])
        r15 = torch.zeros_like(mv[..., 0])
        r16 = torch.zeros_like(mv[..., 0])
        r17 = torch.zeros_like(mv[..., 0])
        r18 = torch.zeros_like(mv[..., 0])
        r19 = torch.zeros_like(mv[..., 0])
        r20 = torch.zeros_like(mv[..., 0])
        r21 = torch.zeros_like(mv[..., 0])
        r22 = torch.zeros_like(mv[..., 0])
        r23 = torch.zeros_like(mv[..., 0])
        r24 = torch.zeros_like(mv[..., 0])
        r25 = torch.zeros_like(mv[..., 0])
        r26 = torch.zeros_like(mv[..., 0])
        r27 = torch.zeros_like(mv[..., 0])
        r28 = torch.zeros_like(mv[..., 0])
        r29 = torch.zeros_like(mv[..., 0])
        r30 = torch.zeros_like(mv[..., 0])
        r31 = torch.zeros_like(mv[..., 0])
        return torch.stack([
            r0, r1, r2, r3, r4, r5, r6, r7,
            r8, r9, r10, r11, r12, r13, r14, r15,
            r16, r17, r18, r19, r20, r21, r22, r23,
            r24, r25, r26, r27, r28, r29, r30, r31,
        ], dim=-1)
    elif grade == 1:
        r0 = torch.zeros_like(mv[..., 0])
        r1 = mv[..., 1]
        r2 = mv[..., 2]
        r3 = mv[..., 3]
        r4 = mv[..., 4]
        r5 = mv[..., 5]
        r6 = torch.zeros_like(mv[..., 0])
        r7 = torch.zeros_like(mv[..., 0])
        r8 = torch.zeros_like(mv[..., 0])
        r9 = torch.zeros_like(mv[..., 0])
        r10 = torch.zeros_like(mv[..., 0])
        r11 = torch.zeros_like(mv[..., 0])
        r12 = torch.zeros_like(mv[..., 0])
        r13 = torch.zeros_like(mv[..., 0])
        r14 = torch.zeros_like(mv[..., 0])
        r15 = torch.zeros_like(mv[..., 0])
        r16 = torch.zeros_like(mv[..., 0])
        r17 = torch.zeros_like(mv[..., 0])
        r18 = torch.zeros_like(mv[..., 0])
        r19 = torch.zeros_like(mv[..., 0])
        r20 = torch.zeros_like(mv[..., 0])
        r21 = torch.zeros_like(mv[..., 0])
        r22 = torch.zeros_like(mv[..., 0])
        r23 = torch.zeros_like(mv[..., 0])
        r24 = torch.zeros_like(mv[..., 0])
        r25 = torch.zeros_like(mv[..., 0])
        r26 = torch.zeros_like(mv[..., 0])
        r27 = torch.zeros_like(mv[..., 0])
        r28 = torch.zeros_like(mv[..., 0])
        r29 = torch.zeros_like(mv[..., 0])
        r30 = torch.zeros_like(mv[..., 0])
        r31 = torch.zeros_like(mv[..., 0])
        return torch.stack([
            r0, r1, r2, r3, r4, r5, r6, r7,
            r8, r9, r10, r11, r12, r13, r14, r15,
            r16, r17, r18, r19, r20, r21, r22, r23,
            r24, r25, r26, r27, r28, r29, r30, r31,
        ], dim=-1)
    elif grade == 2:
        r0 = torch.zeros_like(mv[..., 0])
        r1 = torch.zeros_like(mv[..., 0])
        r2 = torch.zeros_like(mv[..., 0])
        r3 = torch.zeros_like(mv[..., 0])
        r4 = torch.zeros_like(mv[..., 0])
        r5 = torch.zeros_like(mv[..., 0])
        r6 = mv[..., 6]
        r7 = mv[..., 7]
        r8 = mv[..., 8]
        r9 = mv[..., 9]
        r10 = mv[..., 10]
        r11 = mv[..., 11]
        r12 = mv[..., 12]
        r13 = mv[..., 13]
        r14 = mv[..., 14]
        r15 = mv[..., 15]
        r16 = torch.zeros_like(mv[..., 0])
        r17 = torch.zeros_like(mv[..., 0])
        r18 = torch.zeros_like(mv[..., 0])
        r19 = torch.zeros_like(mv[..., 0])
        r20 = torch.zeros_like(mv[..., 0])
        r21 = torch.zeros_like(mv[..., 0])
        r22 = torch.zeros_like(mv[..., 0])
        r23 = torch.zeros_like(mv[..., 0])
        r24 = torch.zeros_like(mv[..., 0])
        r25 = torch.zeros_like(mv[..., 0])
        r26 = torch.zeros_like(mv[..., 0])
        r27 = torch.zeros_like(mv[..., 0])
        r28 = torch.zeros_like(mv[..., 0])
        r29 = torch.zeros_like(mv[..., 0])
        r30 = torch.zeros_like(mv[..., 0])
        r31 = torch.zeros_like(mv[..., 0])
        return torch.stack([
            r0, r1, r2, r3, r4, r5, r6, r7,
            r8, r9, r10, r11, r12, r13, r14, r15,
            r16, r17, r18, r19, r20, r21, r22, r23,
            r24, r25, r26, r27, r28, r29, r30, r31,
        ], dim=-1)
    elif grade == 3:
        r0 = torch.zeros_like(mv[..., 0])
        r1 = torch.zeros_like(mv[..., 0])
        r2 = torch.zeros_like(mv[..., 0])
        r3 = torch.zeros_like(mv[..., 0])
        r4 = torch.zeros_like(mv[..., 0])
        r5 = torch.zeros_like(mv[..., 0])
        r6 = torch.zeros_like(mv[..., 0])
        r7 = torch.zeros_like(mv[..., 0])
        r8 = torch.zeros_like(mv[..., 0])
        r9 = torch.zeros_like(mv[..., 0])
        r10 = torch.zeros_like(mv[..., 0])
        r11 = torch.zeros_like(mv[..., 0])
        r12 = torch.zeros_like(mv[..., 0])
        r13 = torch.zeros_like(mv[..., 0])
        r14 = torch.zeros_like(mv[..., 0])
        r15 = torch.zeros_like(mv[..., 0])
        r16 = mv[..., 16]
        r17 = mv[..., 17]
        r18 = mv[..., 18]
        r19 = mv[..., 19]
        r20 = mv[..., 20]
        r21 = mv[..., 21]
        r22 = mv[..., 22]
        r23 = mv[..., 23]
        r24 = mv[..., 24]
        r25 = mv[..., 25]
        r26 = torch.zeros_like(mv[..., 0])
        r27 = torch.zeros_like(mv[..., 0])
        r28 = torch.zeros_like(mv[..., 0])
        r29 = torch.zeros_like(mv[..., 0])
        r30 = torch.zeros_like(mv[..., 0])
        r31 = torch.zeros_like(mv[..., 0])
        return torch.stack([
            r0, r1, r2, r3, r4, r5, r6, r7,
            r8, r9, r10, r11, r12, r13, r14, r15,
            r16, r17, r18, r19, r20, r21, r22, r23,
            r24, r25, r26, r27, r28, r29, r30, r31,
        ], dim=-1)
    elif grade == 4:
        r0 = torch.zeros_like(mv[..., 0])
        r1 = torch.zeros_like(mv[..., 0])
        r2 = torch.zeros_like(mv[..., 0])
        r3 = torch.zeros_like(mv[..., 0])
        r4 = torch.zeros_like(mv[..., 0])
        r5 = torch.zeros_like(mv[..., 0])
        r6 = torch.zeros_like(mv[..., 0])
        r7 = torch.zeros_like(mv[..., 0])
        r8 = torch.zeros_like(mv[..., 0])
        r9 = torch.zeros_like(mv[..., 0])
        r10 = torch.zeros_like(mv[..., 0])
        r11 = torch.zeros_like(mv[..., 0])
        r12 = torch.zeros_like(mv[..., 0])
        r13 = torch.zeros_like(mv[..., 0])
        r14 = torch.zeros_like(mv[..., 0])
        r15 = torch.zeros_like(mv[..., 0])
        r16 = torch.zeros_like(mv[..., 0])
        r17 = torch.zeros_like(mv[..., 0])
        r18 = torch.zeros_like(mv[..., 0])
        r19 = torch.zeros_like(mv[..., 0])
        r20 = torch.zeros_like(mv[..., 0])
        r21 = torch.zeros_like(mv[..., 0])
        r22 = torch.zeros_like(mv[..., 0])
        r23 = torch.zeros_like(mv[..., 0])
        r24 = torch.zeros_like(mv[..., 0])
        r25 = torch.zeros_like(mv[..., 0])
        r26 = mv[..., 26]
        r27 = mv[..., 27]
        r28 = mv[..., 28]
        r29 = mv[..., 29]
        r30 = mv[..., 30]
        r31 = torch.zeros_like(mv[..., 0])
        return torch.stack([
            r0, r1, r2, r3, r4, r5, r6, r7,
            r8, r9, r10, r11, r12, r13, r14, r15,
            r16, r17, r18, r19, r20, r21, r22, r23,
            r24, r25, r26, r27, r28, r29, r30, r31,
        ], dim=-1)
    elif grade == 5:
        r0 = torch.zeros_like(mv[..., 0])
        r1 = torch.zeros_like(mv[..., 0])
        r2 = torch.zeros_like(mv[..., 0])
        r3 = torch.zeros_like(mv[..., 0])
        r4 = torch.zeros_like(mv[..., 0])
        r5 = torch.zeros_like(mv[..., 0])
        r6 = torch.zeros_like(mv[..., 0])
        r7 = torch.zeros_like(mv[..., 0])
        r8 = torch.zeros_like(mv[..., 0])
        r9 = torch.zeros_like(mv[..., 0])
        r10 = torch.zeros_like(mv[..., 0])
        r11 = torch.zeros_like(mv[..., 0])
        r12 = torch.zeros_like(mv[..., 0])
        r13 = torch.zeros_like(mv[..., 0])
        r14 = torch.zeros_like(mv[..., 0])
        r15 = torch.zeros_like(mv[..., 0])
        r16 = torch.zeros_like(mv[..., 0])
        r17 = torch.zeros_like(mv[..., 0])
        r18 = torch.zeros_like(mv[..., 0])
        r19 = torch.zeros_like(mv[..., 0])
        r20 = torch.zeros_like(mv[..., 0])
        r21 = torch.zeros_like(mv[..., 0])
        r22 = torch.zeros_like(mv[..., 0])
        r23 = torch.zeros_like(mv[..., 0])
        r24 = torch.zeros_like(mv[..., 0])
        r25 = torch.zeros_like(mv[..., 0])
        r26 = torch.zeros_like(mv[..., 0])
        r27 = torch.zeros_like(mv[..., 0])
        r28 = torch.zeros_like(mv[..., 0])
        r29 = torch.zeros_like(mv[..., 0])
        r30 = torch.zeros_like(mv[..., 0])
        r31 = mv[..., 31]
        return torch.stack([
            r0, r1, r2, r3, r4, r5, r6, r7,
            r8, r9, r10, r11, r12, r13, r14, r15,
            r16, r17, r18, r19, r20, r21, r22, r23,
            r24, r25, r26, r27, r28, r29, r30, r31,
        ], dim=-1)
    else:
        return torch.zeros_like(mv)

# =============================================================================
# Dual Operation
# =============================================================================

# Pseudoscalar index: 31, I² = -1
# I^{-1} = I / I² = I * -1.0

@torch.jit.script
def dual(mv: Tensor) -> Tensor:
    """
    Compute the dual of a multivector.

    a* = a ⌋ I^{-1} (left contraction with pseudoscalar inverse)

    Args:
        mv: Multivector, shape (..., 32)

    Returns:
        Dual multivector, shape (..., 32)
    """
    r0 = mv[..., 31]  # 1
    r1 = mv[..., 30]  # e1
    r2 = -mv[..., 29]  # e2
    r3 = mv[..., 28]  # e3
    r4 = -mv[..., 27]  # e+
    r5 = -mv[..., 26]  # e-
    r6 = -mv[..., 25]  # e1e2
    r7 = mv[..., 24]  # e1e3
    r8 = -mv[..., 23]  # e1e+
    r9 = -mv[..., 22]  # e1e-
    r10 = -mv[..., 21]  # e2e3
    r11 = mv[..., 20]  # e2e+
    r12 = mv[..., 19]  # e2e-
    r13 = -mv[..., 18]  # e3e+
    r14 = -mv[..., 17]  # e3e-
    r15 = mv[..., 16]  # e+e-
    r16 = -mv[..., 15]  # e1e2e3
    r17 = mv[..., 14]  # e1e2e+
    r18 = mv[..., 13]  # e1e2e-
    r19 = -mv[..., 12]  # e1e3e+
    r20 = -mv[..., 11]  # e1e3e-
    r21 = mv[..., 10]  # e1e+e-
    r22 = mv[..., 9]  # e2e3e+
    r23 = mv[..., 8]  # e2e3e-
    r24 = -mv[..., 7]  # e2e+e-
    r25 = mv[..., 6]  # e3e+e-
    r26 = mv[..., 5]  # e1e2e3e+
    r27 = mv[..., 4]  # e1e2e3e-
    r28 = -mv[..., 3]  # e1e2e+e-
    r29 = mv[..., 2]  # e1e3e+e-
    r30 = -mv[..., 1]  # e2e3e+e-
    r31 = -mv[..., 0]  # e1e2e3e+e-

    return torch.stack([
        r0, r1, r2, r3, r4, r5, r6, r7,
        r8, r9, r10, r11, r12, r13, r14, r15,
        r16, r17, r18, r19, r20, r21, r22, r23,
        r24, r25, r26, r27, r28, r29, r30, r31,
    ], dim=-1)

# =============================================================================
# Normalize Operation
# =============================================================================

@torch.jit.script
def norm_squared(mv: Tensor) -> Tensor:
    """
    Compute squared norm of a multivector.

    |a|² = <a * ~a>_0

    Args:
        mv: Multivector, shape (..., 32)

    Returns:
        Squared norm, shape (...,)
    """
    r = (
        mv[..., 0] * mv[..., 0] +
        mv[..., 1] * mv[..., 1] +
        mv[..., 2] * mv[..., 2] +
        mv[..., 3] * mv[..., 3] +
        mv[..., 4] * mv[..., 4] +
        -mv[..., 5] * mv[..., 5] +
        mv[..., 6] * mv[..., 6] +
        mv[..., 7] * mv[..., 7] +
        mv[..., 8] * mv[..., 8] +
        -mv[..., 9] * mv[..., 9] +
        mv[..., 10] * mv[..., 10] +
        mv[..., 11] * mv[..., 11] +
        -mv[..., 12] * mv[..., 12] +
        mv[..., 13] * mv[..., 13] +
        -mv[..., 14] * mv[..., 14] +
        -mv[..., 15] * mv[..., 15] +
        mv[..., 16] * mv[..., 16] +
        mv[..., 17] * mv[..., 17] +
        -mv[..., 18] * mv[..., 18] +
        mv[..., 19] * mv[..., 19] +
        -mv[..., 20] * mv[..., 20] +
        -mv[..., 21] * mv[..., 21] +
        mv[..., 22] * mv[..., 22] +
        -mv[..., 23] * mv[..., 23] +
        -mv[..., 24] * mv[..., 24] +
        -mv[..., 25] * mv[..., 25] +
        mv[..., 26] * mv[..., 26] +
        -mv[..., 27] * mv[..., 27] +
        -mv[..., 28] * mv[..., 28] +
        -mv[..., 29] * mv[..., 29] +
        -mv[..., 30] * mv[..., 30] +
        -mv[..., 31] * mv[..., 31]
    )
    return r


@torch.jit.script
def normalize(mv: Tensor) -> Tensor:
    """
    Normalize a multivector to unit norm.

    Args:
        mv: Multivector, shape (..., 32)

    Returns:
        Normalized multivector, shape (..., 32)

    Note:
        Returns NaN for null multivectors (ONNX compatible)
    """
    norm = torch.sqrt(torch.abs(norm_squared(mv)) + 1e-12)
    return mv / norm.unsqueeze(-1)

# =============================================================================
# Structure Normalize (US9a)
# =============================================================================

ROTOR_INDICES: Tuple[int, ...] = (0, 1, 2, 5)
TRANSLATION_PAIRS: Tuple[Tuple[int, int], ...] = ((3, 4), (6, 7), (8, 9))
DILATION_INDEX: int = 10


@torch.jit.script
def structure_normalize(similitude: Tensor, eps: float = 1e-8) -> Tensor:
    """
    Structure-normalize a Similitude tensor.

    Ensures:
    1. Rotor part (scalar + spatial bivectors) has unit norm
    2. Similitude constraint: eie+ = eie- (no transversion)

    Args:
        similitude: Similitude tensor, shape (..., 16)
        eps: Numerical stability constant

    Returns:
        Structure-normalized Similitude, shape (..., 16)
    """
    result = similitude.clone()

    # Step 1: Normalize Rotor part
    rotor_norm_sq = similitude[..., 0] * similitude[..., 0] + similitude[..., 1] * similitude[..., 1] + similitude[..., 2] * similitude[..., 2] + similitude[..., 5] * similitude[..., 5]
    rotor_norm = torch.sqrt(rotor_norm_sq + eps)
    result[..., 0] = similitude[..., 0] / rotor_norm
    result[..., 1] = similitude[..., 1] / rotor_norm
    result[..., 2] = similitude[..., 2] / rotor_norm
    result[..., 5] = similitude[..., 5] / rotor_norm

    # Step 2: Enforce Similitude constraint (eie+ = eie-)
    avg_3 = (result[..., 3] + result[..., 4]) / 2
    result[..., 3] = avg_3
    result[..., 4] = avg_3
    avg_6 = (result[..., 6] + result[..., 7]) / 2
    result[..., 6] = avg_6
    result[..., 7] = avg_6
    avg_8 = (result[..., 8] + result[..., 9]) / 2
    result[..., 8] = avg_8
    result[..., 9] = avg_8

    return result


@torch.jit.script
def soft_structure_normalize(similitude: Tensor, strength: float = 1.0, eps: float = 1e-8) -> Tensor:
    """
    Soft structure normalization with interpolation.

    Args:
        similitude: Similitude tensor, shape (..., 16)
        strength: Interpolation strength (0=no change, 1=full normalize)
        eps: Numerical stability constant

    Returns:
        Soft-normalized Similitude, shape (..., 16)
    """
    normalized = structure_normalize(similitude, eps)
    return similitude + strength * (normalized - similitude)
