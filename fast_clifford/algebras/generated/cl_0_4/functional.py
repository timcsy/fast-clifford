"""
Clifford Algebra Cl(0, 4) Functional Operations - Auto-generated

DO NOT EDIT MANUALLY - This file is generated by codegen/generator.py

Generated: 2025-12-19 10:34:11
Signature: Cl(0, 4)
Blade count: 16
Rotor count: 8
Bivector count: 6
Algebra type: general

All functions are:
- Loop-free (fully expanded arithmetic)
- ONNX-compatible (only Add/Mul/Neg/Sub operations)
- torch.jit.script compatible
"""

import torch
from torch import Tensor
from typing import Tuple


# =============================================================================
# Constants
# =============================================================================

BLADE_COUNT = 16
ROTOR_COUNT = 8
BIVECTOR_COUNT = 6

# Blade indices by grade
GRADE_0_INDICES = (0,)
GRADE_1_INDICES = (1, 2, 3, 4)
GRADE_2_INDICES = (5, 6, 7, 8, 9, 10)
GRADE_3_INDICES = (11, 12, 13, 14)
GRADE_4_INDICES = (15,)

# Rotor (even-grade) indices
ROTOR_MASK = (0, 5, 6, 7, 8, 9, 10, 15)

# Bivector (grade-2) indices
BIVECTOR_MASK = (5, 6, 7, 8, 9, 10)

# Vector (grade-1) indices
VECTOR_MASK = (1, 2, 3, 4)

# Reverse signs for all blades
REVERSE_SIGNS = (1, 1, 1, 1, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 1)

# Involute signs for all blades
INVOLUTE_SIGNS = (1, -1, -1, -1, -1, 1, 1, 1, 1, 1, 1, -1, -1, -1, -1, 1)

# Conjugate signs for all blades
CONJUGATE_SIGNS = (1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 1, 1, 1, 1, 1)

# Inner product signs (bladeÂ² values)
INNER_PRODUCT_SIGNS = (1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 1, 1, 1, 1, 1)

# Pseudoscalar info
PSEUDOSCALAR_INDEX = 15
PSEUDOSCALAR_SQUARE = 1

# =============================================================================
# Geometric Product
# =============================================================================

@torch.jit.script
def geometric_product(a: Tensor, b: Tensor) -> Tensor:
    """
    Compute geometric product of two multivectors in Cl(0, 4).

    Args:
        a: Left operand, shape (..., 16)
        b: Right operand, shape (..., 16)

    Returns:
        Result multivector, shape (..., 16)
    """
    r0 = (
        a[..., 0] * b[..., 0] +
        -a[..., 1] * b[..., 1] +
        -a[..., 2] * b[..., 2] +
        -a[..., 3] * b[..., 3] +
        -a[..., 4] * b[..., 4] +
        -a[..., 5] * b[..., 5] +
        -a[..., 6] * b[..., 6] +
        -a[..., 7] * b[..., 7] +
        -a[..., 8] * b[..., 8] +
        -a[..., 9] * b[..., 9] +
        -a[..., 10] * b[..., 10] +
        a[..., 11] * b[..., 11] +
        a[..., 12] * b[..., 12] +
        a[..., 13] * b[..., 13] +
        a[..., 14] * b[..., 14] +
        a[..., 15] * b[..., 15]
    )
    r1 = (
        a[..., 0] * b[..., 1] +
        a[..., 1] * b[..., 0] +
        a[..., 2] * b[..., 5] +
        a[..., 3] * b[..., 6] +
        a[..., 4] * b[..., 7] +
        -a[..., 5] * b[..., 2] +
        -a[..., 6] * b[..., 3] +
        -a[..., 7] * b[..., 4] +
        -a[..., 8] * b[..., 11] +
        -a[..., 9] * b[..., 12] +
        -a[..., 10] * b[..., 13] +
        -a[..., 11] * b[..., 8] +
        -a[..., 12] * b[..., 9] +
        -a[..., 13] * b[..., 10] +
        -a[..., 14] * b[..., 15] +
        a[..., 15] * b[..., 14]
    )
    r2 = (
        a[..., 0] * b[..., 2] +
        -a[..., 1] * b[..., 5] +
        a[..., 2] * b[..., 0] +
        a[..., 3] * b[..., 8] +
        a[..., 4] * b[..., 9] +
        a[..., 5] * b[..., 1] +
        a[..., 6] * b[..., 11] +
        a[..., 7] * b[..., 12] +
        -a[..., 8] * b[..., 3] +
        -a[..., 9] * b[..., 4] +
        -a[..., 10] * b[..., 14] +
        a[..., 11] * b[..., 6] +
        a[..., 12] * b[..., 7] +
        a[..., 13] * b[..., 15] +
        -a[..., 14] * b[..., 10] +
        -a[..., 15] * b[..., 13]
    )
    r3 = (
        a[..., 0] * b[..., 3] +
        -a[..., 1] * b[..., 6] +
        -a[..., 2] * b[..., 8] +
        a[..., 3] * b[..., 0] +
        a[..., 4] * b[..., 10] +
        -a[..., 5] * b[..., 11] +
        a[..., 6] * b[..., 1] +
        a[..., 7] * b[..., 13] +
        a[..., 8] * b[..., 2] +
        a[..., 9] * b[..., 14] +
        -a[..., 10] * b[..., 4] +
        -a[..., 11] * b[..., 5] +
        -a[..., 12] * b[..., 15] +
        a[..., 13] * b[..., 7] +
        a[..., 14] * b[..., 9] +
        a[..., 15] * b[..., 12]
    )
    r4 = (
        a[..., 0] * b[..., 4] +
        -a[..., 1] * b[..., 7] +
        -a[..., 2] * b[..., 9] +
        -a[..., 3] * b[..., 10] +
        a[..., 4] * b[..., 0] +
        -a[..., 5] * b[..., 12] +
        -a[..., 6] * b[..., 13] +
        a[..., 7] * b[..., 1] +
        -a[..., 8] * b[..., 14] +
        a[..., 9] * b[..., 2] +
        a[..., 10] * b[..., 3] +
        a[..., 11] * b[..., 15] +
        -a[..., 12] * b[..., 5] +
        -a[..., 13] * b[..., 6] +
        -a[..., 14] * b[..., 8] +
        -a[..., 15] * b[..., 11]
    )
    r5 = (
        a[..., 0] * b[..., 5] +
        a[..., 1] * b[..., 2] +
        -a[..., 2] * b[..., 1] +
        -a[..., 3] * b[..., 11] +
        -a[..., 4] * b[..., 12] +
        a[..., 5] * b[..., 0] +
        a[..., 6] * b[..., 8] +
        a[..., 7] * b[..., 9] +
        -a[..., 8] * b[..., 6] +
        -a[..., 9] * b[..., 7] +
        -a[..., 10] * b[..., 15] +
        -a[..., 11] * b[..., 3] +
        -a[..., 12] * b[..., 4] +
        -a[..., 13] * b[..., 14] +
        a[..., 14] * b[..., 13] +
        -a[..., 15] * b[..., 10]
    )
    r6 = (
        a[..., 0] * b[..., 6] +
        a[..., 1] * b[..., 3] +
        a[..., 2] * b[..., 11] +
        -a[..., 3] * b[..., 1] +
        -a[..., 4] * b[..., 13] +
        -a[..., 5] * b[..., 8] +
        a[..., 6] * b[..., 0] +
        a[..., 7] * b[..., 10] +
        a[..., 8] * b[..., 5] +
        a[..., 9] * b[..., 15] +
        -a[..., 10] * b[..., 7] +
        a[..., 11] * b[..., 2] +
        a[..., 12] * b[..., 14] +
        -a[..., 13] * b[..., 4] +
        -a[..., 14] * b[..., 12] +
        a[..., 15] * b[..., 9]
    )
    r7 = (
        a[..., 0] * b[..., 7] +
        a[..., 1] * b[..., 4] +
        a[..., 2] * b[..., 12] +
        a[..., 3] * b[..., 13] +
        -a[..., 4] * b[..., 1] +
        -a[..., 5] * b[..., 9] +
        -a[..., 6] * b[..., 10] +
        a[..., 7] * b[..., 0] +
        -a[..., 8] * b[..., 15] +
        a[..., 9] * b[..., 5] +
        a[..., 10] * b[..., 6] +
        -a[..., 11] * b[..., 14] +
        a[..., 12] * b[..., 2] +
        a[..., 13] * b[..., 3] +
        a[..., 14] * b[..., 11] +
        -a[..., 15] * b[..., 8]
    )
    r8 = (
        a[..., 0] * b[..., 8] +
        -a[..., 1] * b[..., 11] +
        a[..., 2] * b[..., 3] +
        -a[..., 3] * b[..., 2] +
        -a[..., 4] * b[..., 14] +
        a[..., 5] * b[..., 6] +
        -a[..., 6] * b[..., 5] +
        -a[..., 7] * b[..., 15] +
        a[..., 8] * b[..., 0] +
        a[..., 9] * b[..., 10] +
        -a[..., 10] * b[..., 9] +
        -a[..., 11] * b[..., 1] +
        -a[..., 12] * b[..., 13] +
        a[..., 13] * b[..., 12] +
        -a[..., 14] * b[..., 4] +
        -a[..., 15] * b[..., 7]
    )
    r9 = (
        a[..., 0] * b[..., 9] +
        -a[..., 1] * b[..., 12] +
        a[..., 2] * b[..., 4] +
        a[..., 3] * b[..., 14] +
        -a[..., 4] * b[..., 2] +
        a[..., 5] * b[..., 7] +
        a[..., 6] * b[..., 15] +
        -a[..., 7] * b[..., 5] +
        -a[..., 8] * b[..., 10] +
        a[..., 9] * b[..., 0] +
        a[..., 10] * b[..., 8] +
        a[..., 11] * b[..., 13] +
        -a[..., 12] * b[..., 1] +
        -a[..., 13] * b[..., 11] +
        a[..., 14] * b[..., 3] +
        a[..., 15] * b[..., 6]
    )
    r10 = (
        a[..., 0] * b[..., 10] +
        -a[..., 1] * b[..., 13] +
        -a[..., 2] * b[..., 14] +
        a[..., 3] * b[..., 4] +
        -a[..., 4] * b[..., 3] +
        -a[..., 5] * b[..., 15] +
        a[..., 6] * b[..., 7] +
        -a[..., 7] * b[..., 6] +
        a[..., 8] * b[..., 9] +
        -a[..., 9] * b[..., 8] +
        a[..., 10] * b[..., 0] +
        -a[..., 11] * b[..., 12] +
        a[..., 12] * b[..., 11] +
        -a[..., 13] * b[..., 1] +
        -a[..., 14] * b[..., 2] +
        -a[..., 15] * b[..., 5]
    )
    r11 = (
        a[..., 0] * b[..., 11] +
        a[..., 1] * b[..., 8] +
        -a[..., 2] * b[..., 6] +
        a[..., 3] * b[..., 5] +
        a[..., 4] * b[..., 15] +
        a[..., 5] * b[..., 3] +
        -a[..., 6] * b[..., 2] +
        -a[..., 7] * b[..., 14] +
        a[..., 8] * b[..., 1] +
        a[..., 9] * b[..., 13] +
        -a[..., 10] * b[..., 12] +
        a[..., 11] * b[..., 0] +
        a[..., 12] * b[..., 10] +
        -a[..., 13] * b[..., 9] +
        a[..., 14] * b[..., 7] +
        -a[..., 15] * b[..., 4]
    )
    r12 = (
        a[..., 0] * b[..., 12] +
        a[..., 1] * b[..., 9] +
        -a[..., 2] * b[..., 7] +
        -a[..., 3] * b[..., 15] +
        a[..., 4] * b[..., 5] +
        a[..., 5] * b[..., 4] +
        a[..., 6] * b[..., 14] +
        -a[..., 7] * b[..., 2] +
        -a[..., 8] * b[..., 13] +
        a[..., 9] * b[..., 1] +
        a[..., 10] * b[..., 11] +
        -a[..., 11] * b[..., 10] +
        a[..., 12] * b[..., 0] +
        a[..., 13] * b[..., 8] +
        -a[..., 14] * b[..., 6] +
        a[..., 15] * b[..., 3]
    )
    r13 = (
        a[..., 0] * b[..., 13] +
        a[..., 1] * b[..., 10] +
        a[..., 2] * b[..., 15] +
        -a[..., 3] * b[..., 7] +
        a[..., 4] * b[..., 6] +
        -a[..., 5] * b[..., 14] +
        a[..., 6] * b[..., 4] +
        -a[..., 7] * b[..., 3] +
        a[..., 8] * b[..., 12] +
        -a[..., 9] * b[..., 11] +
        a[..., 10] * b[..., 1] +
        a[..., 11] * b[..., 9] +
        -a[..., 12] * b[..., 8] +
        a[..., 13] * b[..., 0] +
        a[..., 14] * b[..., 5] +
        -a[..., 15] * b[..., 2]
    )
    r14 = (
        a[..., 0] * b[..., 14] +
        -a[..., 1] * b[..., 15] +
        a[..., 2] * b[..., 10] +
        -a[..., 3] * b[..., 9] +
        a[..., 4] * b[..., 8] +
        a[..., 5] * b[..., 13] +
        -a[..., 6] * b[..., 12] +
        a[..., 7] * b[..., 11] +
        a[..., 8] * b[..., 4] +
        -a[..., 9] * b[..., 3] +
        a[..., 10] * b[..., 2] +
        -a[..., 11] * b[..., 7] +
        a[..., 12] * b[..., 6] +
        -a[..., 13] * b[..., 5] +
        a[..., 14] * b[..., 0] +
        a[..., 15] * b[..., 1]
    )
    r15 = (
        a[..., 0] * b[..., 15] +
        a[..., 1] * b[..., 14] +
        -a[..., 2] * b[..., 13] +
        a[..., 3] * b[..., 12] +
        -a[..., 4] * b[..., 11] +
        a[..., 5] * b[..., 10] +
        -a[..., 6] * b[..., 9] +
        a[..., 7] * b[..., 8] +
        a[..., 8] * b[..., 7] +
        -a[..., 9] * b[..., 6] +
        a[..., 10] * b[..., 5] +
        a[..., 11] * b[..., 4] +
        -a[..., 12] * b[..., 3] +
        a[..., 13] * b[..., 2] +
        -a[..., 14] * b[..., 1] +
        a[..., 15] * b[..., 0]
    )

    return torch.stack([
        r0, r1, r2, r3, r4, r5, r6, r7,
        r8, r9, r10, r11, r12, r13, r14, r15,
    ], dim=-1)

# =============================================================================
# Reverse Operation
# =============================================================================

@torch.jit.script
def reverse(mv: Tensor) -> Tensor:
    """
    Compute reverse of a multivector in Cl(0, 4).

    For grade k: coefficient *= (-1)^(k*(k-1)/2)

    Args:
        mv: Input multivector, shape (..., 16)

    Returns:
        Reversed multivector, shape (..., 16)
    """
    r0 = mv[..., 0]
    r1 = mv[..., 1]
    r2 = mv[..., 2]
    r3 = mv[..., 3]
    r4 = mv[..., 4]
    r5 = -mv[..., 5]
    r6 = -mv[..., 6]
    r7 = -mv[..., 7]
    r8 = -mv[..., 8]
    r9 = -mv[..., 9]
    r10 = -mv[..., 10]
    r11 = -mv[..., 11]
    r12 = -mv[..., 12]
    r13 = -mv[..., 13]
    r14 = -mv[..., 14]
    r15 = mv[..., 15]

    return torch.stack([
        r0, r1, r2, r3, r4, r5, r6, r7,
        r8, r9, r10, r11, r12, r13, r14, r15,
    ], dim=-1)

# =============================================================================
# Grade Involution
# =============================================================================

@torch.jit.script
def involute(mv: Tensor) -> Tensor:
    """
    Compute grade involution of a multivector in Cl(0, 4).

    For grade k: coefficient *= (-1)^k

    Args:
        mv: Input multivector, shape (..., 16)

    Returns:
        Grade-involuted multivector, shape (..., 16)
    """
    r0 = mv[..., 0]
    r1 = -mv[..., 1]
    r2 = -mv[..., 2]
    r3 = -mv[..., 3]
    r4 = -mv[..., 4]
    r5 = mv[..., 5]
    r6 = mv[..., 6]
    r7 = mv[..., 7]
    r8 = mv[..., 8]
    r9 = mv[..., 9]
    r10 = mv[..., 10]
    r11 = -mv[..., 11]
    r12 = -mv[..., 12]
    r13 = -mv[..., 13]
    r14 = -mv[..., 14]
    r15 = mv[..., 15]

    return torch.stack([
        r0, r1, r2, r3, r4, r5, r6, r7,
        r8, r9, r10, r11, r12, r13, r14, r15,
    ], dim=-1)

# =============================================================================
# Clifford Conjugate
# =============================================================================

@torch.jit.script
def conjugate(mv: Tensor) -> Tensor:
    """
    Compute Clifford conjugate of a multivector in Cl(0, 4).

    For grade k: coefficient *= (-1)^(k*(k+1)/2)

    Args:
        mv: Input multivector, shape (..., 16)

    Returns:
        Conjugated multivector, shape (..., 16)
    """
    r0 = mv[..., 0]
    r1 = -mv[..., 1]
    r2 = -mv[..., 2]
    r3 = -mv[..., 3]
    r4 = -mv[..., 4]
    r5 = -mv[..., 5]
    r6 = -mv[..., 6]
    r7 = -mv[..., 7]
    r8 = -mv[..., 8]
    r9 = -mv[..., 9]
    r10 = -mv[..., 10]
    r11 = mv[..., 11]
    r12 = mv[..., 12]
    r13 = mv[..., 13]
    r14 = mv[..., 14]
    r15 = mv[..., 15]

    return torch.stack([
        r0, r1, r2, r3, r4, r5, r6, r7,
        r8, r9, r10, r11, r12, r13, r14, r15,
    ], dim=-1)

# =============================================================================
# Grade Selection
# =============================================================================

@torch.jit.script
def select_grade_0(mv: Tensor) -> Tensor:
    """
    Extract grade-0 components from multivector.

    Args:
        mv: Input multivector, shape (..., 16)

    Returns:
        Multivector with only grade-0 components, shape (..., 16)
    """
    r0 = mv[..., 0]
    r1 = torch.zeros_like(mv[..., 1])
    r2 = torch.zeros_like(mv[..., 2])
    r3 = torch.zeros_like(mv[..., 3])
    r4 = torch.zeros_like(mv[..., 4])
    r5 = torch.zeros_like(mv[..., 5])
    r6 = torch.zeros_like(mv[..., 6])
    r7 = torch.zeros_like(mv[..., 7])
    r8 = torch.zeros_like(mv[..., 8])
    r9 = torch.zeros_like(mv[..., 9])
    r10 = torch.zeros_like(mv[..., 10])
    r11 = torch.zeros_like(mv[..., 11])
    r12 = torch.zeros_like(mv[..., 12])
    r13 = torch.zeros_like(mv[..., 13])
    r14 = torch.zeros_like(mv[..., 14])
    r15 = torch.zeros_like(mv[..., 15])

    return torch.stack([
        r0, r1, r2, r3, r4, r5, r6, r7,
        r8, r9, r10, r11, r12, r13, r14, r15,
    ], dim=-1)


@torch.jit.script
def select_grade_1(mv: Tensor) -> Tensor:
    """
    Extract grade-1 components from multivector.

    Args:
        mv: Input multivector, shape (..., 16)

    Returns:
        Multivector with only grade-1 components, shape (..., 16)
    """
    r0 = torch.zeros_like(mv[..., 0])
    r1 = mv[..., 1]
    r2 = mv[..., 2]
    r3 = mv[..., 3]
    r4 = mv[..., 4]
    r5 = torch.zeros_like(mv[..., 5])
    r6 = torch.zeros_like(mv[..., 6])
    r7 = torch.zeros_like(mv[..., 7])
    r8 = torch.zeros_like(mv[..., 8])
    r9 = torch.zeros_like(mv[..., 9])
    r10 = torch.zeros_like(mv[..., 10])
    r11 = torch.zeros_like(mv[..., 11])
    r12 = torch.zeros_like(mv[..., 12])
    r13 = torch.zeros_like(mv[..., 13])
    r14 = torch.zeros_like(mv[..., 14])
    r15 = torch.zeros_like(mv[..., 15])

    return torch.stack([
        r0, r1, r2, r3, r4, r5, r6, r7,
        r8, r9, r10, r11, r12, r13, r14, r15,
    ], dim=-1)


@torch.jit.script
def select_grade_2(mv: Tensor) -> Tensor:
    """
    Extract grade-2 components from multivector.

    Args:
        mv: Input multivector, shape (..., 16)

    Returns:
        Multivector with only grade-2 components, shape (..., 16)
    """
    r0 = torch.zeros_like(mv[..., 0])
    r1 = torch.zeros_like(mv[..., 1])
    r2 = torch.zeros_like(mv[..., 2])
    r3 = torch.zeros_like(mv[..., 3])
    r4 = torch.zeros_like(mv[..., 4])
    r5 = mv[..., 5]
    r6 = mv[..., 6]
    r7 = mv[..., 7]
    r8 = mv[..., 8]
    r9 = mv[..., 9]
    r10 = mv[..., 10]
    r11 = torch.zeros_like(mv[..., 11])
    r12 = torch.zeros_like(mv[..., 12])
    r13 = torch.zeros_like(mv[..., 13])
    r14 = torch.zeros_like(mv[..., 14])
    r15 = torch.zeros_like(mv[..., 15])

    return torch.stack([
        r0, r1, r2, r3, r4, r5, r6, r7,
        r8, r9, r10, r11, r12, r13, r14, r15,
    ], dim=-1)


@torch.jit.script
def select_grade_3(mv: Tensor) -> Tensor:
    """
    Extract grade-3 components from multivector.

    Args:
        mv: Input multivector, shape (..., 16)

    Returns:
        Multivector with only grade-3 components, shape (..., 16)
    """
    r0 = torch.zeros_like(mv[..., 0])
    r1 = torch.zeros_like(mv[..., 1])
    r2 = torch.zeros_like(mv[..., 2])
    r3 = torch.zeros_like(mv[..., 3])
    r4 = torch.zeros_like(mv[..., 4])
    r5 = torch.zeros_like(mv[..., 5])
    r6 = torch.zeros_like(mv[..., 6])
    r7 = torch.zeros_like(mv[..., 7])
    r8 = torch.zeros_like(mv[..., 8])
    r9 = torch.zeros_like(mv[..., 9])
    r10 = torch.zeros_like(mv[..., 10])
    r11 = mv[..., 11]
    r12 = mv[..., 12]
    r13 = mv[..., 13]
    r14 = mv[..., 14]
    r15 = torch.zeros_like(mv[..., 15])

    return torch.stack([
        r0, r1, r2, r3, r4, r5, r6, r7,
        r8, r9, r10, r11, r12, r13, r14, r15,
    ], dim=-1)


@torch.jit.script
def select_grade_4(mv: Tensor) -> Tensor:
    """
    Extract grade-4 components from multivector.

    Args:
        mv: Input multivector, shape (..., 16)

    Returns:
        Multivector with only grade-4 components, shape (..., 16)
    """
    r0 = torch.zeros_like(mv[..., 0])
    r1 = torch.zeros_like(mv[..., 1])
    r2 = torch.zeros_like(mv[..., 2])
    r3 = torch.zeros_like(mv[..., 3])
    r4 = torch.zeros_like(mv[..., 4])
    r5 = torch.zeros_like(mv[..., 5])
    r6 = torch.zeros_like(mv[..., 6])
    r7 = torch.zeros_like(mv[..., 7])
    r8 = torch.zeros_like(mv[..., 8])
    r9 = torch.zeros_like(mv[..., 9])
    r10 = torch.zeros_like(mv[..., 10])
    r11 = torch.zeros_like(mv[..., 11])
    r12 = torch.zeros_like(mv[..., 12])
    r13 = torch.zeros_like(mv[..., 13])
    r14 = torch.zeros_like(mv[..., 14])
    r15 = mv[..., 15]

    return torch.stack([
        r0, r1, r2, r3, r4, r5, r6, r7,
        r8, r9, r10, r11, r12, r13, r14, r15,
    ], dim=-1)


# =============================================================================
# Inner Product
# =============================================================================

@torch.jit.script
def inner(a: Tensor, b: Tensor) -> Tensor:
    """
    Compute inner product <ab>_0 in Cl(0, 4).

    Args:
        a: Left operand, shape (..., 16)
        b: Right operand, shape (..., 16)

    Returns:
        Scalar result, shape (..., 1)
    """
    result = (
        a[..., 0] * b[..., 0] +
        -a[..., 1] * b[..., 1] +
        -a[..., 2] * b[..., 2] +
        -a[..., 3] * b[..., 3] +
        -a[..., 4] * b[..., 4] +
        -a[..., 5] * b[..., 5] +
        -a[..., 6] * b[..., 6] +
        -a[..., 7] * b[..., 7] +
        -a[..., 8] * b[..., 8] +
        -a[..., 9] * b[..., 9] +
        -a[..., 10] * b[..., 10] +
        a[..., 11] * b[..., 11] +
        a[..., 12] * b[..., 12] +
        a[..., 13] * b[..., 13] +
        a[..., 14] * b[..., 14] +
        a[..., 15] * b[..., 15]
    )
    return result.unsqueeze(-1)

# =============================================================================
# Outer Product (Wedge)
# =============================================================================

@torch.jit.script
def outer(a: Tensor, b: Tensor) -> Tensor:
    """
    Compute outer product a ^ b in Cl(0, 4).

    Args:
        a: Left operand, shape (..., 16)
        b: Right operand, shape (..., 16)

    Returns:
        Result multivector, shape (..., 16)
    """
    r0 = a[..., 0] * b[..., 0]
    r1 = a[..., 0] * b[..., 1] + a[..., 1] * b[..., 0]
    r2 = a[..., 0] * b[..., 2] + a[..., 2] * b[..., 0]
    r3 = a[..., 0] * b[..., 3] + a[..., 3] * b[..., 0]
    r4 = a[..., 0] * b[..., 4] + a[..., 4] * b[..., 0]
    r5 = (
        a[..., 0] * b[..., 5] +
        a[..., 1] * b[..., 2] +
        -a[..., 2] * b[..., 1] +
        a[..., 5] * b[..., 0]
    )
    r6 = (
        a[..., 0] * b[..., 6] +
        a[..., 1] * b[..., 3] +
        -a[..., 3] * b[..., 1] +
        a[..., 6] * b[..., 0]
    )
    r7 = (
        a[..., 0] * b[..., 7] +
        a[..., 1] * b[..., 4] +
        -a[..., 4] * b[..., 1] +
        a[..., 7] * b[..., 0]
    )
    r8 = (
        a[..., 0] * b[..., 8] +
        a[..., 2] * b[..., 3] +
        -a[..., 3] * b[..., 2] +
        a[..., 8] * b[..., 0]
    )
    r9 = (
        a[..., 0] * b[..., 9] +
        a[..., 2] * b[..., 4] +
        -a[..., 4] * b[..., 2] +
        a[..., 9] * b[..., 0]
    )
    r10 = (
        a[..., 0] * b[..., 10] +
        a[..., 3] * b[..., 4] +
        -a[..., 4] * b[..., 3] +
        a[..., 10] * b[..., 0]
    )
    r11 = (
        a[..., 0] * b[..., 11] +
        a[..., 1] * b[..., 8] +
        -a[..., 2] * b[..., 6] +
        a[..., 3] * b[..., 5] +
        a[..., 5] * b[..., 3] +
        -a[..., 6] * b[..., 2] +
        a[..., 8] * b[..., 1] +
        a[..., 11] * b[..., 0]
    )
    r12 = (
        a[..., 0] * b[..., 12] +
        a[..., 1] * b[..., 9] +
        -a[..., 2] * b[..., 7] +
        a[..., 4] * b[..., 5] +
        a[..., 5] * b[..., 4] +
        -a[..., 7] * b[..., 2] +
        a[..., 9] * b[..., 1] +
        a[..., 12] * b[..., 0]
    )
    r13 = (
        a[..., 0] * b[..., 13] +
        a[..., 1] * b[..., 10] +
        -a[..., 3] * b[..., 7] +
        a[..., 4] * b[..., 6] +
        a[..., 6] * b[..., 4] +
        -a[..., 7] * b[..., 3] +
        a[..., 10] * b[..., 1] +
        a[..., 13] * b[..., 0]
    )
    r14 = (
        a[..., 0] * b[..., 14] +
        a[..., 2] * b[..., 10] +
        -a[..., 3] * b[..., 9] +
        a[..., 4] * b[..., 8] +
        a[..., 8] * b[..., 4] +
        -a[..., 9] * b[..., 3] +
        a[..., 10] * b[..., 2] +
        a[..., 14] * b[..., 0]
    )
    r15 = (
        a[..., 0] * b[..., 15] +
        a[..., 1] * b[..., 14] +
        -a[..., 2] * b[..., 13] +
        a[..., 3] * b[..., 12] +
        -a[..., 4] * b[..., 11] +
        a[..., 5] * b[..., 10] +
        -a[..., 6] * b[..., 9] +
        a[..., 7] * b[..., 8] +
        a[..., 8] * b[..., 7] +
        -a[..., 9] * b[..., 6] +
        a[..., 10] * b[..., 5] +
        a[..., 11] * b[..., 4] +
        -a[..., 12] * b[..., 3] +
        a[..., 13] * b[..., 2] +
        -a[..., 14] * b[..., 1] +
        a[..., 15] * b[..., 0]
    )

    return torch.stack([
        r0, r1, r2, r3, r4, r5, r6, r7,
        r8, r9, r10, r11, r12, r13, r14, r15,
    ], dim=-1)

# =============================================================================
# Left Contraction
# =============================================================================

@torch.jit.script
def contract_left(a: Tensor, b: Tensor) -> Tensor:
    """
    Compute left contraction a << b in Cl(0, 4).

    Args:
        a: Left operand, shape (..., 16)
        b: Right operand, shape (..., 16)

    Returns:
        Result multivector, shape (..., 16)
    """
    r0 = (
        a[..., 0] * b[..., 0] +
        -a[..., 1] * b[..., 1] +
        -a[..., 2] * b[..., 2] +
        -a[..., 3] * b[..., 3] +
        -a[..., 4] * b[..., 4] +
        -a[..., 5] * b[..., 5] +
        -a[..., 6] * b[..., 6] +
        -a[..., 7] * b[..., 7] +
        -a[..., 8] * b[..., 8] +
        -a[..., 9] * b[..., 9] +
        -a[..., 10] * b[..., 10] +
        a[..., 11] * b[..., 11] +
        a[..., 12] * b[..., 12] +
        a[..., 13] * b[..., 13] +
        a[..., 14] * b[..., 14] +
        a[..., 15] * b[..., 15]
    )
    r1 = (
        a[..., 0] * b[..., 1] +
        a[..., 2] * b[..., 5] +
        a[..., 3] * b[..., 6] +
        a[..., 4] * b[..., 7] +
        -a[..., 8] * b[..., 11] +
        -a[..., 9] * b[..., 12] +
        -a[..., 10] * b[..., 13] +
        -a[..., 14] * b[..., 15]
    )
    r2 = (
        a[..., 0] * b[..., 2] +
        -a[..., 1] * b[..., 5] +
        a[..., 3] * b[..., 8] +
        a[..., 4] * b[..., 9] +
        a[..., 6] * b[..., 11] +
        a[..., 7] * b[..., 12] +
        -a[..., 10] * b[..., 14] +
        a[..., 13] * b[..., 15]
    )
    r3 = (
        a[..., 0] * b[..., 3] +
        -a[..., 1] * b[..., 6] +
        -a[..., 2] * b[..., 8] +
        a[..., 4] * b[..., 10] +
        -a[..., 5] * b[..., 11] +
        a[..., 7] * b[..., 13] +
        a[..., 9] * b[..., 14] +
        -a[..., 12] * b[..., 15]
    )
    r4 = (
        a[..., 0] * b[..., 4] +
        -a[..., 1] * b[..., 7] +
        -a[..., 2] * b[..., 9] +
        -a[..., 3] * b[..., 10] +
        -a[..., 5] * b[..., 12] +
        -a[..., 6] * b[..., 13] +
        -a[..., 8] * b[..., 14] +
        a[..., 11] * b[..., 15]
    )
    r5 = (
        a[..., 0] * b[..., 5] +
        -a[..., 3] * b[..., 11] +
        -a[..., 4] * b[..., 12] +
        -a[..., 10] * b[..., 15]
    )
    r6 = (
        a[..., 0] * b[..., 6] +
        a[..., 2] * b[..., 11] +
        -a[..., 4] * b[..., 13] +
        a[..., 9] * b[..., 15]
    )
    r7 = (
        a[..., 0] * b[..., 7] +
        a[..., 2] * b[..., 12] +
        a[..., 3] * b[..., 13] +
        -a[..., 8] * b[..., 15]
    )
    r8 = (
        a[..., 0] * b[..., 8] +
        -a[..., 1] * b[..., 11] +
        -a[..., 4] * b[..., 14] +
        -a[..., 7] * b[..., 15]
    )
    r9 = (
        a[..., 0] * b[..., 9] +
        -a[..., 1] * b[..., 12] +
        a[..., 3] * b[..., 14] +
        a[..., 6] * b[..., 15]
    )
    r10 = (
        a[..., 0] * b[..., 10] +
        -a[..., 1] * b[..., 13] +
        -a[..., 2] * b[..., 14] +
        -a[..., 5] * b[..., 15]
    )
    r11 = a[..., 0] * b[..., 11] + a[..., 4] * b[..., 15]
    r12 = a[..., 0] * b[..., 12] + -a[..., 3] * b[..., 15]
    r13 = a[..., 0] * b[..., 13] + a[..., 2] * b[..., 15]
    r14 = a[..., 0] * b[..., 14] + -a[..., 1] * b[..., 15]
    r15 = a[..., 0] * b[..., 15]

    return torch.stack([
        r0, r1, r2, r3, r4, r5, r6, r7,
        r8, r9, r10, r11, r12, r13, r14, r15,
    ], dim=-1)

# =============================================================================
# Right Contraction
# =============================================================================

@torch.jit.script
def contract_right(a: Tensor, b: Tensor) -> Tensor:
    """
    Compute right contraction a >> b in Cl(0, 4).

    Args:
        a: Left operand, shape (..., 16)
        b: Right operand, shape (..., 16)

    Returns:
        Result multivector, shape (..., 16)
    """
    r0 = (
        a[..., 0] * b[..., 0] +
        -a[..., 1] * b[..., 1] +
        -a[..., 2] * b[..., 2] +
        -a[..., 3] * b[..., 3] +
        -a[..., 4] * b[..., 4] +
        -a[..., 5] * b[..., 5] +
        -a[..., 6] * b[..., 6] +
        -a[..., 7] * b[..., 7] +
        -a[..., 8] * b[..., 8] +
        -a[..., 9] * b[..., 9] +
        -a[..., 10] * b[..., 10] +
        a[..., 11] * b[..., 11] +
        a[..., 12] * b[..., 12] +
        a[..., 13] * b[..., 13] +
        a[..., 14] * b[..., 14] +
        a[..., 15] * b[..., 15]
    )
    r1 = (
        a[..., 1] * b[..., 0] +
        -a[..., 5] * b[..., 2] +
        -a[..., 6] * b[..., 3] +
        -a[..., 7] * b[..., 4] +
        -a[..., 11] * b[..., 8] +
        -a[..., 12] * b[..., 9] +
        -a[..., 13] * b[..., 10] +
        a[..., 15] * b[..., 14]
    )
    r2 = (
        a[..., 2] * b[..., 0] +
        a[..., 5] * b[..., 1] +
        -a[..., 8] * b[..., 3] +
        -a[..., 9] * b[..., 4] +
        a[..., 11] * b[..., 6] +
        a[..., 12] * b[..., 7] +
        -a[..., 14] * b[..., 10] +
        -a[..., 15] * b[..., 13]
    )
    r3 = (
        a[..., 3] * b[..., 0] +
        a[..., 6] * b[..., 1] +
        a[..., 8] * b[..., 2] +
        -a[..., 10] * b[..., 4] +
        -a[..., 11] * b[..., 5] +
        a[..., 13] * b[..., 7] +
        a[..., 14] * b[..., 9] +
        a[..., 15] * b[..., 12]
    )
    r4 = (
        a[..., 4] * b[..., 0] +
        a[..., 7] * b[..., 1] +
        a[..., 9] * b[..., 2] +
        a[..., 10] * b[..., 3] +
        -a[..., 12] * b[..., 5] +
        -a[..., 13] * b[..., 6] +
        -a[..., 14] * b[..., 8] +
        -a[..., 15] * b[..., 11]
    )
    r5 = (
        a[..., 5] * b[..., 0] +
        -a[..., 11] * b[..., 3] +
        -a[..., 12] * b[..., 4] +
        -a[..., 15] * b[..., 10]
    )
    r6 = (
        a[..., 6] * b[..., 0] +
        a[..., 11] * b[..., 2] +
        -a[..., 13] * b[..., 4] +
        a[..., 15] * b[..., 9]
    )
    r7 = (
        a[..., 7] * b[..., 0] +
        a[..., 12] * b[..., 2] +
        a[..., 13] * b[..., 3] +
        -a[..., 15] * b[..., 8]
    )
    r8 = (
        a[..., 8] * b[..., 0] +
        -a[..., 11] * b[..., 1] +
        -a[..., 14] * b[..., 4] +
        -a[..., 15] * b[..., 7]
    )
    r9 = (
        a[..., 9] * b[..., 0] +
        -a[..., 12] * b[..., 1] +
        a[..., 14] * b[..., 3] +
        a[..., 15] * b[..., 6]
    )
    r10 = (
        a[..., 10] * b[..., 0] +
        -a[..., 13] * b[..., 1] +
        -a[..., 14] * b[..., 2] +
        -a[..., 15] * b[..., 5]
    )
    r11 = a[..., 11] * b[..., 0] + -a[..., 15] * b[..., 4]
    r12 = a[..., 12] * b[..., 0] + a[..., 15] * b[..., 3]
    r13 = a[..., 13] * b[..., 0] + -a[..., 15] * b[..., 2]
    r14 = a[..., 14] * b[..., 0] + a[..., 15] * b[..., 1]
    r15 = a[..., 15] * b[..., 0]

    return torch.stack([
        r0, r1, r2, r3, r4, r5, r6, r7,
        r8, r9, r10, r11, r12, r13, r14, r15,
    ], dim=-1)

# =============================================================================
# Dual (Left Contraction with Pseudoscalar)
# =============================================================================

@torch.jit.script
def dual(mv: Tensor) -> Tensor:
    """
    Compute dual mv* = mv << I in Cl(0, 4).

    Args:
        mv: Input multivector, shape (..., 16)

    Returns:
        Dual multivector, shape (..., 16)
    """
    r0 = mv[..., 15]
    r1 = -mv[..., 14]
    r2 = mv[..., 13]
    r3 = -mv[..., 12]
    r4 = mv[..., 11]
    r5 = -mv[..., 10]
    r6 = mv[..., 9]
    r7 = -mv[..., 8]
    r8 = -mv[..., 7]
    r9 = mv[..., 6]
    r10 = -mv[..., 5]
    r11 = mv[..., 4]
    r12 = -mv[..., 3]
    r13 = mv[..., 2]
    r14 = -mv[..., 1]
    r15 = mv[..., 0]

    return torch.stack([
        r0, r1, r2, r3, r4, r5, r6, r7,
        r8, r9, r10, r11, r12, r13, r14, r15,
    ], dim=-1)

# =============================================================================
# Norm Squared
# =============================================================================

@torch.jit.script
def norm_squared(mv: Tensor) -> Tensor:
    """
    Compute norm squared |mv|^2 = <mv * ~mv>_0 in Cl(0, 4).

    Args:
        mv: Input multivector, shape (..., 16)

    Returns:
        Norm squared, shape (..., 1)
    """
    result = (
        mv[..., 0] * mv[..., 0] +
        -mv[..., 1] * mv[..., 1] +
        -mv[..., 2] * mv[..., 2] +
        -mv[..., 3] * mv[..., 3] +
        -mv[..., 4] * mv[..., 4] +
        mv[..., 5] * mv[..., 5] +
        mv[..., 6] * mv[..., 6] +
        mv[..., 7] * mv[..., 7] +
        mv[..., 8] * mv[..., 8] +
        mv[..., 9] * mv[..., 9] +
        mv[..., 10] * mv[..., 10] +
        -mv[..., 11] * mv[..., 11] +
        -mv[..., 12] * mv[..., 12] +
        -mv[..., 13] * mv[..., 13] +
        -mv[..., 14] * mv[..., 14] +
        mv[..., 15] * mv[..., 15]
    )
    return result.unsqueeze(-1)

# =============================================================================
# Rotor Composition
# =============================================================================

@torch.jit.script
def compose_rotor(r1: Tensor, r2: Tensor) -> Tensor:
    """
    Compose two rotors r1 * r2 in Cl(0, 4).

    Args:
        r1: Left rotor, shape (..., 8)
        r2: Right rotor, shape (..., 8)

    Returns:
        Composed rotor, shape (..., 8)
    """
    out0 = (
        r1[..., 0] * r2[..., 0] +
        -r1[..., 1] * r2[..., 1] +
        -r1[..., 2] * r2[..., 2] +
        -r1[..., 3] * r2[..., 3] +
        -r1[..., 4] * r2[..., 4] +
        -r1[..., 5] * r2[..., 5] +
        -r1[..., 6] * r2[..., 6] +
        r1[..., 7] * r2[..., 7]
    )
    out1 = (
        r1[..., 0] * r2[..., 1] +
        r1[..., 1] * r2[..., 0] +
        r1[..., 2] * r2[..., 4] +
        r1[..., 3] * r2[..., 5] +
        -r1[..., 4] * r2[..., 2] +
        -r1[..., 5] * r2[..., 3] +
        -r1[..., 6] * r2[..., 7] +
        -r1[..., 7] * r2[..., 6]
    )
    out2 = (
        r1[..., 0] * r2[..., 2] +
        -r1[..., 1] * r2[..., 4] +
        r1[..., 2] * r2[..., 0] +
        r1[..., 3] * r2[..., 6] +
        r1[..., 4] * r2[..., 1] +
        r1[..., 5] * r2[..., 7] +
        -r1[..., 6] * r2[..., 3] +
        r1[..., 7] * r2[..., 5]
    )
    out3 = (
        r1[..., 0] * r2[..., 3] +
        -r1[..., 1] * r2[..., 5] +
        -r1[..., 2] * r2[..., 6] +
        r1[..., 3] * r2[..., 0] +
        -r1[..., 4] * r2[..., 7] +
        r1[..., 5] * r2[..., 1] +
        r1[..., 6] * r2[..., 2] +
        -r1[..., 7] * r2[..., 4]
    )
    out4 = (
        r1[..., 0] * r2[..., 4] +
        r1[..., 1] * r2[..., 2] +
        -r1[..., 2] * r2[..., 1] +
        -r1[..., 3] * r2[..., 7] +
        r1[..., 4] * r2[..., 0] +
        r1[..., 5] * r2[..., 6] +
        -r1[..., 6] * r2[..., 5] +
        -r1[..., 7] * r2[..., 3]
    )
    out5 = (
        r1[..., 0] * r2[..., 5] +
        r1[..., 1] * r2[..., 3] +
        r1[..., 2] * r2[..., 7] +
        -r1[..., 3] * r2[..., 1] +
        -r1[..., 4] * r2[..., 6] +
        r1[..., 5] * r2[..., 0] +
        r1[..., 6] * r2[..., 4] +
        r1[..., 7] * r2[..., 2]
    )
    out6 = (
        r1[..., 0] * r2[..., 6] +
        -r1[..., 1] * r2[..., 7] +
        r1[..., 2] * r2[..., 3] +
        -r1[..., 3] * r2[..., 2] +
        r1[..., 4] * r2[..., 5] +
        -r1[..., 5] * r2[..., 4] +
        r1[..., 6] * r2[..., 0] +
        -r1[..., 7] * r2[..., 1]
    )
    out7 = (
        r1[..., 0] * r2[..., 7] +
        r1[..., 1] * r2[..., 6] +
        -r1[..., 2] * r2[..., 5] +
        r1[..., 3] * r2[..., 4] +
        r1[..., 4] * r2[..., 3] +
        -r1[..., 5] * r2[..., 2] +
        r1[..., 6] * r2[..., 1] +
        r1[..., 7] * r2[..., 0]
    )

    return torch.stack([
        out0, out1, out2, out3, out4, out5, out6, out7,
    ], dim=-1)

# =============================================================================
# Rotor Reverse
# =============================================================================

@torch.jit.script
def reverse_rotor(r: Tensor) -> Tensor:
    """
    Compute reverse of a rotor in Cl(0, 4).

    Args:
        r: Input rotor, shape (..., 8)

    Returns:
        Reversed rotor, shape (..., 8)
    """
    r0 = r[..., 0]
    r1 = -r[..., 1]
    r2 = -r[..., 2]
    r3 = -r[..., 3]
    r4 = -r[..., 4]
    r5 = -r[..., 5]
    r6 = -r[..., 6]
    r7 = r[..., 7]

    return torch.stack([
        r0, r1, r2, r3, r4, r5, r6, r7,
    ], dim=-1)

# =============================================================================
# Rotor Sandwich Product
# =============================================================================

@torch.jit.script
def sandwich_rotor(r: Tensor, x: Tensor) -> Tensor:
    """
    Compute sandwich product r * x * ~r in Cl(0, 4).

    Args:
        r: Rotor, shape (..., 8)
        x: Operand multivector, shape (..., 16)

    Returns:
        Transformed multivector, shape (..., 16)

    Note:
        This is a simplified implementation. Optimized sparse versions
        can be generated for specific input types (e.g., vectors).
    """
    # Expand rotor to full multivector
    rf0 = r[..., 0]
    rf1 = torch.zeros_like(r[..., 0])
    rf2 = torch.zeros_like(r[..., 0])
    rf3 = torch.zeros_like(r[..., 0])
    rf4 = torch.zeros_like(r[..., 0])
    rf5 = r[..., 1]
    rf6 = r[..., 2]
    rf7 = r[..., 3]
    rf8 = r[..., 4]
    rf9 = r[..., 5]
    rf10 = r[..., 6]
    rf11 = torch.zeros_like(r[..., 0])
    rf12 = torch.zeros_like(r[..., 0])
    rf13 = torch.zeros_like(r[..., 0])
    rf14 = torch.zeros_like(r[..., 0])
    rf15 = r[..., 7]

    # Compute r * x
    t0 = (
        rf0 * x[..., 0] +
        -rf1 * x[..., 1] +
        -rf2 * x[..., 2] +
        -rf3 * x[..., 3] +
        -rf4 * x[..., 4] +
        -rf5 * x[..., 5] +
        -rf6 * x[..., 6] +
        -rf7 * x[..., 7] +
        -rf8 * x[..., 8] +
        -rf9 * x[..., 9] +
        -rf10 * x[..., 10] +
        rf11 * x[..., 11] +
        rf12 * x[..., 12] +
        rf13 * x[..., 13] +
        rf14 * x[..., 14] +
        rf15 * x[..., 15]
    )
    t1 = (
        rf0 * x[..., 1] +
        rf1 * x[..., 0] +
        rf2 * x[..., 5] +
        rf3 * x[..., 6] +
        rf4 * x[..., 7] +
        -rf5 * x[..., 2] +
        -rf6 * x[..., 3] +
        -rf7 * x[..., 4] +
        -rf8 * x[..., 11] +
        -rf9 * x[..., 12] +
        -rf10 * x[..., 13] +
        -rf11 * x[..., 8] +
        -rf12 * x[..., 9] +
        -rf13 * x[..., 10] +
        -rf14 * x[..., 15] +
        rf15 * x[..., 14]
    )
    t2 = (
        rf0 * x[..., 2] +
        -rf1 * x[..., 5] +
        rf2 * x[..., 0] +
        rf3 * x[..., 8] +
        rf4 * x[..., 9] +
        rf5 * x[..., 1] +
        rf6 * x[..., 11] +
        rf7 * x[..., 12] +
        -rf8 * x[..., 3] +
        -rf9 * x[..., 4] +
        -rf10 * x[..., 14] +
        rf11 * x[..., 6] +
        rf12 * x[..., 7] +
        rf13 * x[..., 15] +
        -rf14 * x[..., 10] +
        -rf15 * x[..., 13]
    )
    t3 = (
        rf0 * x[..., 3] +
        -rf1 * x[..., 6] +
        -rf2 * x[..., 8] +
        rf3 * x[..., 0] +
        rf4 * x[..., 10] +
        -rf5 * x[..., 11] +
        rf6 * x[..., 1] +
        rf7 * x[..., 13] +
        rf8 * x[..., 2] +
        rf9 * x[..., 14] +
        -rf10 * x[..., 4] +
        -rf11 * x[..., 5] +
        -rf12 * x[..., 15] +
        rf13 * x[..., 7] +
        rf14 * x[..., 9] +
        rf15 * x[..., 12]
    )
    t4 = (
        rf0 * x[..., 4] +
        -rf1 * x[..., 7] +
        -rf2 * x[..., 9] +
        -rf3 * x[..., 10] +
        rf4 * x[..., 0] +
        -rf5 * x[..., 12] +
        -rf6 * x[..., 13] +
        rf7 * x[..., 1] +
        -rf8 * x[..., 14] +
        rf9 * x[..., 2] +
        rf10 * x[..., 3] +
        rf11 * x[..., 15] +
        -rf12 * x[..., 5] +
        -rf13 * x[..., 6] +
        -rf14 * x[..., 8] +
        -rf15 * x[..., 11]
    )
    t5 = (
        rf0 * x[..., 5] +
        rf1 * x[..., 2] +
        -rf2 * x[..., 1] +
        -rf3 * x[..., 11] +
        -rf4 * x[..., 12] +
        rf5 * x[..., 0] +
        rf6 * x[..., 8] +
        rf7 * x[..., 9] +
        -rf8 * x[..., 6] +
        -rf9 * x[..., 7] +
        -rf10 * x[..., 15] +
        -rf11 * x[..., 3] +
        -rf12 * x[..., 4] +
        -rf13 * x[..., 14] +
        rf14 * x[..., 13] +
        -rf15 * x[..., 10]
    )
    t6 = (
        rf0 * x[..., 6] +
        rf1 * x[..., 3] +
        rf2 * x[..., 11] +
        -rf3 * x[..., 1] +
        -rf4 * x[..., 13] +
        -rf5 * x[..., 8] +
        rf6 * x[..., 0] +
        rf7 * x[..., 10] +
        rf8 * x[..., 5] +
        rf9 * x[..., 15] +
        -rf10 * x[..., 7] +
        rf11 * x[..., 2] +
        rf12 * x[..., 14] +
        -rf13 * x[..., 4] +
        -rf14 * x[..., 12] +
        rf15 * x[..., 9]
    )
    t7 = (
        rf0 * x[..., 7] +
        rf1 * x[..., 4] +
        rf2 * x[..., 12] +
        rf3 * x[..., 13] +
        -rf4 * x[..., 1] +
        -rf5 * x[..., 9] +
        -rf6 * x[..., 10] +
        rf7 * x[..., 0] +
        -rf8 * x[..., 15] +
        rf9 * x[..., 5] +
        rf10 * x[..., 6] +
        -rf11 * x[..., 14] +
        rf12 * x[..., 2] +
        rf13 * x[..., 3] +
        rf14 * x[..., 11] +
        -rf15 * x[..., 8]
    )
    t8 = (
        rf0 * x[..., 8] +
        -rf1 * x[..., 11] +
        rf2 * x[..., 3] +
        -rf3 * x[..., 2] +
        -rf4 * x[..., 14] +
        rf5 * x[..., 6] +
        -rf6 * x[..., 5] +
        -rf7 * x[..., 15] +
        rf8 * x[..., 0] +
        rf9 * x[..., 10] +
        -rf10 * x[..., 9] +
        -rf11 * x[..., 1] +
        -rf12 * x[..., 13] +
        rf13 * x[..., 12] +
        -rf14 * x[..., 4] +
        -rf15 * x[..., 7]
    )
    t9 = (
        rf0 * x[..., 9] +
        -rf1 * x[..., 12] +
        rf2 * x[..., 4] +
        rf3 * x[..., 14] +
        -rf4 * x[..., 2] +
        rf5 * x[..., 7] +
        rf6 * x[..., 15] +
        -rf7 * x[..., 5] +
        -rf8 * x[..., 10] +
        rf9 * x[..., 0] +
        rf10 * x[..., 8] +
        rf11 * x[..., 13] +
        -rf12 * x[..., 1] +
        -rf13 * x[..., 11] +
        rf14 * x[..., 3] +
        rf15 * x[..., 6]
    )
    t10 = (
        rf0 * x[..., 10] +
        -rf1 * x[..., 13] +
        -rf2 * x[..., 14] +
        rf3 * x[..., 4] +
        -rf4 * x[..., 3] +
        -rf5 * x[..., 15] +
        rf6 * x[..., 7] +
        -rf7 * x[..., 6] +
        rf8 * x[..., 9] +
        -rf9 * x[..., 8] +
        rf10 * x[..., 0] +
        -rf11 * x[..., 12] +
        rf12 * x[..., 11] +
        -rf13 * x[..., 1] +
        -rf14 * x[..., 2] +
        -rf15 * x[..., 5]
    )
    t11 = (
        rf0 * x[..., 11] +
        rf1 * x[..., 8] +
        -rf2 * x[..., 6] +
        rf3 * x[..., 5] +
        rf4 * x[..., 15] +
        rf5 * x[..., 3] +
        -rf6 * x[..., 2] +
        -rf7 * x[..., 14] +
        rf8 * x[..., 1] +
        rf9 * x[..., 13] +
        -rf10 * x[..., 12] +
        rf11 * x[..., 0] +
        rf12 * x[..., 10] +
        -rf13 * x[..., 9] +
        rf14 * x[..., 7] +
        -rf15 * x[..., 4]
    )
    t12 = (
        rf0 * x[..., 12] +
        rf1 * x[..., 9] +
        -rf2 * x[..., 7] +
        -rf3 * x[..., 15] +
        rf4 * x[..., 5] +
        rf5 * x[..., 4] +
        rf6 * x[..., 14] +
        -rf7 * x[..., 2] +
        -rf8 * x[..., 13] +
        rf9 * x[..., 1] +
        rf10 * x[..., 11] +
        -rf11 * x[..., 10] +
        rf12 * x[..., 0] +
        rf13 * x[..., 8] +
        -rf14 * x[..., 6] +
        rf15 * x[..., 3]
    )
    t13 = (
        rf0 * x[..., 13] +
        rf1 * x[..., 10] +
        rf2 * x[..., 15] +
        -rf3 * x[..., 7] +
        rf4 * x[..., 6] +
        -rf5 * x[..., 14] +
        rf6 * x[..., 4] +
        -rf7 * x[..., 3] +
        rf8 * x[..., 12] +
        -rf9 * x[..., 11] +
        rf10 * x[..., 1] +
        rf11 * x[..., 9] +
        -rf12 * x[..., 8] +
        rf13 * x[..., 0] +
        rf14 * x[..., 5] +
        -rf15 * x[..., 2]
    )
    t14 = (
        rf0 * x[..., 14] +
        -rf1 * x[..., 15] +
        rf2 * x[..., 10] +
        -rf3 * x[..., 9] +
        rf4 * x[..., 8] +
        rf5 * x[..., 13] +
        -rf6 * x[..., 12] +
        rf7 * x[..., 11] +
        rf8 * x[..., 4] +
        -rf9 * x[..., 3] +
        rf10 * x[..., 2] +
        -rf11 * x[..., 7] +
        rf12 * x[..., 6] +
        -rf13 * x[..., 5] +
        rf14 * x[..., 0] +
        rf15 * x[..., 1]
    )
    t15 = (
        rf0 * x[..., 15] +
        rf1 * x[..., 14] +
        -rf2 * x[..., 13] +
        rf3 * x[..., 12] +
        -rf4 * x[..., 11] +
        rf5 * x[..., 10] +
        -rf6 * x[..., 9] +
        rf7 * x[..., 8] +
        rf8 * x[..., 7] +
        -rf9 * x[..., 6] +
        rf10 * x[..., 5] +
        rf11 * x[..., 4] +
        -rf12 * x[..., 3] +
        rf13 * x[..., 2] +
        -rf14 * x[..., 1] +
        rf15 * x[..., 0]
    )

    # Compute ~r
    rr0 = rf0
    rr1 = torch.zeros_like(r[..., 0])
    rr2 = torch.zeros_like(r[..., 0])
    rr3 = torch.zeros_like(r[..., 0])
    rr4 = torch.zeros_like(r[..., 0])
    rr5 = -rf5
    rr6 = -rf6
    rr7 = -rf7
    rr8 = -rf8
    rr9 = -rf9
    rr10 = -rf10
    rr11 = torch.zeros_like(r[..., 0])
    rr12 = torch.zeros_like(r[..., 0])
    rr13 = torch.zeros_like(r[..., 0])
    rr14 = torch.zeros_like(r[..., 0])
    rr15 = rf15

    # Compute (r * x) * ~r
    s0 = (
        t0 * rr0 +
        -t1 * rr1 +
        -t2 * rr2 +
        -t3 * rr3 +
        -t4 * rr4 +
        -t5 * rr5 +
        -t6 * rr6 +
        -t7 * rr7 +
        -t8 * rr8 +
        -t9 * rr9 +
        -t10 * rr10 +
        t11 * rr11 +
        t12 * rr12 +
        t13 * rr13 +
        t14 * rr14 +
        t15 * rr15
    )
    s1 = (
        t0 * rr1 +
        t1 * rr0 +
        t2 * rr5 +
        t3 * rr6 +
        t4 * rr7 +
        -t5 * rr2 +
        -t6 * rr3 +
        -t7 * rr4 +
        -t8 * rr11 +
        -t9 * rr12 +
        -t10 * rr13 +
        -t11 * rr8 +
        -t12 * rr9 +
        -t13 * rr10 +
        -t14 * rr15 +
        t15 * rr14
    )
    s2 = (
        t0 * rr2 +
        -t1 * rr5 +
        t2 * rr0 +
        t3 * rr8 +
        t4 * rr9 +
        t5 * rr1 +
        t6 * rr11 +
        t7 * rr12 +
        -t8 * rr3 +
        -t9 * rr4 +
        -t10 * rr14 +
        t11 * rr6 +
        t12 * rr7 +
        t13 * rr15 +
        -t14 * rr10 +
        -t15 * rr13
    )
    s3 = (
        t0 * rr3 +
        -t1 * rr6 +
        -t2 * rr8 +
        t3 * rr0 +
        t4 * rr10 +
        -t5 * rr11 +
        t6 * rr1 +
        t7 * rr13 +
        t8 * rr2 +
        t9 * rr14 +
        -t10 * rr4 +
        -t11 * rr5 +
        -t12 * rr15 +
        t13 * rr7 +
        t14 * rr9 +
        t15 * rr12
    )
    s4 = (
        t0 * rr4 +
        -t1 * rr7 +
        -t2 * rr9 +
        -t3 * rr10 +
        t4 * rr0 +
        -t5 * rr12 +
        -t6 * rr13 +
        t7 * rr1 +
        -t8 * rr14 +
        t9 * rr2 +
        t10 * rr3 +
        t11 * rr15 +
        -t12 * rr5 +
        -t13 * rr6 +
        -t14 * rr8 +
        -t15 * rr11
    )
    s5 = (
        t0 * rr5 +
        t1 * rr2 +
        -t2 * rr1 +
        -t3 * rr11 +
        -t4 * rr12 +
        t5 * rr0 +
        t6 * rr8 +
        t7 * rr9 +
        -t8 * rr6 +
        -t9 * rr7 +
        -t10 * rr15 +
        -t11 * rr3 +
        -t12 * rr4 +
        -t13 * rr14 +
        t14 * rr13 +
        -t15 * rr10
    )
    s6 = (
        t0 * rr6 +
        t1 * rr3 +
        t2 * rr11 +
        -t3 * rr1 +
        -t4 * rr13 +
        -t5 * rr8 +
        t6 * rr0 +
        t7 * rr10 +
        t8 * rr5 +
        t9 * rr15 +
        -t10 * rr7 +
        t11 * rr2 +
        t12 * rr14 +
        -t13 * rr4 +
        -t14 * rr12 +
        t15 * rr9
    )
    s7 = (
        t0 * rr7 +
        t1 * rr4 +
        t2 * rr12 +
        t3 * rr13 +
        -t4 * rr1 +
        -t5 * rr9 +
        -t6 * rr10 +
        t7 * rr0 +
        -t8 * rr15 +
        t9 * rr5 +
        t10 * rr6 +
        -t11 * rr14 +
        t12 * rr2 +
        t13 * rr3 +
        t14 * rr11 +
        -t15 * rr8
    )
    s8 = (
        t0 * rr8 +
        -t1 * rr11 +
        t2 * rr3 +
        -t3 * rr2 +
        -t4 * rr14 +
        t5 * rr6 +
        -t6 * rr5 +
        -t7 * rr15 +
        t8 * rr0 +
        t9 * rr10 +
        -t10 * rr9 +
        -t11 * rr1 +
        -t12 * rr13 +
        t13 * rr12 +
        -t14 * rr4 +
        -t15 * rr7
    )
    s9 = (
        t0 * rr9 +
        -t1 * rr12 +
        t2 * rr4 +
        t3 * rr14 +
        -t4 * rr2 +
        t5 * rr7 +
        t6 * rr15 +
        -t7 * rr5 +
        -t8 * rr10 +
        t9 * rr0 +
        t10 * rr8 +
        t11 * rr13 +
        -t12 * rr1 +
        -t13 * rr11 +
        t14 * rr3 +
        t15 * rr6
    )
    s10 = (
        t0 * rr10 +
        -t1 * rr13 +
        -t2 * rr14 +
        t3 * rr4 +
        -t4 * rr3 +
        -t5 * rr15 +
        t6 * rr7 +
        -t7 * rr6 +
        t8 * rr9 +
        -t9 * rr8 +
        t10 * rr0 +
        -t11 * rr12 +
        t12 * rr11 +
        -t13 * rr1 +
        -t14 * rr2 +
        -t15 * rr5
    )
    s11 = (
        t0 * rr11 +
        t1 * rr8 +
        -t2 * rr6 +
        t3 * rr5 +
        t4 * rr15 +
        t5 * rr3 +
        -t6 * rr2 +
        -t7 * rr14 +
        t8 * rr1 +
        t9 * rr13 +
        -t10 * rr12 +
        t11 * rr0 +
        t12 * rr10 +
        -t13 * rr9 +
        t14 * rr7 +
        -t15 * rr4
    )
    s12 = (
        t0 * rr12 +
        t1 * rr9 +
        -t2 * rr7 +
        -t3 * rr15 +
        t4 * rr5 +
        t5 * rr4 +
        t6 * rr14 +
        -t7 * rr2 +
        -t8 * rr13 +
        t9 * rr1 +
        t10 * rr11 +
        -t11 * rr10 +
        t12 * rr0 +
        t13 * rr8 +
        -t14 * rr6 +
        t15 * rr3
    )
    s13 = (
        t0 * rr13 +
        t1 * rr10 +
        t2 * rr15 +
        -t3 * rr7 +
        t4 * rr6 +
        -t5 * rr14 +
        t6 * rr4 +
        -t7 * rr3 +
        t8 * rr12 +
        -t9 * rr11 +
        t10 * rr1 +
        t11 * rr9 +
        -t12 * rr8 +
        t13 * rr0 +
        t14 * rr5 +
        -t15 * rr2
    )
    s14 = (
        t0 * rr14 +
        -t1 * rr15 +
        t2 * rr10 +
        -t3 * rr9 +
        t4 * rr8 +
        t5 * rr13 +
        -t6 * rr12 +
        t7 * rr11 +
        t8 * rr4 +
        -t9 * rr3 +
        t10 * rr2 +
        -t11 * rr7 +
        t12 * rr6 +
        -t13 * rr5 +
        t14 * rr0 +
        t15 * rr1
    )
    s15 = (
        t0 * rr15 +
        t1 * rr14 +
        -t2 * rr13 +
        t3 * rr12 +
        -t4 * rr11 +
        t5 * rr10 +
        -t6 * rr9 +
        t7 * rr8 +
        t8 * rr7 +
        -t9 * rr6 +
        t10 * rr5 +
        t11 * rr4 +
        -t12 * rr3 +
        t13 * rr2 +
        -t14 * rr1 +
        t15 * rr0
    )

    return torch.stack([
        s0, s1, s2, s3, s4, s5, s6, s7,
        s8, s9, s10, s11, s12, s13, s14, s15,
    ], dim=-1)

# =============================================================================
# Rotor Norm Squared
# =============================================================================

@torch.jit.script
def norm_squared_rotor(r: Tensor) -> Tensor:
    """
    Compute norm squared of a rotor in Cl(0, 4).

    Args:
        r: Input rotor, shape (..., 8)

    Returns:
        Norm squared, shape (..., 1)
    """
    result = (
        r[..., 0] * r[..., 0] +
        r[..., 1] * r[..., 1] +
        r[..., 2] * r[..., 2] +
        r[..., 3] * r[..., 3] +
        r[..., 4] * r[..., 4] +
        r[..., 5] * r[..., 5] +
        r[..., 6] * r[..., 6] +
        r[..., 7] * r[..., 7]
    )
    return result.unsqueeze(-1)

# =============================================================================
# Bivector Exponential (exp_bivector)
# =============================================================================

@torch.jit.script
def exp_bivector(B: Tensor) -> Tensor:
    """
    Compute exponential of a bivector in Cl(0, 4).

    Converts a bivector (generator) to a rotor (rotation).
    Formula: exp(B) = cos(Î¸) + sin(Î¸)/Î¸ * B where Î¸ = sqrt(-BÂ²)

    Args:
        B: Input bivector, shape (..., 6)

    Returns:
        Rotor, shape (..., 8)
    """
    B_sq = (
        -B[..., 0] * B[..., 0] +
        -B[..., 1] * B[..., 1] +
        -B[..., 2] * B[..., 2] +
        -B[..., 3] * B[..., 3] +
        -B[..., 4] * B[..., 4] +
        -B[..., 5] * B[..., 5]
    )

    # Î¸Â² = -BÂ² (bivectors square to negative in Euclidean)
    theta_sq = -B_sq

    # Handle both positive (elliptic) and negative (hyperbolic) cases
    # For numerical stability, use small angle approximation when Î¸ â 0
    eps = 1e-8

    # Elliptic case: Î¸Â² > 0 => exp(B) = cos(Î¸) + sin(Î¸)/Î¸ * B
    # Hyperbolic case: Î¸Â² < 0 => exp(B) = cosh(Î¸) + sinh(Î¸)/Î¸ * B
    theta = torch.sqrt(torch.abs(theta_sq) + eps)

    # Compute cos/cosh and sinc (sin(Î¸)/Î¸ or sinh(Î¸)/Î¸)
    is_elliptic = theta_sq > 0
    cos_term = torch.where(is_elliptic, torch.cos(theta), torch.cosh(theta))
    sinc_term = torch.where(
        is_elliptic,
        torch.sin(theta) / theta,
        torch.sinh(theta) / theta
    )

    # Build rotor: scalar part + bivector parts
    r0 = cos_term
    r1 = sinc_term * B[..., 0]
    r2 = sinc_term * B[..., 1]
    r3 = sinc_term * B[..., 2]
    r4 = sinc_term * B[..., 3]
    r5 = sinc_term * B[..., 4]
    r6 = sinc_term * B[..., 5]
    r7 = torch.zeros_like(B[..., 0])

    return torch.stack([
        r0, r1, r2, r3, r4, r5, r6, r7,
    ], dim=-1)

# =============================================================================
# Rotor Logarithm (log_rotor)
# =============================================================================

@torch.jit.script
def log_rotor(r: Tensor) -> Tensor:
    """
    Compute logarithm of a rotor in Cl(0, 4).

    Converts a rotor (rotation) to a bivector (generator).
    Formula: log(R) = atan2(|B|, s) / |B| * B where R = s + B

    Args:
        r: Input rotor, shape (..., 8)

    Returns:
        Bivector, shape (..., 6)
    """
    s = r[..., 0]  # Scalar part

    # Compute |B|Â² from bivector parts of rotor
    B_norm_sq = (
        r[..., 1] * r[..., 1] +
        r[..., 2] * r[..., 2] +
        r[..., 3] * r[..., 3] +
        r[..., 4] * r[..., 4] +
        r[..., 5] * r[..., 5] +
        r[..., 6] * r[..., 6]
    )

    # Compute angle Î¸ = atan2(|B|, s)
    eps = 1e-8
    B_norm = torch.sqrt(B_norm_sq + eps)
    theta = torch.atan2(B_norm, s)

    # Scale factor: Î¸ / |B|
    scale = theta / (B_norm + eps)

    # Extract bivector components from rotor
    b0 = scale * r[..., 1]
    b1 = scale * r[..., 2]
    b2 = scale * r[..., 3]
    b3 = scale * r[..., 4]
    b4 = scale * r[..., 5]
    b5 = scale * r[..., 6]

    return torch.stack([
        b0, b1, b2, b3, b4, b5,
    ], dim=-1)

# =============================================================================
# Rotor SLERP (Spherical Linear Interpolation)
# =============================================================================

@torch.jit.script
def slerp_rotor(r1: Tensor, r2: Tensor, t: Tensor) -> Tensor:
    """
    Spherical linear interpolation between rotors in Cl(0, 4).

    Formula: slerp(r1, r2, t) = r1 * exp(t * log(r1~ * r2))

    Args:
        r1: Start rotor, shape (..., 8)
        r2: End rotor, shape (..., 8)
        t: Interpolation parameter [0, 1], shape (...) or scalar

    Returns:
        Interpolated rotor, shape (..., 8)
    """
    # Compute r1~ (reverse of r1)
    r1_rev = reverse_rotor(r1)

    # Compute delta = r1~ * r2
    delta = compose_rotor(r1_rev, r2)

    # Compute log of delta to get bivector
    log_delta = log_rotor(delta)

    # Scale by t
    if t.dim() == 0:
        scaled_log = t * log_delta
    else:
        scaled_log = t.unsqueeze(-1) * log_delta

    # Exponentiate back to rotor
    delta_t = exp_bivector(scaled_log)

    # Compose with r1
    return compose_rotor(r1, delta_t)
