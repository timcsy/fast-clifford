# 功能規格：CGA4D 與 CGA5D 支援

**功能分支**: `003-cga4d-cga5d`
**建立日期**: 2025-12-07
**狀態**: 草稿
**輸入**: 使用者描述：「新增 CGA4D Cl(5,1) 和 CGA5D Cl(6,1) 支援，用於 4D 和 5D 共形幾何代數運算，針對高維度 CARE Transformer 和幾何深度學習應用優化」

## 使用者情境與測試 *(必填)*

### 使用者故事 1 - 4D 幾何變換 (優先級: P1)

作為開發高維度 CARE Transformer 模型的深度學習研究人員，我需要使用馬達（motor）和三明治積（sandwich product）對批次 4D 點執行高效的 4D 共形幾何代數運算（旋轉、平移）。

**為何此優先級**: CGA4D 是 CGA3D 之後的自然延伸，支援 4D 時空變換、高維度幾何學習和特殊相對論相關應用。

**獨立測試**: 可透過將 4D 點編碼為 UPGC 表示、透過三明治積套用馬達變換、然後解碼回 4D 座標來完整測試。可與 clifford 函式庫比對驗證結果。

**驗收場景**:

1. **假設** 有一批 4D 點和旋轉馬達，**當** 我套用三明治積，**則** 點在 4D 空間中被正確旋轉，數值誤差 < 1e-6
2. **假設** 有一批 4D 點和平移馬達，**當** 我套用三明治積，**則** 點被正確平移，數值誤差 < 1e-6
3. **假設** CGA4D 運算，**當** 我匯出至 ONNX，**則** 計算圖不包含 Loop 節點，且僅使用基本算子（Add、Mul、Neg）

---

### 使用者故事 2 - 5D 幾何變換 (優先級: P2)

作為開發用於高維度嵌入空間或多尺度幾何分析的深度學習研究人員，我需要對批次 5D 點執行高效的 5D 共形幾何代數運算（旋轉、平移）。

**為何此優先級**: CGA5D 適用於高維度特徵空間變換、多維度物理模擬和進階幾何神經網路研究。

**獨立測試**: 可透過將 5D 向量編碼為 UPGC 表示、套用馬達變換、然後解碼回來完整測試。可與 clifford 函式庫比對驗證。

**驗收場景**:

1. **假設** 有一批 5D 向量和旋轉馬達，**當** 我套用三明治積，**則** 向量被正確旋轉，數值誤差 < 1e-6
2. **假設** CGA5D 運算，**當** 我匯出至 ONNX，**則** 計算圖不包含 Loop 節點

---

### 使用者故事 3 - PyTorch 訓練整合 (優先級: P1)

作為機器學習工程師，我需要 CGA4D 和 CGA5D 層能無縫整合到 PyTorch 訓練流程中，支援自動微分、批次處理和混合精度（fp16/fp32）。

**為何此優先級**: 這對深度學習的實際應用至關重要——沒有 PyTorch 整合，這些運算就無法用於模型訓練。

**獨立測試**: 可透過建立使用 CGA 層的簡單神經網路、執行前向/反向傳播、並驗證梯度流動來測試。

**驗收場景**:

1. **假設** CGA4DCareLayer 和 CGA5DCareLayer 模組，**當** 在 PyTorch 模型中使用，**則** 梯度正確地通過這些層傳播
2. **假設** fp16 輸入張量，**當** 由 CGA 層處理，**則** 內部計算使用 fp32 且輸出保持 fp16 dtype
3. **假設** 批次輸入，**當** 由 CGA 層處理，**則** 批次維度被正確處理並進行平行計算

---

### 邊界案例

- 當馬達未正規化時會發生什麼？（應仍產生有效變換，可能影響縮放比例）
- 當輸入為零值時會發生什麼？（應優雅處理，回傳有效的零點）
- 當座標值非常大時會發生什麼？（應透過 fp32 內部計算維持數值穩定性）
- 當批次大小為 1 時會發生什麼？（應與較大批次運作相同）
- 當處理 CGA5D 的 128 個 blade 時會發生什麼？（應正確處理較大的代數結構）

## 需求 *(必填)*

### 功能需求

**CGA4D Cl(5,1) 需求**:

- **FR-001**: 系統必須實作具有 64 個 blade（2^6）的 CGA4D 代數
- **FR-002**: 系統必須提供具有 6 個分量（e1、e2、e3、e4、e+、e-）的 UPGC 4D 點編碼
- **FR-003**: 系統必須提供具有 31 個分量（Grade 0: 1、Grade 2: 15、Grade 4: 15）的 4D 馬達表示
- **FR-004**: 系統必須實作 CGA4D 的稀疏三明治積（Motor × Point × Motor̃）
- **FR-005**: 系統必須提供無迴圈的硬編碼幾何積（64×64）

**CGA5D Cl(6,1) 需求**:

- **FR-006**: 系統必須實作具有 128 個 blade（2^7）的 CGA5D 代數
- **FR-007**: 系統必須提供具有 7 個分量（e1、e2、e3、e4、e5、e+、e-）的 UPGC 5D 點編碼
- **FR-008**: 系統必須提供具有 64 個分量（Grade 0: 1、Grade 2: 21、Grade 4: 35、Grade 6: 7）的 5D 馬達表示
- **FR-009**: 系統必須實作 CGA5D 的稀疏三明治積
- **FR-010**: 系統必須提供無迴圈的硬編碼幾何積（128×128）

**共通需求**:

- **FR-011**: 系統必須在所有運算上支援 PyTorch 批次處理
- **FR-012**: 系統必須支援 opset 17 的 ONNX 匯出
- **FR-013**: 系統必須支援 CPU、CUDA 和 MPS（Apple Silicon）裝置
- **FR-014**: 系統必須處理混合精度（fp16 輸入搭配 fp32 內部計算）
- **FR-015**: 系統必須對所有生成的函式套用 torch.jit.script 優化
- **FR-016**: 系統必須驗證零基性質（eo²=0、einf²=0、eo·einf=-1）

### 關鍵實體

- **CGA4D 代數 Cl(5,1)**: 6 維空間，簽名（+,+,+,+,+,-），64 個 blade，用於 4D 共形變換
- **CGA5D 代數 Cl(6,1)**: 7 維空間，簽名（+,+,+,+,+,+,-），128 個 blade，用於 5D 共形變換
- **UPGC 點**: 共形空間中的上投影點，將歐幾里得點與額外的零基分量一起編碼
- **馬達（Motor）**: 編碼旋轉和平移的幾何代數元素，在三明治積中用於變換
- **三明治積**: M × X × M̃ 運算，使用馬達 M 變換點 X

## 成功標準 *(必填)*

### 可衡量的成果

- **SC-001**: CGA4D 稀疏三明治積使用約 5,800 次乘法（相較於完整計算的 64×64×64 = 262,144 次），達成 >95% 減少
- **SC-002**: CGA5D 稀疏三明治積使用約 28,700 次乘法（相較於完整計算的 128×128×128 = 2,097,152 次），達成 >98% 減少
- **SC-003**: 所有數值運算與 clifford 函式庫參考在 1e-6 容差內相符
- **SC-004**: ONNX 匯出的模型包含零個 Loop/If/Scan 節點
- **SC-005**: CGA4D 批次處理吞吐量在 CPU 上超過每秒 500,000 點
- **SC-006**: CGA5D 批次處理吞吐量在 CPU 上超過每秒 100,000 點
- **SC-007**: 所有測試案例通過（幾何積、零基、結合律、反轉、三明治積、邊界案例）
- **SC-008**: CGA4D 和 CGA5D 模組可直接匯入並用於 PyTorch 訓練程式碼

## 假設

- 使用者熟悉共形幾何代數概念
- 主要使用場景為 CARE Transformer 和類似的幾何深度學習模型
- 效能需求與 CGA3D 實作模式一致
- clifford 函式庫作為數值正確性的參考實作
- 馬達正規化是使用者的責任（函式庫不自動正規化）
- 現有的代碼生成器架構可擴展支援更高維度
