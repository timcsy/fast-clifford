# Feature Specification: CGA Extended Operations

**Feature Branch**: `005-cga-extended-ops`
**Created**: 2025-12-08
**Status**: Draft
**Input**: User description: "æ–°å¢ Motor Compositionã€Geometric Inner Productã€Exponential Map ä¸‰å€‹ CGA æ“ä½œï¼Œ5D å…§ç¡¬ç·¨ç¢¼åŠ é€Ÿï¼Œ6D ä»¥ä¸Šé‹è¡Œæ™‚ä¸€èˆ¬åŒ–ç®—æ³•"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Motor Composition for Transform Chaining (Priority: P1)

é–‹ç™¼è€…éœ€è¦çµ„åˆå¤šå€‹å¹¾ä½•è®Šæ›ï¼ˆå¦‚å…ˆæ—‹è½‰å†å¹³ç§»ï¼‰ï¼Œé€é Motor Composition å°‡å…©å€‹é¦¬é”åˆä½µç‚ºå–®ä¸€é¦¬é”ï¼Œç”¨æ–¼æ©Ÿå™¨äººé‹å‹•å­¸ã€3D å‹•ç•«ç­‰æ‡‰ç”¨ã€‚

**Why this priority**: Motor Composition æ˜¯æœ€åŸºç¤çš„è®Šæ›çµ„åˆæ“ä½œï¼Œå¹¾ä¹æ‰€æœ‰è¤‡é›œå¹¾ä½•è®Šæ›éƒ½éœ€è¦å°‡å¤šå€‹æ“ä½œä¸²æ¥ã€‚æ²’æœ‰æ­¤åŠŸèƒ½ï¼Œä½¿ç”¨è€…å¿…é ˆå¤šæ¬¡åŸ·è¡Œ sandwich productï¼Œæ•ˆèƒ½è¼ƒå·®ã€‚

**Independent Test**: å¯é€éå»ºç«‹å…©å€‹å·²çŸ¥è®Šæ›é¦¬é”ï¼ˆå¦‚ 90Â° æ—‹è½‰ + å¹³ç§»ï¼‰ï¼Œçµ„åˆå¾Œé©—è­‰ç­‰åŒæ–¼å–®ä¸€è¤‡åˆè®Šæ›çš„æ•ˆæœã€‚

**Acceptance Scenarios**:

1. **Given** å…©å€‹ CGA3D é¦¬é” M1ï¼ˆæ—‹è½‰ï¼‰å’Œ M2ï¼ˆå¹³ç§»ï¼‰ï¼Œ**When** å‘¼å« `motor_compose(M1, M2)`ï¼Œ**Then** è¿”å›æ­£ç¢ºçµ„åˆçš„é¦¬é” M_result
2. **Given** å–®ä½é¦¬é” identityï¼Œ**When** å‘¼å« `motor_compose(identity, M)`ï¼Œ**Then** è¿”å› M æœ¬èº«
3. **Given** é¦¬é” M åŠå…¶é€†å…ƒ M_revï¼Œ**When** å‘¼å« `motor_compose(M, M_rev)`ï¼Œ**Then** è¿”å›è¿‘ä¼¼å–®ä½é¦¬é”

---

### User Story 2 - Geometric Inner Product for Attention & Loss (Priority: P1)

é–‹ç™¼è€…éœ€è¦è¨ˆç®— CGA å¤šå‘é‡çš„å¹¾ä½•å…§ç©ï¼Œç”¨æ–¼æ·±åº¦å­¸ç¿’ä¸­çš„ Attention Score è¨ˆç®—å’Œæå¤±å‡½æ•¸ã€‚å¿…é ˆæ­£ç¢ºè™•ç† CGA çš„éæ­å¹¾é‡Œå¾—åº¦è¦ (+,+,+,+,-)ã€‚

**Why this priority**: é€™æ˜¯ CARE Transformer ç­‰å¹¾ä½•æ·±åº¦å­¸ç¿’æ¨¡å‹çš„æ ¸å¿ƒè¨ˆç®—ï¼Œç›´æ¥å½±éŸ¿æ¨¡å‹è¨“ç·´å’Œæ¨ç†çš„æ­£ç¢ºæ€§ã€‚

**Independent Test**: å¯é€éè¨ˆç®—å·²çŸ¥ Null Basis å‘é‡ (eo, einf) çš„å…§ç©é©—è­‰ï¼Œæ‡‰å¾—åˆ° -1ã€‚

**Acceptance Scenarios**:

1. **Given** CGA3D çš„ eo å’Œ einf å‘é‡ï¼Œ**When** å‘¼å« `inner_product(eo, einf)`ï¼Œ**Then** è¿”å› -1
2. **Given** ä»»æ„ CGA å¤šå‘é‡ a å’Œ bï¼Œ**When** å‘¼å« `inner_product(a, b)`ï¼Œ**Then** è¿”å›æ­£ç¢ºçš„æ¨™é‡å…§ç©ï¼ˆå¹¾ä½•ç©çš„ Grade 0 åˆ†é‡ï¼‰
3. **Given** æ­£äº¤çš„ basis bladesï¼Œ**When** è¨ˆç®—å…¶å…§ç©ï¼Œ**Then** è¿”å› 0

---

### User Story 3 - Exponential Map for Motor Generation (Priority: P2)

é–‹ç™¼è€…éœ€è¦å¾æ—‹è½‰è»¸å’Œè§’åº¦ç”Ÿæˆæ—‹è½‰é¦¬é”ï¼Œé€é Bivector çš„æŒ‡æ•¸æ˜ å°„ exp(B) ç”¢ç”Ÿ Rotor/Motorã€‚æ­¤åŠŸèƒ½ç”¨æ–¼æ’å€¼ã€å¹³æ»‘å‹•ç•«ã€å¾æä»£æ•¸ç”Ÿæˆè®Šæ›ç­‰å ´æ™¯ã€‚

**Why this priority**: é›–ç„¶ä½¿ç”¨è€…å¯ç›´æ¥å»ºæ§‹é¦¬é”ï¼Œä½† Exponential Map æä¾›æ›´ç›´è§€çš„æ•¸å­¸ä»‹é¢ï¼Œå°æ–¼æ—‹è½‰æ’å€¼ï¼ˆslerpï¼‰å’Œæä»£æ•¸é‹ç®—è‡³é—œé‡è¦ã€‚

**Independent Test**: å¯é€éå°‡å·²çŸ¥æ—‹è½‰è§’åº¦çš„ Bivector å‚³å…¥ exp_bivectorï¼Œé©—è­‰ç”¢ç”Ÿçš„é¦¬é”æ˜¯å¦æ­£ç¢ºæ—‹è½‰é»ã€‚

**Acceptance Scenarios**:

1. **Given** é›¶ Bivector B=0ï¼Œ**When** å‘¼å« `exp_bivector(B)`ï¼Œ**Then** è¿”å›å–®ä½é¦¬é” (1, 0, 0, ...)
2. **Given** ä»£è¡¨ 90Â° æ—‹è½‰çš„ Bivectorï¼Œ**When** å‘¼å« `exp_bivector(B)`ï¼Œ**Then** ç”¢ç”Ÿæ­£ç¢ºçš„æ—‹è½‰é¦¬é”
3. **Given** æ¥µå° Bivector (Î¸ < 1e-6)ï¼Œ**When** å‘¼å« `exp_bivector(B)`ï¼Œ**Then** æ•¸å€¼ç©©å®šåœ°è¿”å›è¿‘ä¼¼å–®ä½é¦¬é”ï¼ˆç„¡ NaN æˆ– Infï¼‰

---

### User Story 4 - High-Dimensional Runtime Support (Priority: P2)

é–‹ç™¼è€…éœ€è¦åœ¨ 6D åŠä»¥ä¸Šç¶­åº¦ä½¿ç”¨ç›¸åŒçš„ APIï¼Œç³»çµ±è‡ªå‹•åˆ‡æ›è‡³é‹è¡Œæ™‚ä¸€èˆ¬åŒ–ç®—æ³•ï¼Œç¢ºä¿åŠŸèƒ½å®Œæ•´æ€§ã€‚

**Why this priority**: ä¿æŒ API ä¸€è‡´æ€§ï¼Œè®“é«˜ç¶­åº¦ç ”ç©¶è€…ç„¡éœ€å­¸ç¿’ä¸åŒä»‹é¢ã€‚æ•ˆèƒ½ä¸æ˜¯ä¸»è¦è€ƒé‡ï¼ˆé«˜ç¶­åº¦æœ¬ä¾†å°±è¼ƒæ…¢ï¼‰ã€‚

**Independent Test**: å¯é€é CGA(6) å‘¼å«ä¸‰å€‹æ–°æ“ä½œï¼Œé©—è­‰åŠŸèƒ½æ­£ç¢ºä¸”ç„¡éŒ¯èª¤ã€‚

**Acceptance Scenarios**:

1. **Given** CGA(6) ä»£æ•¸å¯¦ä¾‹ï¼Œ**When** å‘¼å« `motor_compose`ï¼Œ**Then** è¿”å›æ­£ç¢ºçµæœï¼ˆèˆ‡ clifford åº«å°ç…§ï¼‰
2. **Given** CGA(7) ä»£æ•¸å¯¦ä¾‹ï¼Œ**When** å‘¼å« `inner_product`ï¼Œ**Then** è¿”å›æ­£ç¢ºæ¨™é‡
3. **Given** CGA(6) ä»£æ•¸å¯¦ä¾‹ï¼Œ**When** å‘¼å« `exp_bivector`ï¼Œ**Then** è¿”å›æ­£ç¢ºé¦¬é”

---

### User Story 5 - Outer Product (Wedge Product) (Priority: P3)

é–‹ç™¼è€…éœ€è¦è¨ˆç®—å…©å€‹å¤šå‘é‡çš„å¤–ç©ï¼ˆæ¥”ç©ï¼‰ï¼Œç”¨æ–¼å»ºç«‹é«˜éšå¹¾ä½•ç‰©ä»¶ï¼ˆå¦‚å¹³é¢ã€çƒé¢ç­‰ï¼‰å’Œé€²è¡ŒæŠ•å½±å¹¾ä½•é‹ç®—ã€‚

**Why this priority**: å¤–ç©æ˜¯å»ºæ§‹å¹¾ä½•ç‰©ä»¶çš„åŸºç¤é‹ç®—ï¼Œä½†åœ¨æ·±åº¦å­¸ç¿’æ‡‰ç”¨ä¸­è¼ƒå°‘ç›´æ¥ä½¿ç”¨ã€‚å„ªå…ˆç´šä½æ–¼æ ¸å¿ƒæ“ä½œä½†ä»æ˜¯å®Œæ•´ä»£æ•¸å¯¦ä½œçš„å¿…è¦éƒ¨åˆ†ã€‚

**Independent Test**: å¯é€éè¨ˆç®—å…©å€‹æ­£äº¤å‘é‡çš„å¤–ç©é©—è­‰çµæœç‚ºå°æ‡‰çš„ Bivectorã€‚

**Acceptance Scenarios**:

1. **Given** å…©å€‹æ­£äº¤ Grade 1 å‘é‡ e1 å’Œ e2ï¼Œ**When** å‘¼å« `outer_product(e1, e2)`ï¼Œ**Then** è¿”å› e12 Bivector
2. **Given** åŒä¸€å‘é‡ vï¼Œ**When** å‘¼å« `outer_product(v, v)`ï¼Œ**Then** è¿”å› 0
3. **Given** ä»»æ„å¤šå‘é‡ a å’Œ bï¼Œ**When** å‘¼å« `outer_product(a, b)`ï¼Œ**Then** çµæœç­‰æ–¼å¹¾ä½•ç©ä¸­ Grade |a|+|b| çš„åˆ†é‡

---

### User Story 6 - Left/Right Contraction (Priority: P3)

é–‹ç™¼è€…éœ€è¦è¨ˆç®—å·¦ç¸®ä½µå’Œå³ç¸®ä½µï¼Œç”¨æ–¼æŠ•å½±é‹ç®—ã€è·é›¢è¨ˆç®—å’Œå¹¾ä½•åˆ†æã€‚

**Why this priority**: ç¸®ä½µé‹ç®—ç”¨æ–¼é«˜éšå¹¾ä½•åˆ†æï¼Œåœ¨ä¸€èˆ¬æ·±åº¦å­¸ç¿’æ‡‰ç”¨ä¸­ä½¿ç”¨é »ç‡è¼ƒä½ã€‚

**Independent Test**: å¯é€éè¨ˆç®—å‘é‡èˆ‡ Bivector çš„å·¦ç¸®ä½µé©—è­‰çµæœçš„ Grade é™ä½ã€‚

**Acceptance Scenarios**:

1. **Given** Grade 1 å‘é‡ v å’Œ Grade 2 Bivector Bï¼Œ**When** å‘¼å« `left_contraction(v, B)`ï¼Œ**Then** è¿”å› Grade 1 çµæœ
2. **Given** Grade 2 Bivector B å’Œ Grade 1 å‘é‡ vï¼Œ**When** å‘¼å« `right_contraction(B, v)`ï¼Œ**Then** è¿”å› Grade 1 çµæœ
3. **Given** ç›¸åŒ Grade çš„å…ƒç´  a å’Œ bï¼Œ**When** è¨ˆç®— `left_contraction(a, b)`ï¼Œ**Then** çµæœç‚ºæ¨™é‡

---

### User Story 7 - Grade Selection (Priority: P3)

é–‹ç™¼è€…éœ€è¦å¾å®Œæ•´å¤šå‘é‡ä¸­æå–ç‰¹å®š Grade çš„åˆ†é‡ï¼Œç”¨æ–¼åˆ†æå’Œè™•ç†å¤šå‘é‡çš„ç‰¹å®šéƒ¨åˆ†ã€‚

**Why this priority**: Grade æå–æ˜¯åŸºç¤å·¥å…·å‡½å¼ï¼Œç”¨æ–¼èª¿è©¦å’Œé€²éšåˆ†æï¼Œä½†æ·±åº¦å­¸ç¿’æ¨¡å‹é€šå¸¸ä½¿ç”¨ç¨€ç–è¡¨ç¤ºä¸éœ€æ­¤åŠŸèƒ½ã€‚

**Independent Test**: å¯é€éå¾å·²çŸ¥å¤šå‘é‡æå– Grade 0 åˆ†é‡é©—è­‰æ­£ç¢ºæ€§ã€‚

**Acceptance Scenarios**:

1. **Given** å®Œæ•´å¤šå‘é‡ mvï¼Œ**When** å‘¼å« `grade_select(mv, 0)`ï¼Œ**Then** è¿”å›æ¨™é‡åˆ†é‡
2. **Given** å®Œæ•´å¤šå‘é‡ mvï¼Œ**When** å‘¼å« `grade_select(mv, 1)`ï¼Œ**Then** è¿”å› Grade 1 åˆ†é‡ï¼ˆå‘é‡ï¼‰
3. **Given** å®Œæ•´å¤šå‘é‡ mv å’Œç„¡æ•ˆ Grade kï¼Œ**When** å‘¼å« `grade_select(mv, k)`ï¼Œ**Then** è¿”å›é›¶å‘é‡

---

### User Story 8 - Dual (Priority: P3)

é–‹ç™¼è€…éœ€è¦è¨ˆç®—å¤šå‘é‡çš„å°å¶ï¼Œç”¨æ–¼å¹¾ä½•ç‰©ä»¶çš„äº’è£œè¡¨ç¤ºï¼ˆå¦‚é»â†”çƒé¢ã€ç·šâ†”å¹³é¢ç­‰ï¼‰ã€‚

**Why this priority**: å°å¶é‹ç®—åœ¨ CGA ç†è«–ä¸­é‡è¦ï¼Œä½†æ·±åº¦å­¸ç¿’æ‡‰ç”¨é€šå¸¸ä¸éœ€è¦æ­¤è½‰æ›ã€‚

**Independent Test**: å¯é€éè¨ˆç®— Pseudoscalar çš„å°å¶é©—è­‰è¿”å›æ¨™é‡ 1ã€‚

**Acceptance Scenarios**:

1. **Given** æ¨™é‡ 1ï¼Œ**When** å‘¼å« `dual(1)`ï¼Œ**Then** è¿”å› Pseudoscalar
2. **Given** Pseudoscalar Iï¼Œ**When** å‘¼å« `dual(I)`ï¼Œ**Then** è¿”å› Â±1ï¼ˆä¾åº¦è¦ç¬¦è™Ÿï¼‰
3. **Given** å¤šå‘é‡ mvï¼Œ**When** å‘¼å« `dual(dual(mv))`ï¼Œ**Then** è¿”å› Â±mv

---

### User Story 9 - Normalize (Priority: P3)

é–‹ç™¼è€…éœ€è¦æ­£è¦åŒ–å¤šå‘é‡ç‚ºå–®ä½ç¯„æ•¸ï¼Œç”¨æ–¼ç¢ºä¿æ•¸å€¼ç©©å®šæ€§å’Œä¸€è‡´çš„å¹¾ä½•æ„ç¾©ã€‚

**Why this priority**: æ­£è¦åŒ–æ˜¯å¸¸è¦‹æ“ä½œä½†è¼ƒç‚ºç°¡å–®ï¼Œä¸”å¯ç”±ä½¿ç”¨è€…è‡ªè¡Œå¯¦ä½œã€‚

**Independent Test**: å¯é€éæ­£è¦åŒ–ä»»æ„éé›¶å‘é‡é©—è­‰ç¯„æ•¸ç‚º 1ã€‚

**Acceptance Scenarios**:

1. **Given** éé›¶å‘é‡ vï¼Œ**When** å‘¼å« `normalize(v)`ï¼Œ**Then** è¿”å›å–®ä½å‘é‡ï¼ˆå…§ç©ç‚º 1ï¼‰
2. **Given** é›¶å‘é‡ï¼Œ**When** å‘¼å« `normalize(0)`ï¼Œ**Then** è¿”å›é›¶å‘é‡ï¼ˆä¸æœƒ NaNï¼‰
3. **Given** æ­£è¦åŒ–å¾Œå‘é‡ v_normï¼Œ**When** å‘¼å« `normalize(v_norm)`ï¼Œ**Then** è¿”å›ç›¸åŒå‘é‡

---

### User Story 10 - Operator Overloading (Priority: P2)

é–‹ç™¼è€…éœ€è¦ä½¿ç”¨ç›´è§€çš„ Python é‹ç®—å­ä¾†æ“ä½œå¤šå‘é‡ï¼Œä½¿ä»£ç¢¼æ›´æ¥è¿‘æ•¸å­¸å…¬å¼ï¼Œæå‡å¯è®€æ€§å’Œé–‹ç™¼æ•ˆç‡ã€‚

**Why this priority**: é‹ç®—å­é‡è¼‰æ˜¯ Python é¢¨æ ¼çš„æ ¸å¿ƒç‰¹è‰²ï¼Œè®“å¹¾ä½•ä»£æ•¸é‹ç®—æ›´ç›´è§€ã€‚ç›¸è¼ƒæ–¼å‡½å¼å‘¼å«ï¼ˆå¦‚ `geometric_product(a, b)`ï¼‰ï¼Œé‹ç®—å­ï¼ˆå¦‚ `a * b`ï¼‰æ›´æ¥è¿‘æ•¸å­¸è¡¨é”å¼ï¼Œé™ä½èªçŸ¥è² æ“”ã€‚

**Independent Test**: å¯é€é `a * b` é©—è­‰å¹¾ä½•ç©ã€`a ^ b` é©—è­‰æ¥”ç©ã€`a | b` é©—è­‰å…§ç©ã€‚

**Acceptance Scenarios**:

1. **Given** å…©å€‹å¤šå‘é‡ a å’Œ bï¼Œ**When** ä½¿ç”¨ `a * b`ï¼Œ**Then** è¿”å›å¹¾ä½•ç©çµæœ
2. **Given** å…©å€‹å¤šå‘é‡ a å’Œ bï¼Œ**When** ä½¿ç”¨ `a ^ b`ï¼Œ**Then** è¿”å›æ¥”ç©ï¼ˆå¤–ç©ï¼‰çµæœ
3. **Given** å…©å€‹å¤šå‘é‡ a å’Œ bï¼Œ**When** ä½¿ç”¨ `a | b`ï¼Œ**Then** è¿”å›å…§ç©çµæœ
4. **Given** å…©å€‹å¤šå‘é‡ a å’Œ bï¼Œ**When** ä½¿ç”¨ `a + b` å’Œ `a - b`ï¼Œ**Then** è¿”å›åŠ æ¸›çµæœ
5. **Given** å¤šå‘é‡ a å’Œæ¨™é‡ sï¼Œ**When** ä½¿ç”¨ `a * s` æˆ– `s * a`ï¼Œ**Then** è¿”å›æ¨™é‡ä¹˜ç©
6. **Given** å¤šå‘é‡ aï¼Œ**When** ä½¿ç”¨ `~a`ï¼Œ**Then** è¿”å›åå‘ï¼ˆreverseï¼‰çµæœ
7. **Given** å¤šå‘é‡ aï¼Œ**When** ä½¿ç”¨ `-a`ï¼Œ**Then** è¿”å›å–è² çµæœ
8. **Given** å¤šå‘é‡ a å’Œ bï¼Œ**When** ä½¿ç”¨ `a @ b`ï¼Œ**Then** è¿”å›å·¦ç¸®ä½µï¼ˆleft contractionï¼‰çµæœ
9. **Given** å¯é€†å¤šå‘é‡ a å’Œ bï¼Œ**When** ä½¿ç”¨ `a / b`ï¼Œ**Then** è¿”å› `a * b^(-1)` çµæœ
10. **Given** å¯é€†å¤šå‘é‡ aï¼Œ**When** ä½¿ç”¨ `a.inverse()`ï¼Œ**Then** è¿”å›é€†å…ƒ `a^(-1)`

---

### User Story 11 - Unified Layer Naming (Priority: P2)

é–‹ç™¼è€…éœ€è¦ä¸€è‡´çš„ Layer å‘½åï¼Œä¸è«–ç¶­åº¦éƒ½ä½¿ç”¨ç›¸åŒçš„é¡åˆ¥åç¨±ã€‚ç§»é™¤ CARE è«–æ–‡ç‰¹å®šçš„å‘½åï¼ˆå¦‚ `CGA3DCareLayer`ï¼‰ï¼Œæ”¹ç‚ºé€šç”¨çš„çµ±ä¸€åç¨±ã€‚

**Why this priority**: ç•¶å‰å‘½åéæ–¼å¼·èª¿ CARE è«–æ–‡ï¼Œä½†é€™æ˜¯é€šç”¨çš„å¹¾ä½•ä»£æ•¸é‹ç®—ã€‚çµ±ä¸€å‘½åæå‡ API ä¸€è‡´æ€§å’Œå¯è®€æ€§ã€‚

**Independent Test**: å¯é€é `from fast_clifford import CGATransformLayer` é©—è­‰çµ±ä¸€åç¨±å¯ç”¨ã€‚

**Acceptance Scenarios**:

1. **Given** ä»»æ„ç¶­åº¦ n=0-5ï¼Œ**When** ä½¿ç”¨ `cga.get_transform_layer()`ï¼Œ**Then** è¿”å›å°æ‡‰ç¶­åº¦çš„ `CGATransformLayer` å¯¦ä¾‹
2. **Given** é‹è¡Œæ™‚ä»£æ•¸ nâ‰¥6ï¼Œ**When** ä½¿ç”¨ `cga.get_transform_layer()`ï¼Œ**Then** è¿”å›çµ±ä¸€çš„ `CGATransformLayer` å¯¦ä¾‹
3. **Given** ä»»æ„ç¶­åº¦ï¼Œ**When** å¾ `fast_clifford` åŒ¯å…¥ `CGATransformLayer`ï¼Œ**Then** å¯ç›´æ¥ä½¿ç”¨
4. **Given** ä»»æ„ç¶­åº¦ï¼Œ**When** ä½¿ç”¨ `CGAEncoder` ç·¨ç¢¼æ­æ°åº§æ¨™ï¼Œ**Then** è¿”å›æ­£ç¢ºå½¢ç‹€çš„ CGA é»è¡¨ç¤º
5. **Given** ä»»æ„ç¶­åº¦ï¼Œ**When** ä½¿ç”¨ `CGADecoder` è§£ç¢¼ CGA é»ï¼Œ**Then** è¿”å›æ­£ç¢ºå½¢ç‹€çš„æ­æ°åº§æ¨™
6. **Given** ä»»æ„ç¶­åº¦ï¼Œ**When** ä½¿ç”¨ `CGAPipeline` åŸ·è¡Œå®Œæ•´è®Šæ›ï¼Œ**Then** è¼¸å…¥è¼¸å‡ºç¶­åº¦ä¸€è‡´ä¸”è®Šæ›æ­£ç¢º

---

### Edge Cases

- **é›¶å‘é‡è¼¸å…¥**: inner_product(0, 0) æ‡‰è¿”å› 0ï¼Œexp_bivector(0) æ‡‰è¿”å›å–®ä½é¦¬é”
- **æ¥µå°è§’åº¦**: exp_bivector å° Î¸ < 1e-10 æ‡‰æ•¸å€¼ç©©å®šï¼ˆä½¿ç”¨ sinc æˆ– Taylor å±•é–‹ï¼‰
- **éæ­£è¦åŒ–é¦¬é”**: motor_compose å°æœªæ­£è¦åŒ–çš„é¦¬é”ä»æ‡‰æ­£ç¢ºè¨ˆç®—
- **æ··åˆç²¾åº¦**: æ”¯æ´ float32 å’Œ float64 è¼¸å…¥
- **æ‰¹æ¬¡ç¶­åº¦**: æ‰€æœ‰æ“ä½œæ”¯æ´ä»»æ„ batch å½¢ç‹€ (..., component_count)
- **é›¶å‘é‡æ­£è¦åŒ–**: normalize(0) æ‡‰è¿”å›é›¶å‘é‡è€Œé NaN
- **ç„¡æ•ˆ Grade**: grade_select å°è¶…å‡ºç¯„åœçš„ Grade æ‡‰è¿”å›é›¶å‘é‡
- **è‡ªæ¥”ç©**: outer_product(v, v) å°ä»»æ„ v æ‡‰è¿”å› 0
- **ä¸å¯é€†å¤šå‘é‡**: inverse() å° null vector æˆ–é›¶å‘é‡æ‡‰æ‹‹å‡ºéŒ¯èª¤æˆ–è¿”å› NaN
- **å–®ä½å…ƒé€†å…ƒ**: æ¨™é‡ 1 çš„é€†å…ƒæ‡‰ç‚º 1

## Requirements *(mandatory)*

### Functional Requirements

#### Motor Composition

- **FR-001**: ç³»çµ± MUST æä¾› `motor_compose(m1, m2)` å‡½å¼ï¼Œè¨ˆç®—å…©å€‹é¦¬é”çš„å¹¾ä½•ç©
- **FR-002**: è¼¸å…¥è¼¸å‡ºæ ¼å¼ MUST ç‚ºç¨€ç–é¦¬é”è¡¨ç¤º (motor_count åˆ†é‡)
- **FR-003**: å°æ–¼ nâ‰¤5ï¼Œç³»çµ± MUST ä½¿ç”¨ç¡¬ç·¨ç¢¼å±•é–‹å¯¦ä½œï¼ˆç„¡è¿´åœˆï¼‰
- **FR-004**: å°æ–¼ nâ‰¥6ï¼Œç³»çµ± MUST ä½¿ç”¨é‹è¡Œæ™‚ä¸€èˆ¬åŒ–ç®—æ³•

#### Geometric Inner Product

- **FR-005**: ç³»çµ± MUST æä¾› `inner_product(a, b)` å‡½å¼ï¼Œè¨ˆç®—å…©å€‹å¤šå‘é‡çš„æ¨™é‡å…§ç©
- **FR-006**: å…§ç©è¨ˆç®— MUST æ­£ç¢ºè™•ç† CGA åº¦è¦ç¬¦è™Ÿ (+,+,...,+,-)
- **FR-007**: å¯¦ä½œ MUST ä½¿ç”¨ç¬¦è™Ÿèåˆå„ªåŒ–ï¼ˆ`sum(a[i] * b[i] * sign[i])`ï¼‰è€Œéåˆ†æ­¥è¨ˆç®—
- **FR-008**: è¼¸å‡º MUST ç‚ºå½¢ç‹€ (..., 1) çš„æ¨™é‡å¼µé‡

#### Exponential Map

- **FR-009**: ç³»çµ± MUST æä¾› `exp_bivector(B)` å‡½å¼ï¼Œå¾ Bivector ç”Ÿæˆé¦¬é”
- **FR-010**: ç³»çµ± MUST è™•ç†æ•¸å€¼ç©©å®šæ€§ï¼Œå° Î¸â†’0 ä½¿ç”¨ sinc æˆ– Taylor å±•é–‹
- **FR-011**: è¼¸å…¥ MUST ç‚ºç¨€ç– Bivector è¡¨ç¤ºï¼ˆGrade 2 åˆ†é‡ï¼‰
- **FR-012**: è¼¸å‡º MUST ç‚ºç¨€ç–é¦¬é”è¡¨ç¤º

#### Outer Product (Wedge Product)

- **FR-013**: ç³»çµ± MUST æä¾› `outer_product(a, b)` å‡½å¼ï¼Œè¨ˆç®—å…©å€‹å¤šå‘é‡çš„å¤–ç©
- **FR-014**: å¤–ç©è¨ˆç®— MUST è¿”å›å¹¾ä½•ç©ä¸­ Grade |a|+|b| çš„åˆ†é‡
- **FR-015**: å°æ–¼ nâ‰¤5ï¼Œç³»çµ± MUST ä½¿ç”¨ç¡¬ç·¨ç¢¼å±•é–‹å¯¦ä½œ

#### Left/Right Contraction

- **FR-016**: ç³»çµ± MUST æä¾› `left_contraction(a, b)` å‡½å¼ï¼Œè¨ˆç®—å·¦ç¸®ä½µ
- **FR-017**: ç³»çµ± MUST æä¾› `right_contraction(a, b)` å‡½å¼ï¼Œè¨ˆç®—å³ç¸®ä½µ
- **FR-018**: ç¸®ä½µé‹ç®— MUST è¿”å›å¹¾ä½•ç©ä¸­ Grade ||b|-|a|| çš„åˆ†é‡

#### Grade Selection

- **FR-019**: ç³»çµ± MUST æä¾› `grade_select(mv, k)` å‡½å¼ï¼Œæå–ç‰¹å®š Grade åˆ†é‡
- **FR-020**: å°æ–¼ç„¡æ•ˆ Gradeï¼ˆk > max_grade æˆ– k < 0ï¼‰ï¼ŒMUST è¿”å›é›¶å‘é‡
- **FR-021**: è¼¸å‡º MUST ç‚ºå®Œæ•´å¤šå‘é‡æ ¼å¼ï¼ˆblade_count åˆ†é‡ï¼‰

#### Dual

- **FR-022**: ç³»çµ± MUST æä¾› `dual(mv)` å‡½å¼ï¼Œè¨ˆç®—å¤šå‘é‡çš„å°å¶
- **FR-023**: å°å¶è¨ˆç®— MUST ä½¿ç”¨ Pseudoscalarï¼š`dual(a) = a * I^(-1)`

#### Normalize

- **FR-024**: ç³»çµ± MUST æä¾› `normalize(mv)` å‡½å¼ï¼Œæ­£è¦åŒ–å¤šå‘é‡ç‚ºå–®ä½ç¯„æ•¸
- **FR-025**: å°æ–¼é›¶å‘é‡è¼¸å…¥ï¼ŒMUST è¿”å›é›¶å‘é‡ï¼ˆä¸æœƒç”¢ç”Ÿ NaNï¼‰
- **FR-026**: æ­£è¦åŒ– MUST ä½¿ç”¨å¹¾ä½•å…§ç©è¨ˆç®—ç¯„æ•¸

#### Operator Overloading

- **FR-027**: ç³»çµ± MUST æä¾› `Multivector` åŒ…è£é¡åˆ¥ï¼Œå°è£å¼µé‡èˆ‡ä»£æ•¸å¯¦ä¾‹
- **FR-028**: `Multivector` MUST å¯¦ä½œ `__mul__` é‹ç®—å­ï¼Œå°æ‡‰å¹¾ä½•ç© `a * b`
- **FR-029**: `Multivector` MUST å¯¦ä½œ `__xor__` é‹ç®—å­ï¼Œå°æ‡‰æ¥”ç© `a ^ b`
- **FR-030**: `Multivector` MUST å¯¦ä½œ `__or__` é‹ç®—å­ï¼Œå°æ‡‰å…§ç© `a | b`
- **FR-031**: `Multivector` MUST å¯¦ä½œ `__matmul__` é‹ç®—å­ï¼Œå°æ‡‰å·¦ç¸®ä½µ `a @ b`
- **FR-032**: `Multivector` MUST å¯¦ä½œ `__add__` å’Œ `__sub__` é‹ç®—å­ï¼Œå°æ‡‰åŠ æ¸›æ³•
- **FR-033**: `Multivector` MUST å¯¦ä½œ `__neg__` é‹ç®—å­ï¼Œå°æ‡‰å–è²  `-a`
- **FR-034**: `Multivector` MUST å¯¦ä½œ `__invert__` é‹ç®—å­ï¼Œå°æ‡‰åå‘ `~a`
- **FR-035**: `Multivector` MUST å¯¦ä½œ `__rmul__` é‹ç®—å­ï¼Œæ”¯æ´æ¨™é‡å·¦ä¹˜ `s * a`
- **FR-036**: `Multivector` MUST å¯¦ä½œ `__truediv__` é‹ç®—å­ï¼Œæ”¯æ´æ¨™é‡é™¤æ³• `a / s` å’Œå¤šå‘é‡é™¤æ³• `a / b`
- **FR-037**: `Multivector` MUST å¯¦ä½œ `inverse()` æ–¹æ³•ï¼Œè¨ˆç®—å¤šå‘é‡é€†å…ƒ `a^(-1) = ~a / (a * ~a)`
- **FR-038**: å¤šå‘é‡é™¤æ³• `a / b` MUST ç­‰åƒ¹æ–¼ `a * b.inverse()`
- **FR-039**: å°æ–¼ä¸å¯é€†å¤šå‘é‡ï¼ˆ`a * ~a == 0`ï¼‰ï¼Œ`inverse()` SHOULD æ‹‹å‡º `ValueError` æˆ–è¿”å› NaN
- **FR-040**: æ‰€æœ‰é‹ç®—å­ MUST æ”¯æ´ PyTorch autogradï¼ˆå¯å¾®åˆ†ï¼‰
- **FR-041**: æ‰€æœ‰é‹ç®—å­ MUST æ”¯æ´ä»»æ„ batch ç¶­åº¦

#### çµ±ä¸€ä»‹é¢

- **FR-042**: æ‰€æœ‰æ–°å‡½å¼ MUST åŠ å…¥ CGAAlgebraBase æŠ½è±¡é¡åˆ¥
- **FR-043**: HardcodedCGAWrapper MUST å° n=0-5 å§”æ´¾è‡³ç¡¬ç·¨ç¢¼å¯¦ä½œ
- **FR-044**: RuntimeCGAAlgebra MUST å° nâ‰¥6 æä¾›ä¸€èˆ¬åŒ–å¯¦ä½œ

#### ONNX ç›¸å®¹æ€§

- **FR-045**: æ‰€æœ‰ç¡¬ç·¨ç¢¼å¯¦ä½œ MUST å¯åŒ¯å‡ºç‚ºç„¡ Loop/If ç¯€é»çš„ ONNX æ¨¡å‹
- **FR-046**: é‹è¡Œæ™‚å¯¦ä½œ SHOULD ç›¡å¯èƒ½æ”¯æ´ ONNX åŒ¯å‡º

#### PyTorch æ•´åˆ

- **FR-047**: æ‰€æœ‰æ“ä½œ MUST æ”¯æ´ PyTorch autogradï¼ˆå¯å¾®åˆ†ï¼‰
- **FR-048**: æ‰€æœ‰æ“ä½œ MUST æ”¯æ´ä»»æ„ batch ç¶­åº¦

#### Layer çµ±ä¸€å‘½å

- **FR-049**: ç³»çµ± MUST æä¾›çµ±ä¸€çš„ `CGATransformLayer` é¡åˆ¥ï¼Œå–ä»£å„ç¶­åº¦çš„ `CGA{n}DCareLayer`
- **FR-050**: ç³»çµ± MUST æä¾›çµ±ä¸€çš„ `CGAEncoder` å’Œ `CGADecoder` é¡åˆ¥ï¼Œå–ä»£ `UPGC{n}DEncoder/Decoder`
- **FR-051**: ç³»çµ± MUST æä¾›çµ±ä¸€çš„ `CGAPipeline` é¡åˆ¥ï¼Œå–ä»£ `CGA{n}DTransformPipeline`
- **FR-052**: CGAAlgebraBase MUST æä¾› `get_transform_layer()` æ–¹æ³•ï¼Œå–ä»£ `get_care_layer()`
- **FR-053**: çµ±ä¸€å‘½å MUST é©ç”¨æ–¼æ‰€æœ‰ç¶­åº¦ï¼ˆåŒ…å«é‹è¡Œæ™‚ nâ‰¥6ï¼‰
- **FR-054**: èˆŠçš„ç¶­åº¦ç‰¹å®š Layer é¡åˆ¥ MUST ç§»é™¤ï¼ˆä¸å‘å¾Œç›¸å®¹ï¼‰

### Key Entities

- **Motor**: å¶æ•¸ Grade å¤šå‘é‡ (Grade 0 + Grade 2 + Grade 4 + ...)ï¼Œç”¨æ–¼è¡¨ç¤ºå‰›é«”è®Šæ›
- **Bivector**: Grade 2 å¤šå‘é‡ï¼Œç”¨æ–¼è¡¨ç¤ºæ—‹è½‰è»¸/å¹³é¢
- **Multivector**: åŒ…è£é¡åˆ¥ï¼Œå°è£å¼µé‡èˆ‡ä»£æ•¸å¯¦ä¾‹ï¼Œæä¾›é‹ç®—å­é‡è¼‰
- **Metric Signature**: CGA åº¦è¦ (+,+,...,+,-)ï¼Œå®šç¾©å…§ç©çš„ç¬¦è™Ÿè¦å‰‡
- **CGATransformLayer**: çµ±ä¸€çš„ PyTorch Layerï¼ŒåŸ·è¡Œ Motor sandwich product è®Šæ›
- **CGAEncoder**: çµ±ä¸€çš„ UPGC ç·¨ç¢¼å™¨ï¼Œå°‡æ­æ°åº§æ¨™è½‰æ›ç‚º CGA é»è¡¨ç¤º
- **CGADecoder**: çµ±ä¸€çš„ UPGC è§£ç¢¼å™¨ï¼Œå°‡ CGA é»è¡¨ç¤ºè½‰æ›å›æ­æ°åº§æ¨™
- **CGAPipeline**: çµ±ä¸€çš„è®Šæ›ç®¡ç·šï¼Œçµ„åˆ Encoder â†’ Transform â†’ Decoder

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: æ‰€æœ‰æ–°æ“ä½œå° n=0-5 çš„ç¡¬ç·¨ç¢¼å¯¦ä½œï¼Œæ•ˆèƒ½è‡³å°‘é”åˆ°å®Œæ•´å¹¾ä½•ç©çš„ 50%ï¼ˆå› ç‚ºåªè¨ˆç®—éƒ¨åˆ†åˆ†é‡ï¼‰
- **SC-002**: æ‰€æœ‰æ“ä½œå° clifford åº«çš„æ•¸å€¼èª¤å·®å°æ–¼ 1e-6ï¼ˆfloat32ï¼‰æˆ– 1e-10ï¼ˆfloat64ï¼‰
- **SC-003**: exp_bivector å°æ¥µå°è§’åº¦ï¼ˆÎ¸ < 1e-10ï¼‰æ•¸å€¼ç©©å®šï¼Œç„¡ NaN æˆ– Inf
- **SC-004**: normalize å°é›¶å‘é‡ä¸ç”¢ç”Ÿ NaNï¼Œè¿”å›é›¶å‘é‡
- **SC-005**: æ‰€æœ‰ç¡¬ç·¨ç¢¼å¯¦ä½œå¯åŒ¯å‡ºç‚º ONNX æ¨¡å‹ï¼Œä¸”ç„¡ Loop æˆ– If ç¯€é»
- **SC-006**: æ¸¬è©¦è¦†è“‹ç‡é”åˆ° 90% ä»¥ä¸Šï¼ŒåŒ…å«é‚Šç•Œæƒ…æ³å’Œæ•¸å€¼ç©©å®šæ€§æ¸¬è©¦
- **SC-007**: API ä½¿ç”¨æ–¹å¼èˆ‡ç¾æœ‰ sandwich_product_sparse ä¸€è‡´ï¼Œå­¸ç¿’æˆæœ¬ä½
- **SC-008**: çµ±ä¸€ Layer å‘½åå¾Œï¼Œæ‰€æœ‰ç¶­åº¦ä½¿ç”¨ç›¸åŒé¡åˆ¥åç¨±ï¼ˆCGATransformLayer ç­‰ï¼‰
- **SC-009**: èˆŠçš„ç¶­åº¦ç‰¹å®š Layer é¡åˆ¥å®Œå…¨ç§»é™¤
- **SC-010**: outer_product(v, v) å°ä»»æ„ v è¿”å› 0
- **SC-011**: é‹ç®—å­é‡è¼‰ `a * b` èˆ‡ `geometric_product(a, b)` æ•¸å€¼ç­‰åƒ¹
- **SC-012**: é‹ç®—å­é‡è¼‰ `a ^ b` èˆ‡ `outer_product(a, b)` æ•¸å€¼ç­‰åƒ¹
- **SC-013**: é‹ç®—å­é‡è¼‰ `a | b` èˆ‡ `inner_product(a, b)` æ•¸å€¼ç­‰åƒ¹
- **SC-014**: é‹ç®—å­ä½¿ç”¨ç¬¦åˆ Python æ…£ä¾‹ï¼ˆ`*` ä¹˜æ³•ã€`^` æ¥”ç©ã€`|` å…§ç©ã€`@` ç¸®ä½µã€`/` é™¤æ³•ï¼‰
- **SC-015**: `a * a.inverse()` å°å¯é€†å¤šå‘é‡è¿”å›è¿‘ä¼¼æ¨™é‡ 1
- **SC-016**: `a / b` ç­‰åƒ¹æ–¼ `a * b.inverse()`

## Assumptions

- ä½¿ç”¨è€…å·²å®‰è£ PyTorch 2.0+ å’Œ clifford åº«ï¼ˆç”¨æ–¼æ¸¬è©¦å°ç…§ï¼‰
- ç¡¬ç·¨ç¢¼å¯¦ä½œç”± codegen ç³»çµ±è‡ªå‹•ç”Ÿæˆ
- é‹è¡Œæ™‚å¯¦ä½œä½¿ç”¨ scatter_add/gather å¼µé‡æ“ä½œ
- åº¦è¦ç¬¦è™Ÿé å…ˆè¨ˆç®—ä¸¦å„²å­˜ç‚ºå¸¸æ•¸

## Background: ç¾æœ‰ CGA é‹ç®—

### å·²å¯¦ä½œçš„é‹ç®—

æœ¬åŠŸèƒ½å»ºç«‹åœ¨ç¾æœ‰ CGA é‹ç®—åŸºç¤ä¸Šã€‚ä»¥ä¸‹é‹ç®—å·²åœ¨æ‰€æœ‰ç¶­åº¦ (CGA0D-CGA5D + é‹è¡Œæ™‚ 6D+) å¯¦ä½œï¼š

| é‹ç®— | å‡½å¼åç¨± | èªªæ˜ |
|------|----------|------|
| å¹¾ä½•ç© | `geometric_product_full(a, b)` | å®Œæ•´å¤šå‘é‡å¹¾ä½•ç©ï¼Œè¼¸å…¥è¼¸å‡ºçš†ç‚º blade_count åˆ†é‡ |
| åå‘ | `reverse_full(mv)` | å¤šå‘é‡åå‘æ“ä½œï¼ŒGrade k ä¹˜ä»¥ (-1)^(k(k-1)/2) |
| é¦¬é”åå‘ | `reverse_motor(motor)` | é¦¬é”å°ˆç”¨åå‘ï¼Œç¨€ç–è¡¨ç¤º |
| ä¸‰æ˜æ²»ç© | `sandwich_product_sparse(motor, point)` | M Ã— X Ã— M~ è®Šæ›ï¼Œç”¨æ–¼é»çš„å‰›é«”è®Šæ› |
| UPGC ç·¨ç¢¼ | `upgc_encode(x)` | æ­æ°åº§æ¨™ â†’ CGA é»è¡¨ç¤º |
| UPGC è§£ç¢¼ | `upgc_decode(point)` | CGA é»è¡¨ç¤º â†’ æ­æ°åº§æ¨™ |

### å°šæœªå¯¦ä½œçš„é‹ç®—

ä»¥ä¸‹åŸºç¤ Clifford ä»£æ•¸é‹ç®—å°šæœªç¨ç«‹å¯¦ä½œï¼ˆæœ¬åŠŸèƒ½å°‡æ–°å¢å‰ä¸‰é …ï¼‰ï¼š

| é‹ç®— | ç‹€æ…‹ | èªªæ˜ |
|------|------|------|
| é¦¬é”çµ„åˆ | ğŸ”¨ æœ¬åŠŸèƒ½ | `motor_compose(m1, m2)` - Motor Ã— Motor |
| å¹¾ä½•å…§ç© | ğŸ”¨ æœ¬åŠŸèƒ½ | `inner_product(a, b)` - åº¦è¦å…§ç© (Grade 0) |
| æŒ‡æ•¸æ˜ å°„ | ğŸ”¨ æœ¬åŠŸèƒ½ | `exp_bivector(B)` - Bivector â†’ Motor |
| æ¥”ç© | ğŸ”¨ æœ¬åŠŸèƒ½ | `outer_product(a, b)` - a âˆ§ b - Outer Product |
| å·¦ç¸®ä½µ | ğŸ”¨ æœ¬åŠŸèƒ½ | `left_contraction(a, b)` - a âŒ‹ b - Left Contraction |
| å³ç¸®ä½µ | ğŸ”¨ æœ¬åŠŸèƒ½ | `right_contraction(a, b)` - a âŒŠ b - Right Contraction |
| Grade æå– | ğŸ”¨ æœ¬åŠŸèƒ½ | `grade_select(mv, k)` - âŸ¨aâŸ©_k - æå–ç‰¹å®š Grade åˆ†é‡ |
| å°å¶ | ğŸ”¨ æœ¬åŠŸèƒ½ | `dual(mv)` - a* - Dual |
| æ­£è¦åŒ– | ğŸ”¨ æœ¬åŠŸèƒ½ | `normalize(mv)` - a / |a| - Normalize |

**æ³¨æ„**ï¼šåŠ æ³•/æ¸›æ³•ç›´æ¥ä½¿ç”¨ PyTorch å¼µé‡é‹ç®— (`+`/`-`) å³å¯ï¼Œç„¡éœ€é¡å¤–å¯¦ä½œã€‚

### é‹ç®—é—œä¿‚

```
æ¥”ç©:     a âˆ§ b = âŸ¨abâŸ©_{|a|+|b|}     (Grade æå‡)
å·¦ç¸®ä½µ:   a âŒ‹ b = âŸ¨abâŸ©_{|b|-|a|}     (Grade é™ä½)
å¹¾ä½•å…§ç©: a Â· b = âŸ¨abâŸ©_0             (æœ¬åŠŸèƒ½å¯¦ä½œ)
å¹¾ä½•ç©:   ab = a âˆ§ b + a âŒ‹ b + ...   (å·²å¯¦ä½œ)
```
